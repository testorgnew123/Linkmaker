<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Profile Platform ‚Äî Editor</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
/* ===================== IMPERSONATION BANNER ===================== */
#impersonation-banner {
  display: none;
  position: fixed; top: 0; left: 0; right: 0; z-index: 10000;
  background: #7f1d1d; border-bottom: 1px solid rgba(255,107,107,0.4);
  padding: 9px 20px; font-size: 13px; font-weight: 500;
  color: #fca5a5; font-family: 'Outfit', sans-serif;
  align-items: center; justify-content: center; gap: 12px;
}
#impersonation-banner.active { display: flex; }
#impersonation-banner strong { color: #fef2f2; font-weight: 700; }
#impersonation-banner button {
  background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3);
  color: #fef2f2; border-radius: 6px; padding: 3px 10px;
  font-size: 12px; font-weight: 600; cursor: pointer;
  font-family: 'Outfit', sans-serif; transition: background 0.2s;
}
#impersonation-banner button:hover { background: rgba(255,255,255,0.25); }
body.impersonating .app-shell { margin-top: 38px; }

/* ===================== RESET & BASE ===================== */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
html { scroll-behavior: smooth; }

:root {
  --bg: #080c14;
  --surface: #0f1624;
  --surface2: #161e30;
  --surface3: #1c2640;
  --border: rgba(255,255,255,0.07);
  --border2: rgba(255,255,255,0.12);
  --accent: #6c63ff;
  --accent2: #ff6b6b;
  --accent3: #43e97b;
  --gold: #f7c948;
  --text: #e8eaf2;
  --text2: #8892a4;
  --text3: #4e5a6e;
  --white: #ffffff;
  --radius: 18px;
  --radius-sm: 10px;
  --shadow: 0 8px 40px rgba(0,0,0,0.4);
  --shadow-lg: 0 20px 80px rgba(0,0,0,0.6);
  --glow: 0 0 40px rgba(108,99,255,0.25);
  --transition: all 0.3s cubic-bezier(0.4,0,0.2,1);
}

body {
  font-family: 'Outfit', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}

/* ===================== SPLIT LAYOUT ===================== */
.app-shell {
  display: flex;
  min-height: 100vh;
}

/* ===================== EDITOR PANEL (LEFT) ===================== */
.editor-panel {
  width: 380px;
  min-width: 380px;
  background: var(--surface);
  border-right: 1px solid var(--border);
  height: 100vh;
  overflow-y: auto;
  overflow-x: hidden;
  display: flex;
  flex-direction: column;
  position: sticky;
  top: 0;
  scrollbar-width: thin;
  scrollbar-color: var(--surface3) transparent;
}
.editor-panel::-webkit-scrollbar { width: 4px; }
.editor-panel::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 4px; }

.editor-header {
  padding: 24px 24px 20px;
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  background: var(--surface);
  z-index: 10;
}
.editor-header-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}
.editor-logo {
  display: flex; align-items: center; gap: 10px;
}
.editor-logo-mark {
  width: 34px; height: 34px; border-radius: 10px;
  background: linear-gradient(135deg, var(--accent), #9c8fff);
  display: flex; align-items: center; justify-content: center;
}
.editor-logo-mark svg { width: 18px; height: 18px; }
.editor-logo-text {
  font-family: 'Syne', sans-serif;
  font-weight: 700; font-size: 16px;
  color: var(--white);
  letter-spacing: -0.3px;
}
.editor-logo-text span { color: var(--accent); }

.header-actions { display: flex; gap: 8px; align-items: center; }

.save-btn, .view-live-btn {
  display: flex; align-items: center; gap: 6px;
  border: none;
  border-radius: 10px;
  padding: 8px 16px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  font-family: 'Outfit', sans-serif;
  transition: var(--transition);
  text-decoration: none;
}
.save-btn {
  background: var(--accent);
  color: white;
  box-shadow: 0 4px 16px rgba(108,99,255,0.4);
}
.save-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 24px rgba(108,99,255,0.5); background: #7c74ff; }
.save-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

.view-live-btn {
  background: var(--surface2);
  color: var(--text);
  border: 1px solid var(--border2);
}
.view-live-btn:hover { background: var(--surface3); border-color: var(--accent); color: var(--white); }

/* Editor Tabs */
.editor-tabs {
  display: flex; gap: 4px;
  background: var(--surface2);
  border-radius: 10px;
  padding: 3px;
}
.editor-tab {
  flex: 1; text-align: center;
  padding: 7px 4px;
  border-radius: 8px;
  font-size: 12px; font-weight: 500;
  color: var(--text2);
  cursor: pointer;
  transition: var(--transition);
  border: none; background: transparent;
  font-family: 'Outfit', sans-serif;
}
.editor-tab.active {
  background: var(--surface3);
  color: var(--white);
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

/* Editor Body */
.editor-body { padding: 20px 24px; flex: 1; }
.editor-section { margin-bottom: 28px; }
.editor-section-title {
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--text3);
  margin-bottom: 12px;
}

/* Form Controls */
.field { margin-bottom: 14px; }
.field label {
  display: block;
  font-size: 12px; font-weight: 500; color: var(--text2);
  margin-bottom: 6px;
}
.field input, .field textarea, .field select {
  width: 100%;
  background: var(--surface2);
  border: 1px solid var(--border2);
  border-radius: var(--radius-sm);
  padding: 10px 12px;
  color: var(--text);
  font-size: 13px;
  font-family: 'Outfit', sans-serif;
  transition: var(--transition);
  outline: none;
}
.field input:focus, .field textarea:focus, .field select:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(108,99,255,0.15);
}
.field textarea { resize: vertical; min-height: 70px; }
.field select { cursor: pointer; }
.field .field-hint { font-size: 11px; color: var(--text3); margin-top: 4px; }
.field input[readonly] { opacity: 0.6; cursor: not-allowed; }

/* Logo upload */
.logo-upload-area {
  display: flex; align-items: center; gap: 12px;
  margin-top: 8px;
}
.logo-preview {
  width: 48px; height: 48px; border-radius: 12px;
  background: var(--surface2); border: 1px solid var(--border2);
  display: flex; align-items: center; justify-content: center;
  overflow: hidden; flex-shrink: 0;
}
.logo-preview img { width: 100%; height: 100%; object-fit: cover; }
.logo-upload-btn {
  background: var(--surface2); border: 1px solid var(--border2);
  color: var(--text2); border-radius: 8px; padding: 6px 14px;
  font-size: 12px; font-weight: 500; cursor: pointer;
  font-family: 'Outfit', sans-serif; transition: var(--transition);
}
.logo-upload-btn:hover { border-color: var(--accent); color: var(--accent); }

/* Color Theme Picker */
.theme-grid {
  display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;
}
.theme-swatch {
  aspect-ratio: 1;
  border-radius: 10px;
  cursor: pointer;
  border: 2px solid transparent;
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}
.theme-swatch.active { border-color: var(--white); }
.theme-swatch:hover { transform: scale(1.08); }
.theme-swatch span {
  position: absolute; bottom: 4px; left: 0; right: 0;
  text-align: center; font-size: 9px; color: rgba(255,255,255,0.8);
  font-weight: 600;
}

/* Social Editor */
.social-list { display: flex; flex-direction: column; gap: 8px; }
.social-item {
  display: flex; align-items: center; gap: 10px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 8px 10px;
  transition: var(--transition);
}
.social-item:hover { border-color: var(--border2); }
.social-item-icon {
  width: 32px; height: 32px; border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}
.social-item input {
  flex: 1; background: transparent; border: none !important;
  box-shadow: none !important; padding: 2px 0 !important;
  font-size: 12px;
}
.social-toggle {
  width: 34px; height: 20px; border-radius: 10px;
  background: var(--surface3); cursor: pointer;
  border: none; position: relative; flex-shrink: 0;
  transition: var(--transition);
}
.social-toggle.on { background: var(--accent); }
.social-toggle::after {
  content: '';
  position: absolute; top: 2px; left: 2px;
  width: 16px; height: 16px; border-radius: 50%;
  background: white; transition: var(--transition);
}
.social-toggle.on::after { left: 16px; }

/* Card Editor */
.cards-list { display: flex; flex-direction: column; gap: 10px; }
.card-editor-item {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
  transition: var(--transition);
}
.card-editor-item:hover { border-color: var(--border2); }
.card-editor-header {
  display: flex; align-items: center; gap: 10px;
  padding: 12px 14px;
  cursor: pointer;
}
.card-editor-drag { color: var(--text3); cursor: grab; }
.card-editor-type-badge {
  font-size: 10px; font-weight: 700; letter-spacing: 1px;
  text-transform: uppercase;
  padding: 3px 8px; border-radius: 6px;
}
.card-editor-name { flex: 1; font-size: 13px; font-weight: 500; color: var(--text); }
.card-editor-toggle { color: var(--text2); transition: var(--transition); }
.card-editor-toggle.open { transform: rotate(180deg); }
.card-editor-body { padding: 0 14px 14px; display: none; }
.card-editor-body.open { display: block; }
.card-editor-body .field { margin-bottom: 10px; }
.card-editor-body .field label { font-size: 11px; }
.card-editor-body .field input { padding: 8px 10px; font-size: 12px; }

.add-card-btn {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  width: 100%;
  background: transparent;
  border: 1.5px dashed var(--border2);
  border-radius: 12px;
  padding: 12px;
  color: var(--text2);
  font-size: 13px; font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
  font-family: 'Outfit', sans-serif;
  margin-top: 10px;
}
.add-card-btn:hover:not(:disabled) { border-color: var(--accent); color: var(--accent); background: rgba(108,99,255,0.05); }
.add-card-btn:disabled { opacity: 0.45; cursor: not-allowed; }

/* Card counter */
.card-counter-row {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 10px;
}
.card-counter {
  font-size: 12px; font-weight: 600;
  padding: 3px 10px; border-radius: 20px;
  border: 1px solid var(--border);
  background: var(--surface2);
  color: var(--text3);
  transition: var(--transition);
}
.card-counter.ok   { color: var(--accent3); border-color: rgba(67,233,123,0.25); background: rgba(67,233,123,0.08); }
.card-counter.warn { color: var(--gold);    border-color: rgba(247,201,72,0.25); background: rgba(247,201,72,0.08); }
.card-counter.full { color: var(--accent2); border-color: rgba(255,107,107,0.25); background: rgba(255,107,107,0.08); }

/* Card Type Menu */
.card-type-menu {
  background: var(--surface3);
  border: 1px solid var(--border2);
  border-radius: 12px;
  padding: 10px;
  display: none;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-top: 8px;
}
.card-type-menu.open { display: grid; }
.card-type-option {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 12px;
  border-radius: 8px;
  cursor: pointer;
  transition: var(--transition);
  border: 1px solid transparent;
}
.card-type-option:hover { background: var(--surface); border-color: var(--accent); }
.card-type-option-icon {
  width: 28px; height: 28px; border-radius: 7px;
  display: flex; align-items: center; justify-content: center;
  font-size: 14px;
}
.card-type-option-label { font-size: 12px; font-weight: 500; color: var(--text); }
.card-type-option-desc { font-size: 10px; color: var(--text3); }

/* ===================== PREVIEW PANEL (RIGHT) ===================== */
.preview-panel {
  flex: 1;
  background: var(--bg);
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 0 20px 60px;
  position: relative;
  overflow-y: auto;
}

/* Animated BG */
.preview-bg {
  position: fixed;
  top: 0; left: 380px; right: 0; bottom: 0;
  z-index: 0;
  overflow: hidden;
  pointer-events: none;
}
.preview-bg-orb {
  position: absolute;
  border-radius: 50%;
  filter: blur(80px);
  opacity: 0.12;
  animation: orbFloat 8s ease-in-out infinite;
}
.orb1 { width: 500px; height: 500px; background: var(--accent); top: -100px; right: -100px; animation-delay: 0s; }
.orb2 { width: 400px; height: 400px; background: #ff6b6b; bottom: -100px; left: -100px; animation-delay: 3s; }
.orb3 { width: 300px; height: 300px; background: #43e97b; top: 40%; left: 30%; animation-delay: 6s; }

@keyframes orbFloat {
  0%, 100% { transform: translate(0,0) scale(1); }
  50% { transform: translate(30px, -30px) scale(1.05); }
}

.preview-topbar {
  width: 100%;
  max-width: 800px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px 0 24px;
  position: relative; z-index: 1;
}
.preview-label {
  display: flex; align-items: center; gap: 8px;
  font-size: 12px; font-weight: 600;
  color: var(--text3);
  letter-spacing: 1px;
  text-transform: uppercase;
}
.preview-label::before {
  content: '';
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--accent3);
  box-shadow: 0 0 6px var(--accent3);
  animation: pulse 2s infinite;
}
@keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.6;transform:scale(1.3)} }

.device-toggle {
  display: flex; gap: 4px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 4px;
}
.device-btn {
  padding: 6px 12px;
  border-radius: 7px;
  border: none;
  background: transparent;
  color: var(--text2);
  font-size: 12px; font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
  font-family: 'Outfit', sans-serif;
  display: flex; align-items: center; gap: 5px;
}
.device-btn.active { background: var(--surface2); color: var(--white); }

/* Phone frame */
.phone-frame-wrap {
  position: relative; z-index: 1;
  display: flex; flex-direction: column; align-items: center;
}
.phone-frame {
  width: 390px;
  background: #111827;
  border-radius: 50px;
  padding: 14px 12px;
  box-shadow: 0 0 0 1px #1f2937, 0 0 0 3px #0d1117, var(--shadow-lg), 0 0 80px rgba(108,99,255,0.1);
  position: relative;
  transition: var(--transition);
}
.phone-frame.desktop-view {
  width: 100%;
  max-width: 900px;
  border-radius: 16px;
  padding: 0;
  background: none;
  box-shadow: none;
}
.phone-notch {
  width: 120px; height: 28px; background: #0d1117;
  border-radius: 20px;
  margin: 0 auto 14px;
  display: flex; align-items: center; justify-content: center; gap: 6px;
  transition: var(--transition);
}
.desktop-view .phone-notch { display: none; }
.notch-cam { width: 10px; height: 10px; background: #1f2937; border-radius: 50%; }
.notch-pill { width: 30px; height: 6px; background: #1f2937; border-radius: 3px; }

.phone-screen {
  background: var(--screen-bg, #080c14);
  border-radius: 38px;
  overflow: hidden;
  height: 760px;
  overflow-y: auto;
  scrollbar-width: none;
  transition: background 0.4s ease;
}
.phone-screen::-webkit-scrollbar { display: none; }
.desktop-view .phone-screen {
  border-radius: 10px;
  height: auto;
  max-height: 85vh;
  overflow-y: auto;
}

/* ===================== PROFILE PAGE RENDERED ===================== */
.profile-page {
  min-height: 100%;
  position: relative;
  padding-bottom: 40px;
}

/* Animated hero gradient */
.profile-hero {
  position: relative;
  padding: 52px 24px 36px;
  text-align: center;
  overflow: hidden;
}
.profile-hero-bg {
  position: absolute; inset: 0; z-index: 0;
  background: var(--hero-bg, linear-gradient(160deg, #0f1020 0%, #0d1520 100%));
  transition: background 0.5s ease;
}
.profile-hero-mesh {
  position: absolute; inset: 0; z-index: 0;
  opacity: 0.5;
  background-image:
    radial-gradient(ellipse 70% 50% at 50% -10%, var(--hero-glow, rgba(108,99,255,0.35)) 0%, transparent 70%),
    radial-gradient(ellipse 40% 40% at 80% 80%, var(--hero-glow2, rgba(108,99,255,0.2)) 0%, transparent 60%);
}
.profile-hero > * { position: relative; z-index: 1; }

.avatar-ring {
  display: inline-flex; position: relative;
  margin-bottom: 20px;
}
.avatar-ring::before {
  content: '';
  position: absolute; inset: -3px;
  border-radius: 50%;
  background: conic-gradient(var(--accent-color, var(--accent)), var(--accent-color2, #ff6b6b), var(--accent-color, var(--accent)));
  animation: spin 6s linear infinite;
  z-index: 0;
}
@keyframes spin { to { transform: rotate(360deg); } }

.avatar-wrap {
  width: 88px; height: 88px;
  border-radius: 50%;
  background: var(--surface2);
  display: flex; align-items: center; justify-content: center;
  position: relative; z-index: 1;
  overflow: hidden;
  font-family: 'Syne', sans-serif;
  font-size: 32px;
  font-weight: 800;
  color: var(--accent-color, var(--accent));
  border: 3px solid var(--bg);
}
.avatar-img { width: 100%; height: 100%; object-fit: cover; }

.profile-name {
  font-family: 'Syne', sans-serif;
  font-size: 26px; font-weight: 800;
  color: var(--white);
  letter-spacing: -0.5px;
  margin-bottom: 4px;
  line-height: 1.2;
}
.profile-tagline {
  font-size: 13px; font-weight: 400;
  color: rgba(255,255,255,0.55);
  letter-spacing: 0.5px;
  margin-bottom: 14px;
}
.profile-bio {
  font-size: 13px; color: rgba(255,255,255,0.45);
  line-height: 1.65; max-width: 280px;
  margin: 0 auto 20px;
}

/* Verified badge */
.verified-badge {
  display: inline-flex; align-items: center; gap: 5px;
  background: rgba(255,255,255,0.07);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 20px;
  padding: 4px 10px;
  font-size: 11px; color: rgba(255,255,255,0.5);
  margin-bottom: 20px;
  backdrop-filter: blur(8px);
}
.verified-badge svg { color: var(--accent-color, var(--accent)); }

/* Social Icons Strip */
.social-strip {
  display: flex; flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
  padding: 0 24px;
  margin-bottom: 32px;
}
.social-pill {
  display: flex; align-items: center; gap: 7px;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.09);
  border-radius: 50px;
  padding: 8px 14px;
  cursor: pointer;
  text-decoration: none;
  transition: var(--transition);
  animation: fadeSlideUp 0.5s ease both;
  backdrop-filter: blur(8px);
}
.social-pill:hover {
  background: rgba(255,255,255,0.12);
  border-color: rgba(255,255,255,0.2);
  transform: translateY(-2px);
}
.social-pill-icon { width: 18px; height: 18px; flex-shrink: 0; }
.social-pill-label { font-size: 12px; font-weight: 500; color: rgba(255,255,255,0.7); }

/* Cards Container */
.cards-container {
  padding: 0 16px;
  display: flex; flex-direction: column; gap: 12px;
}

/* ===== CARD STYLES ===== */
.qr-card {
  border-radius: var(--radius);
  overflow: hidden;
  border: 1px solid rgba(255,255,255,0.07);
  position: relative;
  animation: fadeSlideUp 0.5s ease both;
  transition: var(--transition);
}
.qr-card:hover {
  border-color: rgba(255,255,255,0.14);
  transform: translateY(-2px);
  box-shadow: 0 12px 40px rgba(0,0,0,0.4);
}

/* Link card */
.card-link {
  display: flex; align-items: center; gap: 14px;
  padding: 16px 18px;
  text-decoration: none;
  background: rgba(255,255,255,0.04);
  backdrop-filter: blur(12px);
}
.card-link-icon {
  width: 44px; height: 44px; border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; font-size: 20px;
}
.card-link-content { flex: 1; min-width: 0; }
.card-link-title { font-size: 15px; font-weight: 600; color: var(--white); margin-bottom: 2px; }
.card-link-sub { font-size: 12px; color: var(--text2); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.card-link-arrow { color: var(--text3); flex-shrink: 0; transition: var(--transition); }
.card-link:hover .card-link-arrow { transform: translateX(4px); color: var(--accent-color, var(--accent)); }

/* Expandable card */
.card-expand-btn {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 18px;
  cursor: pointer;
  background: rgba(255,255,255,0.04);
  backdrop-filter: blur(12px);
  border: none; width: 100%; text-align: left;
  transition: var(--transition);
  gap: 14px;
}
.card-expand-btn:hover { background: rgba(255,255,255,0.07); }
.card-expand-btn .card-link-icon { font-size: 20px; }
.card-expand-label { flex: 1; }
.card-expand-title { font-size: 15px; font-weight: 600; color: var(--white); margin-bottom: 2px; }
.card-expand-sub { font-size: 12px; color: var(--text2); }
.card-expand-chevron { color: var(--text3); transition: var(--transition); flex-shrink: 0; }
.card-expand-btn.expanded .card-expand-chevron { transform: rotate(180deg); color: var(--accent-color, var(--accent)); }

.card-embed-area {
  display: none;
  border-top: 1px solid rgba(255,255,255,0.06);
}
.card-embed-area.open { display: block; }
.card-embed-area iframe {
  width: 100%; display: block; border: none;
}
.card-embed-inner { padding: 14px 18px; }

/* Map card */
.map-embed-frame { height: 200px; filter: grayscale(0.3) contrast(1.05); }

/* Website preview */
.website-preview-bar {
  display: flex; align-items: center; gap: 8px;
  padding: 8px 14px;
  background: rgba(255,255,255,0.03);
  border-top: 1px solid rgba(255,255,255,0.06);
}
.browser-dots2 { display: flex; gap: 4px; }
.browser-dot2 { width: 7px; height: 7px; border-radius: 50%; }
.url-bar {
  flex: 1; background: rgba(255,255,255,0.06);
  border-radius: 6px; padding: 3px 10px;
  font-size: 10px; color: var(--text3); font-family: monospace;
}
.website-preview-img {
  width: 100%; height: 180px;
  object-fit: cover; object-position: top;
  display: block;
}
.website-preview-placeholder {
  width: 100%; height: 180px;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center; gap: 6px;
  background: linear-gradient(135deg, rgba(108,99,255,0.15), rgba(255,107,107,0.1));
  font-family: 'Syne', sans-serif;
}
.website-preview-placeholder .site-name { font-size: 18px; font-weight: 700; color: rgba(255,255,255,0.6); }
.website-preview-placeholder .site-url { font-size: 11px; color: rgba(255,255,255,0.3); font-family: monospace; }

/* Google Business */
.gbiz-inner { padding: 18px 18px 6px; background: rgba(255,255,255,0.04); }
.gbiz-brand-row { display: flex; align-items: center; gap: 12px; margin-bottom: 14px; }
.gbiz-g-icon {
  width: 40px; height: 40px; border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  background: #fff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  flex-shrink: 0;
}
.gbiz-g-icon svg { width: 24px; height: 24px; }
.gbiz-biz-name { font-size: 15px; font-weight: 700; color: var(--white); }
.gbiz-biz-cat { font-size: 11px; color: var(--text2); }
.stars2 { display: flex; gap: 2px; margin-bottom: 4px; }
.star2 { color: #f5c518; font-size: 14px; }
.gbiz-stats-row { display: flex; gap: 16px; margin-bottom: 14px; }
.gbiz-stat { text-align: center; }
.gbiz-stat-val { font-size: 18px; font-weight: 700; color: var(--white); }
.gbiz-stat-label { font-size: 10px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.5px; }
.gbiz-divider { width: 1px; background: var(--border); }
.gbiz-actions { display: flex; gap: 8px; padding: 12px 18px; border-top: 1px solid rgba(255,255,255,0.06); background: rgba(255,255,255,0.02); }
.gbiz-action-btn {
  flex: 1; padding: 9px;
  border-radius: 10px; border: none; cursor: pointer;
  font-size: 12px; font-weight: 600;
  font-family: 'Outfit', sans-serif;
  transition: var(--transition);
}
.gbiz-action-primary { background: var(--accent-color, var(--accent)); color: white; }
.gbiz-action-secondary { background: rgba(255,255,255,0.07); color: var(--text); }
.gbiz-action-btn:hover { opacity: 0.85; transform: translateY(-1px); }

/* CTA Card */
.cta-card {
  padding: 20px 18px;
  background: linear-gradient(135deg, var(--cta-from, rgba(108,99,255,0.2)), var(--cta-to, rgba(255,107,107,0.15)));
  position: relative; overflow: hidden;
  backdrop-filter: blur(12px);
}
.cta-card::before {
  content: '';
  position: absolute; inset: 0;
  background: var(--cta-shine, radial-gradient(ellipse 80% 60% at 0% 0%, rgba(255,255,255,0.05) 0%, transparent 60%));
}
.cta-card > * { position: relative; z-index: 1; }
.cta-badge {
  display: inline-flex; align-items: center; gap: 5px;
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.15);
  border-radius: 20px;
  padding: 4px 10px;
  font-size: 10px; font-weight: 700;
  color: rgba(255,255,255,0.8);
  letter-spacing: 1px; text-transform: uppercase;
  margin-bottom: 10px;
}
.cta-title { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 700; color: var(--white); margin-bottom: 6px; line-height: 1.2; }
.cta-desc { font-size: 12px; color: rgba(255,255,255,0.55); line-height: 1.6; margin-bottom: 16px; }
.cta-action {
  display: inline-flex; align-items: center; gap: 8px;
  background: var(--white);
  color: var(--bg);
  border-radius: 10px;
  padding: 10px 18px;
  font-size: 13px; font-weight: 700;
  text-decoration: none;
  transition: var(--transition);
  border: none; cursor: pointer; font-family: 'Outfit', sans-serif;
}
.cta-action:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }

/* Footer */
.profile-footer {
  text-align: center;
  padding: 32px 24px 20px;
  position: relative; z-index: 1;
}
.powered-by {
  display: inline-flex; align-items: center; gap: 6px;
  font-size: 11px; color: var(--text3);
  text-decoration: none;
  transition: var(--transition);
}
.powered-by:hover { color: var(--text2); }
.powered-by-logo { font-family: 'Syne', sans-serif; font-weight: 700; }
.powered-by-logo span { color: var(--accent); }

@keyframes fadeSlideUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ===================== THEMES ===================== */
.theme-midnight { --screen-bg:#080c14; --hero-bg:linear-gradient(160deg,#0f1020,#0d1520); --hero-glow:rgba(108,99,255,0.35); --hero-glow2:rgba(108,99,255,0.2); --accent-color:#6c63ff; --accent-color2:#ff6b6b; --cta-from:rgba(108,99,255,0.2); --cta-to:rgba(255,107,107,0.15); }
.theme-emerald { --screen-bg:#050d0a; --hero-bg:linear-gradient(160deg,#051209,#061510); --hero-glow:rgba(16,185,129,0.4); --hero-glow2:rgba(67,233,123,0.2); --accent-color:#10b981; --accent-color2:#43e97b; --cta-from:rgba(16,185,129,0.2); --cta-to:rgba(67,233,123,0.1); }
.theme-crimson { --screen-bg:#0d0507; --hero-bg:linear-gradient(160deg,#150508,#1a0808); --hero-glow:rgba(239,68,68,0.4); --hero-glow2:rgba(251,113,133,0.2); --accent-color:#ef4444; --accent-color2:#fb7185; --cta-from:rgba(239,68,68,0.2); --cta-to:rgba(251,113,133,0.1); }
.theme-gold { --screen-bg:#0a0800; --hero-bg:linear-gradient(160deg,#120f00,#160e00); --hero-glow:rgba(245,158,11,0.4); --hero-glow2:rgba(251,191,36,0.2); --accent-color:#f59e0b; --accent-color2:#fbbf24; --cta-from:rgba(245,158,11,0.2); --cta-to:rgba(251,191,36,0.1); }
.theme-ocean { --screen-bg:#020b12; --hero-bg:linear-gradient(160deg,#020e18,#011520); --hero-glow:rgba(14,165,233,0.4); --hero-glow2:rgba(56,189,248,0.2); --accent-color:#0ea5e9; --accent-color2:#38bdf8; --cta-from:rgba(14,165,233,0.2); --cta-to:rgba(56,189,248,0.1); }
.theme-rose { --screen-bg:#0d0408; --hero-bg:linear-gradient(160deg,#150610,#180814); --hero-glow:rgba(236,72,153,0.4); --hero-glow2:rgba(251,113,133,0.2); --accent-color:#ec4899; --accent-color2:#f43f5e; --cta-from:rgba(236,72,153,0.2); --cta-to:rgba(244,63,94,0.1); }
.theme-slate { --screen-bg:#0a0d12; --hero-bg:linear-gradient(160deg,#0d1018,#111420); --hero-glow:rgba(148,163,184,0.3); --hero-glow2:rgba(203,213,225,0.15); --accent-color:#94a3b8; --accent-color2:#cbd5e1; --cta-from:rgba(148,163,184,0.15); --cta-to:rgba(203,213,225,0.08); }
.theme-amber { --screen-bg:#080600; --hero-bg:linear-gradient(160deg,#0d0900,#100b00); --hero-glow:rgba(217,119,6,0.4); --hero-glow2:rgba(245,158,11,0.2); --accent-color:#d97706; --accent-color2:#f59e0b; --cta-from:rgba(217,119,6,0.2); --cta-to:rgba(245,158,11,0.1); }
.theme-violet { --screen-bg:#06040e; --hero-bg:linear-gradient(160deg,#0a0614,#0d0818); --hero-glow:rgba(167,139,250,0.4); --hero-glow2:rgba(192,132,252,0.2); --accent-color:#a78bfa; --accent-color2:#c084fc; --cta-from:rgba(167,139,250,0.2); --cta-to:rgba(192,132,252,0.1); }
.theme-cyan { --screen-bg:#010c0e; --hero-bg:linear-gradient(160deg,#011018,#01141c); --hero-glow:rgba(6,182,212,0.4); --hero-glow2:rgba(34,211,238,0.2); --accent-color:#06b6d4; --accent-color2:#22d3ee; --cta-from:rgba(6,182,212,0.2); --cta-to:rgba(34,211,238,0.1); }

/* ===================== RESPONSIVE ===================== */
@media(max-width: 900px) {
  .editor-panel { position: fixed; left: -380px; z-index: 100; transition: var(--transition); }
  .editor-panel.mobile-open { left: 0; }
  .preview-panel { width: 100%; }
  .preview-bg { left: 0; }
  .mobile-edit-fab {
    display: flex !important;
  }
}
.mobile-edit-fab {
  display: none;
  position: fixed; bottom: 24px; right: 24px;
  width: 52px; height: 52px; border-radius: 50%;
  background: var(--accent);
  color: white; border: none;
  align-items: center; justify-content: center;
  cursor: pointer; z-index: 200;
  box-shadow: 0 4px 20px rgba(108,99,255,0.5);
  transition: var(--transition);
}
.mobile-edit-fab:hover { transform: scale(1.1); }

/* ===================== CARD ANIMATIONS ===================== */
.qr-card:nth-child(1) { animation-delay: 0.1s; }
.qr-card:nth-child(2) { animation-delay: 0.15s; }
.qr-card:nth-child(3) { animation-delay: 0.2s; }
.qr-card:nth-child(4) { animation-delay: 0.25s; }
.qr-card:nth-child(5) { animation-delay: 0.3s; }
.qr-card:nth-child(6) { animation-delay: 0.35s; }
.social-pill:nth-child(1) { animation-delay: 0.05s; }
.social-pill:nth-child(2) { animation-delay: 0.1s; }
.social-pill:nth-child(3) { animation-delay: 0.15s; }
.social-pill:nth-child(4) { animation-delay: 0.2s; }
.social-pill:nth-child(5) { animation-delay: 0.25s; }
.social-pill:nth-child(6) { animation-delay: 0.3s; }
.social-pill:nth-child(7) { animation-delay: 0.35s; }

/* delete card button */
.delete-card-btn {
  background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.2);
  color: #ef4444; border-radius: 6px; padding: 3px 8px;
  font-size: 11px; cursor: pointer; font-family: 'Outfit', sans-serif;
  transition: var(--transition);
}
.delete-card-btn:hover { background: rgba(239,68,68,0.2); }

/* move buttons */
.move-btns { display: flex; gap: 2px; }
.move-btn {
  background: rgba(255,255,255,0.05); border: 1px solid var(--border);
  color: var(--text2); border-radius: 5px; width: 22px; height: 22px;
  font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: var(--transition);
}
.move-btn:hover { background: rgba(255,255,255,0.1); color: var(--white); }

/* overlay when mobile menu open */
.mobile-overlay {
  display: none;
  position: fixed; inset: 0; background: rgba(0,0,0,0.6);
  z-index: 99; backdrop-filter: blur(4px);
}
.mobile-overlay.open { display: block; }

/* ===================== TOAST NOTIFICATIONS ===================== */
.toast-container {
  position: fixed; bottom: 24px; right: 24px; z-index: 9999;
  display: flex; flex-direction: column; gap: 8px;
  pointer-events: none;
}
.toast {
  padding: 10px 18px; border-radius: 10px;
  font-size: 13px; font-weight: 600;
  font-family: 'Outfit', sans-serif;
  color: white;
  backdrop-filter: blur(12px);
  animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards;
  pointer-events: auto;
}
.toast-info { background: rgba(108,99,255,0.9); }
.toast-success { background: rgba(16,185,129,0.9); }
.toast-error { background: rgba(239,68,68,0.9); }
@keyframes toastIn { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
@keyframes toastOut { from { opacity:1; } to { opacity:0; transform:translateY(-10px); } }
</style>
</head>
<body>

<!-- Impersonation banner ‚Äî shown only when an admin is viewing as another user -->
<div id="impersonation-banner">
  <span>‚ö† You are viewing as <strong id="impersonated-email"></strong></span>
  <button onclick="exitImpersonation()">Exit Impersonation</button>
</div>

<div class="app-shell">

  <!-- ============================================================ -->
  <!-- EDITOR PANEL -->
  <!-- ============================================================ -->
  <div class="editor-panel" id="editorPanel">
    <div class="editor-header">
      <div class="editor-header-top">
        <div class="editor-logo">
          <div class="editor-logo-mark">
            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><path d="M14 14h.01M14 17h.01M17 14h.01M17 17h.01M14 20h7M20 14v7"/></svg>
          </div>
          <div class="editor-logo-text">QR<span>Profile</span></div>
        </div>
        <div class="header-actions">
          <a class="view-live-btn" id="viewLiveBtn" href="#" target="_blank">View Live</a>
          <button class="save-btn" onclick="saveProfile()">Save</button>
        </div>
      </div>
      <div class="editor-tabs">
        <button class="editor-tab active" onclick="switchTab('profile', this)">Profile</button>
        <button class="editor-tab" onclick="switchTab('socials', this)">Socials</button>
        <button class="editor-tab" onclick="switchTab('cards', this)">Cards</button>
        <button class="editor-tab" onclick="switchTab('theme', this)">Theme</button>
      </div>
    </div>

    <div class="editor-body">

      <!-- PROFILE TAB -->
      <div id="tab-profile">
        <div class="editor-section">
          <div class="editor-section-title">Business Identity</div>
          <div class="field">
            <label>Profile Slug</label>
            <input type="text" id="bizSlug" readonly>
            <div class="field-hint">Auto-generated from business name. Used in your profile URL.</div>
          </div>
          <div class="field">
            <label>Business Name</label>
            <input type="text" id="bizName" value="" oninput="updateProfile()">
          </div>
          <div class="field">
            <label>Tagline</label>
            <input type="text" id="bizTagline" value="" oninput="updateProfile()">
          </div>
          <div class="field">
            <label>Bio / Description</label>
            <textarea id="bizBio" oninput="updateProfile()"></textarea>
          </div>
          <div class="field">
            <label>Logo Initial(s)</label>
            <input type="text" id="bizInitials" value="" maxlength="3" oninput="updateProfile()">
          </div>
        </div>
        <div class="editor-section">
          <div class="editor-section-title">Logo</div>
          <div class="logo-upload-area">
            <div class="logo-preview" id="logoPreview">--</div>
            <button class="logo-upload-btn" onclick="document.getElementById('logoInput').click()">Upload Logo</button>
            <input type="file" id="logoInput" accept="image/*" style="display:none" onchange="uploadLogo(this.files[0])">
          </div>
        </div>
      </div>

      <!-- SOCIALS TAB -->
      <div id="tab-socials" style="display:none">
        <div class="editor-section">
          <div class="editor-section-title">Social Links</div>
          <div class="social-list" id="socialList"></div>
        </div>
      </div>

      <!-- CARDS TAB -->
      <div id="tab-cards" style="display:none">
        <div class="editor-section">
          <div class="card-counter-row">
            <div class="editor-section-title" style="margin-bottom:0">Page Cards</div>
            <span class="card-counter" id="cardCounter">0 / 5</span>
          </div>
          <div class="cards-list" id="cardsEditorList"></div>
          <button class="add-card-btn" id="addCardBtn" onclick="toggleCardTypeMenu()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Add New Card
          </button>
          <div class="card-type-menu" id="cardTypeMenu">
            <div class="card-type-option" onclick="addCard('link')">
              <div class="card-type-option-icon" style="background:rgba(108,99,255,0.2)">üîó</div>
              <div><div class="card-type-option-label">Link</div><div class="card-type-option-desc">URL button</div></div>
            </div>
            <div class="card-type-option" onclick="addCard('map')">
              <div class="card-type-option-icon" style="background:rgba(234,67,53,0.2)">üìç</div>
              <div><div class="card-type-option-label">Map</div><div class="card-type-option-desc">Embedded map</div></div>
            </div>
            <div class="card-type-option" onclick="addCard('website')">
              <div class="card-type-option-icon" style="background:rgba(14,165,233,0.2)">üåê</div>
              <div><div class="card-type-option-label">Website</div><div class="card-type-option-desc">Site preview</div></div>
            </div>
            <div class="card-type-option" onclick="addCard('google')">
              <div class="card-type-option-icon" style="background:rgba(66,133,244,0.2)">‚≠ê</div>
              <div><div class="card-type-option-label">Google</div><div class="card-type-option-desc">Business review</div></div>
            </div>
            <div class="card-type-option" onclick="addCard('cta')">
              <div class="card-type-option-icon" style="background:rgba(245,158,11,0.2)">‚ö°</div>
              <div><div class="card-type-option-label">CTA</div><div class="card-type-option-desc">Call to action</div></div>
            </div>
            <div class="card-type-option" onclick="addCard('text')">
              <div class="card-type-option-icon" style="background:rgba(16,185,129,0.2)">üìù</div>
              <div><div class="card-type-option-label">Text</div><div class="card-type-option-desc">Custom text</div></div>
            </div>
            <div class="card-type-option" onclick="addCard('whatsapp')">
              <div class="card-type-option-icon" style="background:rgba(37,211,102,0.2)">üí¨</div>
              <div><div class="card-type-option-label">WhatsApp</div><div class="card-type-option-desc">Chat button</div></div>
            </div>
            <div class="card-type-option" onclick="addCard('video')">
              <div class="card-type-option-icon" style="background:rgba(255,0,0,0.15)">‚ñ∂Ô∏è</div>
              <div><div class="card-type-option-label">Video</div><div class="card-type-option-desc">YouTube embed</div></div>
            </div>
          </div>
        </div>
      </div>

      <!-- THEME TAB -->
      <div id="tab-theme" style="display:none">
        <div class="editor-section">
          <div class="editor-section-title">Color Theme</div>
          <div class="theme-grid" id="themeGrid"></div>
        </div>
        <div class="editor-section">
          <div class="editor-section-title">Layout</div>
          <div class="field">
            <label>Avatar Style</label>
            <select id="avatarStyle" onchange="updateProfile()">
              <option value="initials">Initials</option>
              <option value="emoji">Emoji</option>
              <option value="logo">Logo</option>
            </select>
          </div>
          <div class="field" id="emojiField" style="display:none">
            <label>Emoji</label>
            <input type="text" id="bizEmoji" value="" oninput="updateProfile()">
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Mobile overlay -->
  <div class="mobile-overlay" id="mobileOverlay" onclick="closeEditor()"></div>

  <!-- ============================================================ -->
  <!-- PREVIEW PANEL -->
  <!-- ============================================================ -->
  <div class="preview-panel">
    <div class="preview-bg">
      <div class="preview-bg-orb orb1"></div>
      <div class="preview-bg-orb orb2"></div>
      <div class="preview-bg-orb orb3"></div>
    </div>

    <div class="preview-topbar">
      <div class="preview-label">Live Preview</div>
      <div class="device-toggle">
        <button class="device-btn active" onclick="setDevice('mobile', this)">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>
          Mobile
        </button>
        <button class="device-btn" onclick="setDevice('desktop', this)">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
          Desktop
        </button>
      </div>
    </div>

    <div class="phone-frame-wrap">
      <div class="phone-frame" id="phoneFrame">
        <div class="phone-notch">
          <div class="notch-cam"></div>
          <div class="notch-pill"></div>
        </div>
        <div class="phone-screen theme-midnight" id="phoneScreen">
          <div class="profile-page" id="profilePage">
            <!-- Dynamic content rendered here -->
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Mobile FAB -->
<button class="mobile-edit-fab" onclick="openEditor()">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
</button>

<!-- Toast container -->
<div class="toast-container" id="toastContainer"></div>

<script>
// ===================== STATE =====================
const state = {
  slug: '',
  profile: {
    name: '',
    tagline: '',
    bio: '',
    initials: '',
    emoji: '',
    avatarStyle: 'initials',
    logoUrl: ''
  },
  theme: 'midnight',
  socials: [
    { id: 'whatsapp', label: 'WhatsApp', icon: '\ud83d\udcac', color: '#25D366', placeholder: '+1234567890', value: '', enabled: false },
    { id: 'instagram', label: 'Instagram', icon: '\ud83d\udcf8', color: '#E1306C', placeholder: '@username', value: '', enabled: false },
    { id: 'facebook', label: 'Facebook', icon: '\ud83d\udc4d', color: '#1877F2', placeholder: 'page url or name', value: '', enabled: false },
    { id: 'phone', label: 'Phone', icon: '\ud83d\udcde', color: '#34a853', placeholder: '+1234567890', value: '', enabled: false },
    { id: 'maps', label: 'Maps', icon: '\ud83d\udccd', color: '#EA4335', placeholder: 'address or coords', value: '', enabled: false },
    { id: 'website', label: 'Website', icon: '\ud83c\udf10', color: '#6c63ff', placeholder: 'https://...', value: '', enabled: false },
    { id: 'email', label: 'Email', icon: '\u2709\ufe0f', color: '#f59e0b', placeholder: 'email@domain.com', value: '', enabled: false },
    { id: 'tiktok', label: 'TikTok', icon: '\ud83c\udfb5', color: '#69C9D0', placeholder: '@username', value: '', enabled: false },
    { id: 'linkedin', label: 'LinkedIn', icon: '\ud83d\udcbc', color: '#0A66C2', placeholder: 'profile url', value: '', enabled: false },
    { id: 'youtube', label: 'YouTube', icon: '\u25b6\ufe0f', color: '#FF0000', placeholder: 'channel url', value: '', enabled: false },
  ],
  cards: [],
  cardLimit: 5
};

// Social href generators (kept separate since they can't be serialized to JSON)
const socialHrefs = {
  whatsapp: (v) => `https://wa.me/${v.replace(/\D/g,'')}`,
  instagram: (v) => `https://instagram.com/${v.replace('@','')}`,
  facebook: (v) => `https://facebook.com/${v}`,
  phone: (v) => `tel:${v}`,
  maps: (v) => `https://maps.google.com/?q=${encodeURIComponent(v)}`,
  website: (v) => v,
  email: (v) => `mailto:${v}`,
  tiktok: (v) => `https://tiktok.com/@${v.replace('@','')}`,
  linkedin: (v) => `https://linkedin.com/company/${v}`,
  youtube: (v) => `https://youtube.com/@${v}`,
};

const themes = [
  { id: 'midnight', label: 'Night', bg: 'linear-gradient(135deg,#080c14,#1a1a3e)' },
  { id: 'emerald', label: 'Forest', bg: 'linear-gradient(135deg,#050d0a,#0a2518)' },
  { id: 'crimson', label: 'Fire', bg: 'linear-gradient(135deg,#0d0507,#2d0a0a)' },
  { id: 'gold', label: 'Gold', bg: 'linear-gradient(135deg,#0a0800,#2a1f00)' },
  { id: 'ocean', label: 'Ocean', bg: 'linear-gradient(135deg,#020b12,#003350)' },
  { id: 'rose', label: 'Rose', bg: 'linear-gradient(135deg,#0d0408,#2d0520)' },
  { id: 'violet', label: 'Violet', bg: 'linear-gradient(135deg,#06040e,#1a0b30)' },
  { id: 'cyan', label: 'Cyan', bg: 'linear-gradient(135deg,#010c0e,#00282e)' },
  { id: 'slate', label: 'Slate', bg: 'linear-gradient(135deg,#0a0d12,#1a2030)' },
  { id: 'amber', label: 'Amber', bg: 'linear-gradient(135deg,#080600,#200f00)' },
];

let cardIdCounter = 100;

// ===================== TOAST SYSTEM =====================
function showToast(message, type = 'info') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.textContent = message;
  container.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// ===================== API HELPERS =====================
async function api(path, options = {}) {
  const res = await fetch(path, {
    headers: { 'Content-Type': 'application/json', ...options.headers },
    credentials: 'same-origin',
    ...options,
  });
  const json = await res.json();
  if (!res.ok) {
    const err = new Error(json.error || 'Request failed');
    err.code = json.code;
    throw err;
  }
  return json.data;
}

// ===================== LOAD PROFILE =====================
async function loadProfile(slug) {
  try {
    const data = await api(`/api/profiles/${slug}`);
    state.slug = data.slug;
    state.profile.name = data.business_name || '';
    state.profile.tagline = data.tagline || '';
    state.profile.bio = data.bio || '';
    state.profile.initials = data.initials || '';
    state.profile.emoji = data.emoji || '';
    state.profile.avatarStyle = data.avatar_style || 'initials';
    state.profile.logoUrl = data.logo_url || '';
    state.theme = data.theme || 'midnight';

    // Merge saved socials into default template
    if (Array.isArray(data.socials)) {
      data.socials.forEach(saved => {
        const match = state.socials.find(s => s.id === saved.id);
        if (match) {
          match.value = saved.value || '';
          match.enabled = !!saved.enabled;
        }
      });
    }

    if (Array.isArray(data.cards)) {
      state.cards = data.cards;
      cardIdCounter = Math.max(100, ...state.cards.map(c => c.id || 0)) + 1;
    }

    state.cardLimit = data.card_limit || 5;

    // Populate form fields
    document.getElementById('bizSlug').value = state.slug;
    document.getElementById('bizName').value = state.profile.name;
    document.getElementById('bizTagline').value = state.profile.tagline;
    document.getElementById('bizBio').value = state.profile.bio;
    document.getElementById('bizInitials').value = state.profile.initials;
    document.getElementById('bizEmoji').value = state.profile.emoji;
    document.getElementById('avatarStyle').value = state.profile.avatarStyle;
    document.getElementById('emojiField').style.display = state.profile.avatarStyle === 'emoji' ? 'block' : 'none';

    // Update logo preview
    updateLogoPreview();

    // Update View Live link
    document.getElementById('viewLiveBtn').href = `/p/${state.slug}`;

    // Set theme on phone screen
    document.getElementById('phoneScreen').className = `phone-screen theme-${state.theme}`;

    renderThemeGrid();
    renderSocialsEditor();
    renderCardsEditor();
    renderProfile();
  } catch (err) {
    console.error('Failed to load profile:', err);
    showToast('Failed to load profile', 'error');
  }
}

// ===================== SAVE PROFILE =====================
async function saveProfile() {
  if (!state.slug) return showToast('No profile loaded', 'error');

  const btn = document.querySelector('.save-btn');
  btn.disabled = true;
  btn.textContent = 'Saving...';
  showToast('Saving...', 'info');

  try {
    // Strip non-serializable props from socials before saving
    const socialsToSave = state.socials.map(({ id, label, icon, color, placeholder, value, enabled }) => ({
      id, label, icon, color, placeholder, value, enabled
    }));

    await api(`/api/profiles/${state.slug}`, {
      method: 'PUT',
      body: JSON.stringify({
        business_name: state.profile.name,
        tagline: state.profile.tagline,
        bio: state.profile.bio,
        initials: state.profile.initials,
        emoji: state.profile.emoji,
        avatar_style: state.profile.avatarStyle,
        theme: state.theme,
        socials: socialsToSave,
        cards: state.cards,
      }),
    });

    showToast('Saved successfully', 'success');
  } catch (err) {
    console.error('Save error:', err);
    if (err.code === 'CARD_LIMIT_EXCEEDED') {
      showToast(`Card limit reached (${state.cardLimit} max)`, 'error');
    } else {
      showToast('Error saving: ' + err.message, 'error');
    }
  } finally {
    btn.disabled = false;
    btn.textContent = 'Save';
  }
}

// ===================== LOGO UPLOAD =====================
async function uploadLogo(file) {
  if (!file || !state.slug) return;

  showToast('Uploading logo...', 'info');

  try {
    const formData = new FormData();
    formData.append('logo', file);

    const res = await fetch(`/api/profiles/${state.slug}/logo`, {
      method: 'POST',
      credentials: 'same-origin',
      body: formData,
    });
    const json = await res.json();
    if (!res.ok) throw new Error(json.error || 'Upload failed');

    state.profile.logoUrl = json.data.logo_url;
    // Auto-switch avatar style to 'logo' so the uploaded image is visible
    state.profile.avatarStyle = 'logo';
    document.getElementById('avatarStyle').value = 'logo';
    document.getElementById('emojiField').style.display = 'none';
    updateLogoPreview();
    renderProfile();
    showToast('Logo uploaded', 'success');
  } catch (err) {
    console.error('Logo upload error:', err);
    showToast('Logo upload failed: ' + err.message, 'error');
  }
}

function updateLogoPreview() {
  const el = document.getElementById('logoPreview');
  if (state.profile.logoUrl) {
    el.innerHTML = `<img src="${state.profile.logoUrl}" alt="Logo">`;
  } else {
    el.innerHTML = '--';
  }
}

// ===================== TABS =====================
function switchTab(tab, btn) {
  document.querySelectorAll('.editor-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  ['profile', 'socials', 'cards', 'theme'].forEach(t => {
    document.getElementById('tab-' + t).style.display = t === tab ? 'block' : 'none';
  });
}

// ===================== THEME =====================
function renderThemeGrid() {
  const grid = document.getElementById('themeGrid');
  grid.innerHTML = themes.map(t => `
    <div class="theme-swatch ${t.id === state.theme ? 'active' : ''}"
         style="background:${t.bg}"
         onclick="setTheme('${t.id}')">
      <span>${t.label}</span>
    </div>
  `).join('');
}
function setTheme(id) {
  state.theme = id;
  const screen = document.getElementById('phoneScreen');
  screen.className = `phone-screen theme-${id}`;
  renderThemeGrid();
}

// ===================== SOCIALS EDITOR =====================
function renderSocialsEditor() {
  const list = document.getElementById('socialList');
  list.innerHTML = state.socials.map((s, i) => `
    <div class="social-item">
      <div class="social-item-icon" style="background:${s.color}22; font-size:16px;">${s.icon}</div>
      <input type="text"
             placeholder="${s.placeholder}"
             value="${s.value}"
             oninput="updateSocial(${i}, this.value)"
             style="color:${s.enabled ? 'var(--text)' : 'var(--text3)'}">
      <button class="social-toggle ${s.enabled ? 'on' : ''}" onclick="toggleSocial(${i})"></button>
    </div>
  `).join('');
}
function updateSocial(i, val) {
  state.socials[i].value = val;
  renderProfile();
}
function toggleSocial(i) {
  state.socials[i].enabled = !state.socials[i].enabled;
  renderSocialsEditor();
  renderProfile();
}

// ===================== CARDS EDITOR =====================
function updateCardCounter() {
  const count = state.cards.length;
  const limit = state.cardLimit;
  const counter = document.getElementById('cardCounter');
  const addBtn  = document.getElementById('addCardBtn');
  if (!counter) return;

  counter.textContent = `${count} / ${limit} cards`;
  counter.className   = 'card-counter ' + (count >= limit ? 'full' : count >= limit - 1 ? 'warn' : 'ok');

  if (addBtn) {
    const atLimit = count >= limit;
    addBtn.disabled = atLimit;
    addBtn.title    = atLimit ? 'Upgrade to add more cards' : '';
  }
}

function renderCardsEditor() {
  const list = document.getElementById('cardsEditorList');
  list.innerHTML = state.cards.map((card, i) => {
    const fields = getCardFields(card);
    return `
    <div class="card-editor-item">
      <div class="card-editor-header" onclick="toggleCardEditor(${card.id})">
        <div class="card-editor-drag" title="Drag to reorder">\u2807</div>
        <div class="card-editor-type-badge" style="${getCardBadgeStyle(card.type)}">${getCardTypeName(card.type)}</div>
        <div class="card-editor-name">${card.title}</div>
        <div class="move-btns">
          <button class="move-btn" onclick="event.stopPropagation();moveCard(${i},-1)">\u2191</button>
          <button class="move-btn" onclick="event.stopPropagation();moveCard(${i},1)">\u2193</button>
        </div>
        <div class="card-editor-toggle" id="chevron-${card.id}">\u25bc</div>
      </div>
      <div class="card-editor-body" id="card-body-${card.id}">
        ${fields}
        <div style="display:flex; justify-content:flex-end; margin-top:8px">
          <button class="delete-card-btn" onclick="deleteCard(${card.id})">\u2715 Remove</button>
        </div>
      </div>
    </div>
  `}).join('');
  updateCardCounter();
}
function getCardBadgeStyle(type) {
  const map = {
    link: 'background:rgba(108,99,255,0.2);color:#a78bfa',
    map: 'background:rgba(234,67,53,0.2);color:#f87171',
    website: 'background:rgba(14,165,233,0.2);color:#38bdf8',
    google: 'background:rgba(66,133,244,0.2);color:#60a5fa',
    cta: 'background:rgba(245,158,11,0.2);color:#fbbf24',
    text: 'background:rgba(16,185,129,0.2);color:#34d399',
    whatsapp: 'background:rgba(37,211,102,0.2);color:#4ade80',
    video: 'background:rgba(255,0,0,0.15);color:#f87171',
  };
  return map[type] || map.link;
}
function getCardTypeName(type) {
  return type.charAt(0).toUpperCase() + type.slice(1);
}
function getCardFields(card) {
  const f = (label, id, val, type='text') => `
    <div class="field">
      <label>${label}</label>
      <input type="${type}" value="${val||''}" oninput="updateCardField(${card.id},'${id}',this.value)">
    </div>`;

  switch(card.type) {
    case 'link': return f('Title', 'title', card.title) + f('Icon (emoji)', 'icon', card.icon) + f('URL', 'url', card.url) + f('Subtitle', 'sub', card.sub);
    case 'map': return f('Title', 'title', card.title) + f('Google Maps Embed URL', 'embedUrl', card.embedUrl) + viewToggleField(card);
    case 'website': return f('Title', 'title', card.title) + f('URL', 'url', card.url) + viewToggleField(card);
    case 'google': return googleCardFields(card);
    case 'cta': return f('Title', 'title', card.title) + f('Badge Text', 'badge', card.badge) + f('Description', 'desc', card.desc) + f('Button Text', 'btnText', card.btnText) + f('URL', 'url', card.url);
    case 'text': return f('Title', 'title', card.title) + `<div class="field"><label>Content</label><textarea oninput="updateCardField(${card.id},'content',this.value)">${card.content||''}</textarea></div>`;
    case 'whatsapp': return f('Title', 'title', card.title) + f('Phone Number', 'phone', card.phone) + f('Pre-filled Message', 'message', card.message);
    case 'video': return f('Title', 'title', card.title) + f('YouTube Embed URL', 'url', card.url) + viewToggleField(card);
    default: return f('Title', 'title', card.title) + f('URL', 'url', card.url);
  }
}
function googleCardFields(card) {
  const f = (label, id, val, type='text', readonly=false) => `
    <div class="field">
      <label>${label}</label>
      <input type="${type}" value="${val||''}" ${readonly ? 'readonly style="opacity:0.7;cursor:not-allowed"' : ''} oninput="updateCardField(${card.id},'${id}',this.value)">
    </div>`;

  const linked = !!card.placeId;

  return `
    <div class="field">
      <label>Paste Google Maps URL or Business Name</label>
      <div style="display:flex;gap:6px">
        <input type="text" id="gbiz-search-${card.id}"
          placeholder="Paste Maps embed URL or type business name"
          value="${card.placeQuery||''}" style="flex:1"
          onkeydown="if(event.key==='Enter'){event.preventDefault();searchGooglePlace(${card.id})}">
        <button onclick="searchGooglePlace(${card.id})" style="background:var(--accent);color:white;border:none;border-radius:var(--radius-sm);padding:8px 14px;font-size:12px;font-weight:600;cursor:pointer;font-family:'Outfit',sans-serif;white-space:nowrap" id="gbiz-search-btn-${card.id}">Fetch</button>
      </div>
      <div style="font-size:10px;color:var(--text3);margin-top:4px">Tip: Copy your Google Maps embed URL and paste it here</div>
      <div id="gbiz-results-${card.id}" style="margin-top:6px"></div>
    </div>
    ${linked ? `<div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
      <span style="font-size:10px;color:var(--accent3)">&#10003; Linked to Google</span>
      <button onclick="unlinkGooglePlace(${card.id})" style="background:none;border:none;color:var(--text3);font-size:10px;cursor:pointer;text-decoration:underline">Unlink</button>
    </div>` : ''}
  ` + f('Title', 'title', card.title) +
    f('Business Name', 'biz', card.biz, 'text', linked) +
    f('Rating', 'rating', card.rating, 'text', linked) +
    f('Review Count', 'reviews', card.reviews, 'text', linked) +
    `<div class="field">
      <label>Google Review / Share URL</label>
      <input type="text" value="${card.url||''}" ${linked ? 'readonly style="opacity:0.7;cursor:not-allowed"' : ''} oninput="updateCardField(${card.id},'url',this.value)">
    </div>` +
    (linked ? `<div style="margin-bottom:10px">
      <button onclick="refreshGooglePlace(${card.id})" style="background:rgba(16,185,129,0.15);color:#34d399;border:1px solid rgba(16,185,129,0.3);border-radius:6px;padding:5px 12px;font-size:11px;font-weight:600;cursor:pointer;font-family:'Outfit',sans-serif">&#8635; Refresh ratings from Google</button>
    </div>` : '');
}

async function searchGooglePlace(cardId) {
  const input = document.getElementById('gbiz-search-' + cardId);
  const resultsDiv = document.getElementById('gbiz-results-' + cardId);
  const btn = document.getElementById('gbiz-search-btn-' + cardId);
  const query = input?.value?.trim();
  if (!query) return;

  btn.textContent = '...';
  btn.disabled = true;
  resultsDiv.innerHTML = '<div style="font-size:11px;color:var(--text3);padding:4px 0">Searching Google...</div>';

  try {
    const resp = await fetch('/api/google-place/search', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query })
    });
    const json = await resp.json();
    if (!resp.ok || json.error) {
      resultsDiv.innerHTML = `<div style="font-size:11px;color:#ef4444;padding:4px 0">${json.error || 'Search failed'}</div>`;
      return;
    }
    const places = json.data || [];
    if (places.length === 0) {
      resultsDiv.innerHTML = '<div style="font-size:11px;color:var(--text3);padding:4px 0">No results found</div>';
      return;
    }
    resultsDiv.innerHTML = '<div style="font-size:10px;color:var(--text3);margin-bottom:4px">Select your business:</div>' +
      places.map(p => `
      <div onclick="selectGooglePlace(${cardId}, '${p.placeId}', ${JSON.stringify(p.name).replace(/'/g,"\\'")}, ${JSON.stringify(p.rating)}, ${JSON.stringify(p.reviewCount)}, ${JSON.stringify(p.mapsUrl).replace(/'/g,"\\'")})"
        style="padding:8px 10px;border-radius:8px;cursor:pointer;border:1px solid var(--border);margin-bottom:4px;transition:var(--transition)"
        onmouseover="this.style.borderColor='var(--accent)';this.style.background='rgba(108,99,255,0.06)'"
        onmouseout="this.style.borderColor='var(--border)';this.style.background='transparent'">
        <div style="font-size:13px;font-weight:600;color:var(--white)">${p.name}</div>
        <div style="font-size:11px;color:var(--text3)">${p.address || ''}</div>
        ${p.rating ? `<div style="font-size:11px;color:#f7c948;margin-top:2px">${'‚òÖ'.repeat(Math.round(p.rating))}${'‚òÜ'.repeat(5-Math.round(p.rating))} ${p.rating} (${p.reviewCount} reviews)</div>` : '<div style="font-size:11px;color:var(--text3);margin-top:2px">No ratings yet</div>'}
      </div>
    `).join('');
  } catch (err) {
    resultsDiv.innerHTML = `<div style="font-size:11px;color:#ef4444;padding:4px 0">Network error ‚Äî check your connection</div>`;
  } finally {
    btn.textContent = 'Fetch';
    btn.disabled = false;
  }
}

function selectGooglePlace(cardId, placeId, name, rating, reviewCount, mapsUrl) {
  const card = state.cards.find(c => c.id === cardId);
  if (!card) return;
  card.placeId = placeId;
  card.placeQuery = name;
  card.biz = name;
  card.rating = rating != null ? String(rating) : '';
  card.reviews = reviewCount != null ? String(reviewCount) : '0';
  if (mapsUrl) card.url = mapsUrl;
  renderCardsEditor();
  renderProfile();
  showToast?.(`Linked to "${name}" ‚Äî ratings auto-filled!`, 'success');
}

function unlinkGooglePlace(cardId) {
  const card = state.cards.find(c => c.id === cardId);
  if (!card) return;
  card.placeId = '';
  card.placeQuery = '';
  renderCardsEditor();
}

async function refreshGooglePlace(cardId) {
  const card = state.cards.find(c => c.id === cardId);
  if (!card || !card.placeId) return;

  try {
    const resp = await fetch(`/api/google-place?placeId=${encodeURIComponent(card.placeId)}`);
    const json = await resp.json();
    if (!resp.ok || json.error) {
      showToast?.(json.error || 'Failed to fetch', 'error');
      return;
    }
    const d = json.data;
    card.biz = d.name || card.biz;
    card.rating = d.rating != null ? String(d.rating) : card.rating;
    card.reviews = d.reviewCount != null ? String(d.reviewCount) : card.reviews;
    if (d.mapsUrl) card.url = d.mapsUrl;
    renderCardsEditor();
    renderProfile();
    showToast?.('Ratings refreshed from Google!', 'success');
  } catch (err) {
    showToast?.('Failed to fetch Google data', 'error');
  }
}

function viewToggleField(card) {
  return `<div class="field">
    <label>Default View</label>
    <select onchange="updateCardField(${card.id},'view',this.value)">
      <option value="card" ${(card.view||'card')==='card'?'selected':''}>Card (collapsed)</option>
      <option value="embed" ${card.view==='embed'?'selected':''}>Embedded (expanded)</option>
    </select>
  </div>`;
}
function toggleCardEditor(id) {
  const body = document.getElementById('card-body-' + id);
  const chev = document.getElementById('chevron-' + id);
  body.classList.toggle('open');
  chev.classList.toggle('open');
}
function updateCardField(id, field, val) {
  const card = state.cards.find(c => c.id === id);
  if (card) {
    card[field] = val;
    renderProfile();
    // Only update the header title inline ‚Äî do NOT re-render the whole editor,
    // because that destroys DOM focus and closes the card body mid-typing.
    if (field === 'title') {
      const item = document.querySelector(`#card-body-${id}`)?.parentElement;
      if (item) {
        const nameEl = item.querySelector('.card-editor-name');
        if (nameEl) nameEl.textContent = val;
      }
    }
  }
}
function deleteCard(id) {
  state.cards = state.cards.filter(c => c.id !== id);
  renderCardsEditor(); renderProfile();
}
function moveCard(i, dir) {
  const j = i + dir;
  if (j < 0 || j >= state.cards.length) return;
  [state.cards[i], state.cards[j]] = [state.cards[j], state.cards[i]];
  renderCardsEditor(); renderProfile();
}
function toggleCardTypeMenu() {
  document.getElementById('cardTypeMenu').classList.toggle('open');
}
function addCard(type) {
  if (state.cards.length >= state.cardLimit) {
    showToast(`Card limit reached (${state.cardLimit} max)`, 'error');
    document.getElementById('cardTypeMenu').classList.remove('open');
    return;
  }
  cardIdCounter++;
  const defaults = {
    link: { title: 'New Link', sub: 'Click to visit', icon: '\ud83d\udd17', url: 'https://', view: 'card' },
    map: { title: 'Our Location', embedUrl: '', view: 'card' },
    website: { title: 'Our Website', url: 'https://example.com', view: 'card' },
    google: { title: 'Review Us', biz: state.profile.name, rating: '', reviews: '', url: '', placeId: '', placeQuery: '' },
    cta: { title: 'Special Offer', badge: '\u26a1 Limited Time', desc: 'Describe your offer here.', btnText: 'Learn More', url: 'https://' },
    text: { title: 'About Us', content: 'Write something here...' },
    whatsapp: { title: 'Chat on WhatsApp', sub: 'We reply instantly', phone: '', message: 'Hi, I found you via QR code' },
    video: { title: 'Watch Our Video', url: 'https://www.youtube.com/embed/dQw4w9WgXcQ', view: 'card' },
  };
  state.cards.push({ id: cardIdCounter, type, ...defaults[type] });
  document.getElementById('cardTypeMenu').classList.remove('open');
  renderCardsEditor(); renderProfile();
}

// ===================== PROFILE UPDATE =====================
function updateProfile() {
  state.profile.name = document.getElementById('bizName').value;
  state.profile.tagline = document.getElementById('bizTagline').value;
  state.profile.bio = document.getElementById('bizBio').value;
  state.profile.initials = document.getElementById('bizInitials').value;
  const avatarStyle = document.getElementById('avatarStyle').value;
  state.profile.avatarStyle = avatarStyle;
  document.getElementById('emojiField').style.display = avatarStyle === 'emoji' ? 'block' : 'none';
  if (avatarStyle === 'emoji') state.profile.emoji = document.getElementById('bizEmoji').value;
  renderProfile();
}

// ===================== RENDER PROFILE =====================
function renderProfile() {
  const { name, tagline, bio, initials, emoji, avatarStyle, logoUrl } = state.profile;
  const activeSocials = state.socials.filter(s => s.enabled && s.value);

  let avatarContent;
  if (avatarStyle === 'logo' && logoUrl) {
    avatarContent = `<img class="avatar-img" src="${logoUrl}" alt="${name}">`;
  } else if (avatarStyle === 'emoji') {
    avatarContent = emoji;
  } else {
    avatarContent = initials;
  }

  const socialPills = activeSocials.map(s => {
    const href = socialHrefs[s.id] ? socialHrefs[s.id](s.value) : '#';
    return `
    <a class="social-pill" href="${href}" target="_blank">
      <span class="social-pill-icon">${s.icon}</span>
      <span class="social-pill-label">${s.label}</span>
    </a>
  `}).join('');

  const cards = state.cards.map(renderCard).join('');

  document.getElementById('profilePage').innerHTML = `
    <div class="profile-hero">
      <div class="profile-hero-bg"></div>
      <div class="profile-hero-mesh"></div>
      <div class="avatar-ring">
        <div class="avatar-wrap">${avatarContent}</div>
      </div>
      <div class="profile-name">${name}</div>
      <div class="profile-tagline">${tagline}</div>
      <p class="profile-bio">${bio}</p>
      <div class="verified-badge">
        <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><path d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/></svg>
        Verified Business
      </div>
    </div>
    <div class="social-strip">${socialPills}</div>
    <div class="cards-container">${cards}</div>
    <div class="profile-footer">
      <a class="powered-by" href="#">Powered by <span class="powered-by-logo">QR<span>Profile</span></span></a>
    </div>
  `;
}

function renderCard(card) {
  switch(card.type) {
    case 'link': return renderLinkCard(card);
    case 'whatsapp': return renderWhatsappCard(card);
    case 'map': return renderMapCard(card);
    case 'website': return renderWebsiteCard(card);
    case 'google': return renderGoogleCard(card);
    case 'cta': return renderCtaCard(card);
    case 'text': return renderTextCard(card);
    case 'video': return renderVideoCard(card);
    default: return renderLinkCard(card);
  }
}

function renderLinkCard(card) {
  return `<div class="qr-card">
    <a class="card-link" href="${card.url||'#'}" target="_blank">
      <div class="card-link-icon" style="background:rgba(108,99,255,0.15)">${card.icon||'\ud83d\udd17'}</div>
      <div class="card-link-content">
        <div class="card-link-title">${card.title}</div>
        <div class="card-link-sub">${card.sub||card.url||''}</div>
      </div>
      <div class="card-link-arrow"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg></div>
    </a>
  </div>`;
}

function renderWhatsappCard(card) {
  const href = `https://wa.me/${(card.phone||'').replace(/\D/g,'')}?text=${encodeURIComponent(card.message||'')}`;
  return `<div class="qr-card" style="background:linear-gradient(135deg,rgba(18,140,50,0.15),rgba(37,211,102,0.08));border-color:rgba(37,211,102,0.15)">
    <a class="card-link" href="${href}" target="_blank">
      <div class="card-link-icon" style="background:rgba(37,211,102,0.15);font-size:22px">\ud83d\udcac</div>
      <div class="card-link-content">
        <div class="card-link-title">${card.title}</div>
        <div class="card-link-sub">${card.message||'Send a message'}</div>
      </div>
      <div class="card-link-arrow" style="color:#4ade80"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg></div>
    </a>
  </div>`;
}

function renderMapCard(card) {
  const isEmbed = card.view === 'embed';
  const embedSrc = card.embedUrl || '';
  const hasEmbed = embedSrc.includes('google.com/maps');
  return `<div class="qr-card">
    <button class="card-expand-btn ${isEmbed?'expanded':''}" onclick="toggleEmbed(this)">
      <div class="card-link-icon" style="background:rgba(234,67,53,0.15);font-size:20px">\ud83d\udccd</div>
      <div class="card-expand-label">
        <div class="card-expand-title">${card.title}</div>
        <div class="card-expand-sub">${hasEmbed ? 'Map embedded' : 'Add embed URL'}</div>
      </div>
      <div class="card-expand-chevron"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg></div>
    </button>
    <div class="card-embed-area ${isEmbed?'open':''}">
      ${hasEmbed
        ? `<iframe src="${embedSrc}" class="map-embed-frame" allowfullscreen loading="lazy"></iframe>`
        : `<div style="padding:24px 18px;text-align:center;color:var(--text3);font-size:13px">Paste a Google Maps embed URL to show the map</div>`}
    </div>
  </div>`;
}

function renderWebsiteCard(card) {
  const isEmbed = card.view === 'embed';
  return `<div class="qr-card">
    <button class="card-expand-btn ${isEmbed?'expanded':''}" onclick="toggleEmbed(this)">
      <div class="card-link-icon" style="background:rgba(14,165,233,0.15);font-size:20px">\ud83c\udf10</div>
      <div class="card-expand-label">
        <div class="card-expand-title">${card.title}</div>
        <div class="card-expand-sub">${card.url||'Set URL'}</div>
      </div>
      <div class="card-expand-chevron"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg></div>
    </button>
    <div class="card-embed-area ${isEmbed?'open':''}">
      <div class="website-preview-bar">
        <div class="browser-dots2">
          <div class="browser-dot2" style="background:#ff5f57"></div>
          <div class="browser-dot2" style="background:#febc2e"></div>
          <div class="browser-dot2" style="background:#28c840"></div>
        </div>
        <div class="url-bar">${card.url||'https://'}</div>
      </div>
      <div class="website-preview-placeholder">
        <div class="site-name">${card.title}</div>
        <div class="site-url">${card.url||'your-website.com'}</div>
      </div>
      <div style="padding:10px 18px;display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,0.02);border-top:1px solid rgba(255,255,255,0.05)">
        <span style="font-size:11px;color:var(--text3)">Preview</span>
        <a href="${card.url}" target="_blank" style="font-size:12px;font-weight:600;color:#38bdf8;text-decoration:none">Visit \u2192</a>
      </div>
    </div>
  </div>`;
}

function renderGoogleCard(card) {
  const stars = '\u2605'.repeat(Math.round(parseFloat(card.rating||5))).padEnd(5,'\u2606');
  return `<div class="qr-card">
    <div class="gbiz-inner">
      <div class="gbiz-brand-row">
        <div class="gbiz-g-icon">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
        </div>
        <div>
          <div class="gbiz-biz-name">${card.biz||card.title}</div>
          <div class="gbiz-biz-cat">Google Business Profile</div>
        </div>
      </div>
      <div class="gbiz-stats-row">
        <div class="gbiz-stat">
          <div class="gbiz-stat-val">${card.rating||'5.0'}</div>
          <div class="gbiz-stat-label">Rating</div>
        </div>
        <div class="gbiz-divider"></div>
        <div class="gbiz-stat">
          <div class="stars2">${[...stars].map(s=>`<span class="star2">${s}</span>`).join('')}</div>
        </div>
        <div class="gbiz-divider"></div>
        <div class="gbiz-stat">
          <div class="gbiz-stat-val">${card.reviews||'0'}</div>
          <div class="gbiz-stat-label">Reviews</div>
        </div>
      </div>
    </div>
    <div class="gbiz-actions">
      <a href="${card.url||'#'}" target="_blank" class="gbiz-action-btn gbiz-action-primary" style="text-align:center;text-decoration:none;display:block;">Write a Review</a>
      <a href="${card.url||'#'}" target="_blank" class="gbiz-action-btn gbiz-action-secondary" style="text-align:center;text-decoration:none;display:block;">View Profile</a>
    </div>
  </div>`;
}

function renderCtaCard(card) {
  return `<div class="qr-card">
    <div class="cta-card">
      <div class="cta-badge">${card.badge||'\u26a1 Offer'}</div>
      <div class="cta-title">${card.title}</div>
      <div class="cta-desc">${card.desc||''}</div>
      <a href="${card.url||'#'}" target="_blank" class="cta-action">${card.btnText||'Learn More'} <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg></a>
    </div>
  </div>`;
}

function renderTextCard(card) {
  return `<div class="qr-card">
    <div style="padding:20px 18px;background:rgba(255,255,255,0.04)">
      <div style="font-family:'Syne',sans-serif;font-size:15px;font-weight:700;color:var(--white);margin-bottom:8px">${card.title}</div>
      <div style="font-size:13px;color:var(--text2);line-height:1.7">${card.content||''}</div>
    </div>
  </div>`;
}

function renderVideoCard(card) {
  const isEmbed = card.view === 'embed';
  return `<div class="qr-card">
    <button class="card-expand-btn ${isEmbed?'expanded':''}" onclick="toggleEmbed(this)">
      <div class="card-link-icon" style="background:rgba(255,0,0,0.12);font-size:20px">\u25b6\ufe0f</div>
      <div class="card-expand-label">
        <div class="card-expand-title">${card.title}</div>
        <div class="card-expand-sub">YouTube Video</div>
      </div>
      <div class="card-expand-chevron"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg></div>
    </button>
    <div class="card-embed-area ${isEmbed?'open':''}">
      <iframe src="${card.url||''}" height="200" allowfullscreen style="width:100%;border:none;display:block"></iframe>
    </div>
  </div>`;
}

// ===================== INTERACTIONS =====================
function toggleEmbed(btn) {
  btn.classList.toggle('expanded');
  const area = btn.nextElementSibling;
  area.classList.toggle('open');
}

function setDevice(mode, btn) {
  document.querySelectorAll('.device-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const frame = document.getElementById('phoneFrame');
  if (mode === 'desktop') {
    frame.classList.add('desktop-view');
  } else {
    frame.classList.remove('desktop-view');
  }
}

function openEditor() {
  document.getElementById('editorPanel').classList.add('mobile-open');
  document.getElementById('mobileOverlay').classList.add('open');
}
function closeEditor() {
  document.getElementById('editorPanel').classList.remove('mobile-open');
  document.getElementById('mobileOverlay').classList.remove('open');
}

// ===================== IMPERSONATION =====================
async function exitImpersonation() {
  try {
    const res = await fetch('/api/admin/impersonate/exit', {
      method: 'POST', credentials: 'same-origin',
    });
    const body = await res.json();
    if (res.ok) {
      window.location.replace('/admin/');
    } else {
      showToast(body.error || 'Failed to exit impersonation', 'error');
    }
  } catch {
    showToast('Network error', 'error');
  }
}

// ===================== BOOT =====================
(async function boot() {
  // Check impersonation status before loading profile
  try {
    const meRes = await fetch('/api/auth/me', { credentials: 'same-origin' });
    if (meRes.ok) {
      const { data } = await meRes.json();
      if (data.impersonatedBy) {
        document.getElementById('impersonated-email').textContent = data.email;
        document.getElementById('impersonation-banner').classList.add('active');
        document.body.classList.add('impersonating');
      }
    }
  } catch { /* non-fatal */ }

  // Read slug from URL query param: /editor.html?slug=desire-realty
  const params = new URLSearchParams(window.location.search);
  const slug = params.get('slug');
  if (slug) {
    loadProfile(slug);
  } else {
    // No slug ‚Äî show empty state, render defaults
    renderThemeGrid();
    renderSocialsEditor();
    renderCardsEditor();
    renderProfile();
    showToast('No profile slug in URL. Add ?slug=your-slug', 'error');
  }
})();
</script>
</body>
</html>
