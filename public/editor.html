<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Profile Platform ‚Äî Editor</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
/* ===================== IMPERSONATION BANNER ===================== */
#impersonation-banner {
  display: none;
  position: fixed; top: 0; left: 0; right: 0; z-index: 10000;
  background: #7f1d1d; border-bottom: 1px solid rgba(255,107,107,0.4);
  padding: 9px 20px; font-size: 13px; font-weight: 500;
  color: #fca5a5; font-family: 'Outfit', sans-serif;
  align-items: center; justify-content: center; gap: 12px;
}
#impersonation-banner.active { display: flex; }
#impersonation-banner strong { color: #fef2f2; font-weight: 700; }
#impersonation-banner button {
  background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3);
  color: #fef2f2; border-radius: 6px; padding: 3px 10px;
  font-size: 12px; font-weight: 600; cursor: pointer;
  font-family: 'Outfit', sans-serif; transition: background 0.2s;
}
#impersonation-banner button:hover { background: rgba(255,255,255,0.25); }
body.impersonating .app-shell { margin-top: 38px; }

/* ===================== RESET & BASE ===================== */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
html { scroll-behavior: smooth; }

:root {
  --bg: #080c14;
  --surface: #0f1624;
  --surface2: #161e30;
  --surface3: #1c2640;
  --border: rgba(255,255,255,0.07);
  --border2: rgba(255,255,255,0.12);
  --accent: #6c63ff;
  --accent2: #ff6b6b;
  --accent3: #43e97b;
  --gold: #f7c948;
  --text: #e8eaf2;
  --text2: #8892a4;
  --text3: #4e5a6e;
  --white: #ffffff;
  --radius: 18px;
  --radius-sm: 10px;
  --shadow: 0 8px 40px rgba(0,0,0,0.4);
  --shadow-lg: 0 20px 80px rgba(0,0,0,0.6);
  --glow: 0 0 40px rgba(108,99,255,0.25);
  --transition: all 0.3s cubic-bezier(0.4,0,0.2,1);
}

body {
  font-family: 'Outfit', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}

/* ===================== SPLIT LAYOUT ===================== */
.app-shell {
  display: flex;
  min-height: 100vh;
}

/* ===================== EDITOR PANEL (LEFT) ===================== */
.editor-panel {
  width: 380px;
  min-width: 380px;
  background: var(--surface);
  border-right: 1px solid var(--border);
  height: 100vh;
  overflow-y: auto;
  overflow-x: hidden;
  display: flex;
  flex-direction: column;
  position: sticky;
  top: 0;
  scrollbar-width: thin;
  scrollbar-color: var(--surface3) transparent;
}
.editor-panel::-webkit-scrollbar { width: 4px; }
.editor-panel::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 4px; }

.editor-header {
  padding: 24px 24px 20px;
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  background: var(--surface);
  z-index: 10;
}
.editor-header-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}
.editor-logo {
  display: flex; align-items: center; gap: 10px;
}
.editor-logo-mark {
  width: 34px; height: 34px; border-radius: 10px;
  background: linear-gradient(135deg, var(--accent), #9c8fff);
  display: flex; align-items: center; justify-content: center;
}
.editor-logo-mark svg { width: 18px; height: 18px; }
.editor-logo-text {
  font-family: 'Syne', sans-serif;
  font-weight: 700; font-size: 16px;
  color: var(--white);
  letter-spacing: -0.3px;
}
.editor-logo-text span { color: var(--accent); }

.header-actions { display: flex; gap: 8px; align-items: center; }

.save-btn, .view-live-btn {
  display: flex; align-items: center; gap: 6px;
  border: none;
  border-radius: 10px;
  padding: 8px 16px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  font-family: 'Outfit', sans-serif;
  transition: var(--transition);
  text-decoration: none;
}
.save-btn {
  background: var(--accent);
  color: white;
  box-shadow: 0 4px 16px rgba(108,99,255,0.4);
}
.save-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 24px rgba(108,99,255,0.5); background: #7c74ff; }
.save-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

.view-live-btn {
  background: var(--surface2);
  color: var(--text);
  border: 1px solid var(--border2);
}
.view-live-btn:hover { background: var(--surface3); border-color: var(--accent); color: var(--white); }

/* Editor Tabs */
.editor-tabs {
  display: flex; gap: 4px;
  background: var(--surface2);
  border-radius: 10px;
  padding: 3px;
}
.editor-tab {
  flex: 1; text-align: center;
  padding: 7px 4px;
  border-radius: 8px;
  font-size: 12px; font-weight: 500;
  color: var(--text2);
  cursor: pointer;
  transition: var(--transition);
  border: none; background: transparent;
  font-family: 'Outfit', sans-serif;
}
.editor-tab.active {
  background: var(--surface3);
  color: var(--white);
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

/* Editor Body */
.editor-body { padding: 20px 24px; flex: 1; }
.editor-section { margin-bottom: 28px; }
.editor-section-title {
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--text3);
  margin-bottom: 12px;
}

/* Form Controls */
.field { margin-bottom: 14px; }
.field label {
  display: block;
  font-size: 12px; font-weight: 500; color: var(--text2);
  margin-bottom: 6px;
}
.field input, .field textarea, .field select {
  width: 100%;
  background: var(--surface2);
  border: 1px solid var(--border2);
  border-radius: var(--radius-sm);
  padding: 10px 12px;
  color: var(--text);
  font-size: 13px;
  font-family: 'Outfit', sans-serif;
  transition: var(--transition);
  outline: none;
}
.field input:focus, .field textarea:focus, .field select:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(108,99,255,0.15);
}
.field textarea { resize: vertical; min-height: 70px; }
.field select { cursor: pointer; }
.field .field-hint { font-size: 11px; color: var(--text3); margin-top: 4px; }
.field input[readonly] { opacity: 0.6; cursor: not-allowed; }

/* Logo upload */
.logo-upload-area {
  display: flex; align-items: center; gap: 12px;
  margin-top: 8px;
}
.logo-preview {
  width: 48px; height: 48px; border-radius: 12px;
  background: var(--surface2); border: 1px solid var(--border2);
  display: flex; align-items: center; justify-content: center;
  overflow: hidden; flex-shrink: 0;
}
.logo-preview img { width: 100%; height: 100%; object-fit: cover; }
.logo-upload-btn {
  background: var(--surface2); border: 1px solid var(--border2);
  color: var(--text2); border-radius: 8px; padding: 6px 14px;
  font-size: 12px; font-weight: 500; cursor: pointer;
  font-family: 'Outfit', sans-serif; transition: var(--transition);
}
.logo-upload-btn:hover { border-color: var(--accent); color: var(--accent); }

/* Color Theme Picker */
.theme-grid {
  display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;
}
.theme-swatch {
  aspect-ratio: 1;
  border-radius: 10px;
  cursor: pointer;
  border: 2px solid transparent;
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}
.theme-swatch.active { border-color: var(--white); }
.theme-swatch:hover { transform: scale(1.08); }
.theme-swatch span {
  position: absolute; bottom: 4px; left: 0; right: 0;
  text-align: center; font-size: 9px; color: rgba(255,255,255,0.8);
  font-weight: 600;
}

/* Social Editor */
.social-list { display: flex; flex-direction: column; gap: 8px; }
.social-item {
  display: flex; align-items: center; gap: 10px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 8px 10px;
  transition: var(--transition);
}
.social-item:hover { border-color: var(--border2); }
.social-item-icon {
  width: 32px; height: 32px; border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}
.social-item input {
  flex: 1; background: transparent; border: none !important;
  box-shadow: none !important; padding: 2px 0 !important;
  font-size: 12px;
}
.social-toggle {
  width: 34px; height: 20px; border-radius: 10px;
  background: var(--surface3); cursor: pointer;
  border: none; position: relative; flex-shrink: 0;
  transition: var(--transition);
}
.social-toggle.on { background: var(--accent); }
.social-toggle::after {
  content: '';
  position: absolute; top: 2px; left: 2px;
  width: 16px; height: 16px; border-radius: 50%;
  background: white; transition: var(--transition);
}
.social-toggle.on::after { left: 16px; }

/* Card Editor */
.cards-list { display: flex; flex-direction: column; gap: 10px; }
.card-editor-item {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
  transition: var(--transition);
}
.card-editor-item:hover { border-color: var(--border2); }
.card-editor-header {
  display: flex; align-items: center; gap: 10px;
  padding: 12px 14px;
  cursor: pointer;
}
.card-editor-drag { color: var(--text3); cursor: grab; }
.card-editor-type-badge {
  font-size: 10px; font-weight: 700; letter-spacing: 1px;
  text-transform: uppercase;
  padding: 3px 8px; border-radius: 6px;
}
.card-editor-name { flex: 1; font-size: 13px; font-weight: 500; color: var(--text); }
.card-editor-toggle { color: var(--text2); transition: var(--transition); }
.card-editor-toggle.open { transform: rotate(180deg); }
.card-editor-body { padding: 0 14px 14px; display: none; }
.card-editor-body.open { display: block; }
.card-editor-body .field { margin-bottom: 10px; }
.card-editor-body .field label { font-size: 11px; }
.card-editor-body .field input { padding: 8px 10px; font-size: 12px; }

.add-card-btn {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  width: 100%;
  background: transparent;
  border: 1.5px dashed var(--border2);
  border-radius: 12px;
  padding: 12px;
  color: var(--text2);
  font-size: 13px; font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
  font-family: 'Outfit', sans-serif;
  margin-top: 10px;
}
.add-card-btn:hover:not(:disabled) { border-color: var(--accent); color: var(--accent); background: rgba(108,99,255,0.05); }
.add-card-btn:disabled { opacity: 0.45; cursor: not-allowed; }

/* Card counter */
.card-counter-row {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 10px;
}
.card-counter {
  font-size: 12px; font-weight: 600;
  padding: 3px 10px; border-radius: 20px;
  border: 1px solid var(--border);
  background: var(--surface2);
  color: var(--text3);
  transition: var(--transition);
}
.card-counter.ok   { color: var(--accent3); border-color: rgba(67,233,123,0.25); background: rgba(67,233,123,0.08); }
.card-counter.warn { color: var(--gold);    border-color: rgba(247,201,72,0.25); background: rgba(247,201,72,0.08); }
.card-counter.full { color: var(--accent2); border-color: rgba(255,107,107,0.25); background: rgba(255,107,107,0.08); }

/* Card Type Menu */
.card-type-menu {
  background: var(--surface3);
  border: 1px solid var(--border2);
  border-radius: 12px;
  padding: 10px;
  display: none;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-top: 8px;
}
.card-type-menu.open { display: grid; }
.card-type-option {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 12px;
  border-radius: 8px;
  cursor: pointer;
  transition: var(--transition);
  border: 1px solid transparent;
}
.card-type-option:hover { background: var(--surface); border-color: var(--accent); }
.card-type-option-icon {
  width: 28px; height: 28px; border-radius: 7px;
  display: flex; align-items: center; justify-content: center;
  font-size: 14px;
}
.card-type-option-label { font-size: 12px; font-weight: 500; color: var(--text); }
.card-type-option-desc { font-size: 10px; color: var(--text3); }

/* ===================== PREVIEW PANEL (RIGHT) ===================== */
.preview-panel {
  flex: 1;
  background: var(--bg);
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 0 20px 60px;
  position: relative;
  overflow-y: auto;
}

/* Animated BG */
.preview-bg {
  position: fixed;
  top: 0; left: 380px; right: 0; bottom: 0;
  z-index: 0;
  overflow: hidden;
  pointer-events: none;
}
.preview-bg-orb {
  position: absolute;
  border-radius: 50%;
  filter: blur(80px);
  opacity: 0.12;
  animation: orbFloat 8s ease-in-out infinite;
}
.orb1 { width: 500px; height: 500px; background: var(--accent); top: -100px; right: -100px; animation-delay: 0s; }
.orb2 { width: 400px; height: 400px; background: #ff6b6b; bottom: -100px; left: -100px; animation-delay: 3s; }
.orb3 { width: 300px; height: 300px; background: #43e97b; top: 40%; left: 30%; animation-delay: 6s; }

@keyframes orbFloat {
  0%, 100% { transform: translate(0,0) scale(1); }
  50% { transform: translate(30px, -30px) scale(1.05); }
}

.preview-topbar {
  width: 100%;
  max-width: 800px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px 0 24px;
  position: relative; z-index: 1;
}
.preview-label {
  display: flex; align-items: center; gap: 8px;
  font-size: 12px; font-weight: 600;
  color: var(--text3);
  letter-spacing: 1px;
  text-transform: uppercase;
}
.preview-label::before {
  content: '';
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--accent3);
  box-shadow: 0 0 6px var(--accent3);
  animation: pulse 2s infinite;
}
@keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.6;transform:scale(1.3)} }

.device-toggle {
  display: flex; gap: 4px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 4px;
}
.device-btn {
  padding: 6px 12px;
  border-radius: 7px;
  border: none;
  background: transparent;
  color: var(--text2);
  font-size: 12px; font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
  font-family: 'Outfit', sans-serif;
  display: flex; align-items: center; gap: 5px;
}
.device-btn.active { background: var(--surface2); color: var(--white); }

/* Phone frame */
.phone-frame-wrap {
  position: relative; z-index: 1;
  display: flex; flex-direction: column; align-items: center;
}
.phone-frame {
  width: 390px;
  background: #111827;
  border-radius: 50px;
  padding: 14px 12px;
  box-shadow: 0 0 0 1px #1f2937, 0 0 0 3px #0d1117, var(--shadow-lg), 0 0 80px rgba(108,99,255,0.1);
  position: relative;
  transition: var(--transition);
}
.phone-frame.desktop-view {
  width: 100%;
  max-width: 900px;
  border-radius: 16px;
  padding: 0;
  background: none;
  box-shadow: none;
}
.phone-notch {
  width: 120px; height: 28px; background: #0d1117;
  border-radius: 20px;
  margin: 0 auto 14px;
  display: flex; align-items: center; justify-content: center; gap: 6px;
  transition: var(--transition);
}
.desktop-view .phone-notch { display: none; }
.notch-cam { width: 10px; height: 10px; background: #1f2937; border-radius: 50%; }
.notch-pill { width: 30px; height: 6px; background: #1f2937; border-radius: 3px; }

.phone-screen {
  background: var(--screen-bg, #080c14);
  border-radius: 38px;
  overflow: hidden;
  height: 760px;
  overflow-y: auto;
  scrollbar-width: none;
  transition: background 0.4s ease;
}
.phone-screen::-webkit-scrollbar { display: none; }
.desktop-view .phone-screen {
  border-radius: 10px;
  height: auto;
  max-height: 85vh;
  overflow-y: auto;
}

/* ===================== PROFILE PAGE RENDERED ===================== */
.profile-page {
  min-height: 100%;
  position: relative;
  padding-bottom: 40px;
}

/* Animated hero gradient */
.profile-hero {
  position: relative;
  padding: 52px 24px 36px;
  text-align: center;
  overflow: hidden;
}
.profile-hero-bg {
  position: absolute; inset: 0; z-index: 0;
  background: var(--hero-bg, linear-gradient(160deg, #0f1020 0%, #0d1520 100%));
  transition: background 0.5s ease;
}
.profile-hero-mesh {
  position: absolute; inset: 0; z-index: 0;
  opacity: 0.5;
  background-image:
    radial-gradient(ellipse 70% 50% at 50% -10%, var(--hero-glow, rgba(108,99,255,0.35)) 0%, transparent 70%),
    radial-gradient(ellipse 40% 40% at 80% 80%, var(--hero-glow2, rgba(108,99,255,0.2)) 0%, transparent 60%);
}
.profile-hero > * { position: relative; z-index: 1; }

.avatar-ring {
  display: inline-flex; position: relative;
  margin-bottom: 20px;
}
.avatar-ring::before {
  content: '';
  position: absolute; inset: -3px;
  border-radius: 50%;
  background: conic-gradient(var(--accent-color, var(--accent)), var(--accent-color2, #ff6b6b), var(--accent-color, var(--accent)));
  animation: spin 6s linear infinite;
  z-index: 0;
}
@keyframes spin { to { transform: rotate(360deg); } }

.avatar-wrap {
  width: 88px; height: 88px;
  border-radius: 50%;
  background: var(--surface2);
  display: flex; align-items: center; justify-content: center;
  position: relative; z-index: 1;
  overflow: hidden;
  font-family: 'Syne', sans-serif;
  font-size: 32px;
  font-weight: 800;
  color: var(--accent-color, var(--accent));
  border: 3px solid var(--bg);
}
.avatar-img { width: 100%; height: 100%; object-fit: cover; }

.profile-name {
  font-family: 'Syne', sans-serif;
  font-size: 26px; font-weight: 800;
  color: var(--white);
  letter-spacing: -0.5px;
  margin-bottom: 4px;
  line-height: 1.2;
}
.profile-tagline {
  font-size: 13px; font-weight: 400;
  color: rgba(255,255,255,0.55);
  letter-spacing: 0.5px;
  margin-bottom: 14px;
}
.profile-bio {
  font-size: 13px; color: rgba(255,255,255,0.45);
  line-height: 1.65; max-width: 280px;
  margin: 0 auto 20px;
}

/* Verified badge */
.verified-badge {
  display: inline-flex; align-items: center; gap: 5px;
  background: rgba(255,255,255,0.07);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 20px;
  padding: 4px 10px;
  font-size: 11px; color: rgba(255,255,255,0.5);
  margin-bottom: 20px;
  backdrop-filter: blur(8px);
}
.verified-badge svg { color: var(--accent-color, var(--accent)); }

/* Social Icons Strip */
.social-strip {
  display: flex; flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
  padding: 0 24px;
  margin-bottom: 32px;
}
.social-pill {
  display: flex; align-items: center; gap: 7px;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.09);
  border-radius: 50px;
  padding: 8px 14px;
  cursor: pointer;
  text-decoration: none;
  transition: var(--transition);
  animation: fadeSlideUp 0.5s ease both;
  backdrop-filter: blur(8px);
}
.social-pill:hover {
  background: rgba(255,255,255,0.12);
  border-color: rgba(255,255,255,0.2);
  transform: translateY(-2px);
}
.social-pill-icon { width: 18px; height: 18px; flex-shrink: 0; }
.social-pill-label { font-size: 12px; font-weight: 500; color: rgba(255,255,255,0.7); }

/* Cards Container */
.cards-container {
  padding: 0 16px;
  display: flex; flex-direction: column; gap: 12px;
}

/* ===== CARD STYLES ===== */
.qr-card {
  border-radius: var(--radius);
  overflow: hidden;
  border: 1px solid rgba(255,255,255,0.07);
  position: relative;
  animation: fadeSlideUp 0.5s ease both;
  transition: var(--transition);
}
.qr-card:hover {
  border-color: rgba(255,255,255,0.14);
  transform: translateY(-2px);
  box-shadow: 0 12px 40px rgba(0,0,0,0.4);
}

/* Link card */
.card-link {
  display: flex; align-items: center; gap: 14px;
  padding: 16px 18px;
  text-decoration: none;
  background: rgba(255,255,255,0.04);
  backdrop-filter: blur(12px);
}
.card-link-icon {
  width: 44px; height: 44px; border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; font-size: 20px;
}
.card-link-content { flex: 1; min-width: 0; }
.card-link-title { font-size: 15px; font-weight: 600; color: var(--white); margin-bottom: 2px; }
.card-link-sub { font-size: 12px; color: var(--text2); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.card-link-arrow { color: var(--text3); flex-shrink: 0; transition: var(--transition); }
.card-link:hover .card-link-arrow { transform: translateX(4px); color: var(--accent-color, var(--accent)); }

/* Expandable card */
.card-expand-btn {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 18px;
  cursor: pointer;
  background: rgba(255,255,255,0.04);
  backdrop-filter: blur(12px);
  border: none; width: 100%; text-align: left;
  transition: var(--transition);
  gap: 14px;
}
.card-expand-btn:hover { background: rgba(255,255,255,0.07); }
.card-expand-btn .card-link-icon { font-size: 20px; }
.card-expand-label { flex: 1; }
.card-expand-title { font-size: 15px; font-weight: 600; color: var(--white); margin-bottom: 2px; }
.card-expand-sub { font-size: 12px; color: var(--text2); }
.card-expand-chevron { color: var(--text3); transition: var(--transition); flex-shrink: 0; }
.card-expand-btn.expanded .card-expand-chevron { transform: rotate(180deg); color: var(--accent-color, var(--accent)); }

.card-embed-area {
  display: none;
  border-top: 1px solid rgba(255,255,255,0.06);
}
.card-embed-area.open { display: block; }
.card-embed-area iframe {
  width: 100%; display: block; border: none;
}
.card-embed-inner { padding: 14px 18px; }

/* Map card */
.map-embed-frame { height: 200px; filter: grayscale(0.3) contrast(1.05); }

/* Website preview */
.website-preview-bar {
  display: flex; align-items: center; gap: 8px;
  padding: 8px 14px;
  background: rgba(255,255,255,0.03);
  border-top: 1px solid rgba(255,255,255,0.06);
}
.browser-dots2 { display: flex; gap: 4px; }
.browser-dot2 { width: 7px; height: 7px; border-radius: 50%; }
.url-bar {
  flex: 1; background: rgba(255,255,255,0.06);
  border-radius: 6px; padding: 3px 10px;
  font-size: 10px; color: var(--text3); font-family: monospace;
}
.website-preview-img {
  width: 100%; height: 180px;
  object-fit: cover; object-position: top;
  display: block;
}
.website-preview-placeholder {
  width: 100%; height: 180px;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center; gap: 6px;
  background: linear-gradient(135deg, rgba(108,99,255,0.15), rgba(255,107,107,0.1));
  font-family: 'Syne', sans-serif;
}
.website-preview-placeholder .site-name { font-size: 18px; font-weight: 700; color: rgba(255,255,255,0.6); }
.website-preview-placeholder .site-url { font-size: 11px; color: rgba(255,255,255,0.3); font-family: monospace; }

/* Google Business */
.gbiz-inner { padding: 18px 18px 6px; background: rgba(255,255,255,0.04); }
.gbiz-brand-row { display: flex; align-items: center; gap: 12px; margin-bottom: 14px; }
.gbiz-g-icon {
  width: 40px; height: 40px; border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  background: #fff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  flex-shrink: 0;
}
.gbiz-g-icon svg { width: 24px; height: 24px; }
.gbiz-biz-name { font-size: 15px; font-weight: 700; color: var(--white); }
.gbiz-biz-cat { font-size: 11px; color: var(--text2); }
.stars2 { display: flex; gap: 2px; margin-bottom: 4px; }
.star2 { color: #f5c518; font-size: 14px; }
.gbiz-stats-row { display: flex; gap: 16px; margin-bottom: 14px; }
.gbiz-stat { text-align: center; }
.gbiz-stat-val { font-size: 18px; font-weight: 700; color: var(--white); }
.gbiz-stat-label { font-size: 10px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.5px; }
.gbiz-divider { width: 1px; background: var(--border); }
.gbiz-actions { display: flex; gap: 8px; padding: 12px 18px; border-top: 1px solid rgba(255,255,255,0.06); background: rgba(255,255,255,0.02); }
.gbiz-action-btn {
  flex: 1; padding: 9px;
  border-radius: 10px; border: none; cursor: pointer;
  font-size: 12px; font-weight: 600;
  font-family: 'Outfit', sans-serif;
  transition: var(--transition);
}
.gbiz-action-primary { background: var(--accent-color, var(--accent)); color: white; }
.gbiz-action-secondary { background: rgba(255,255,255,0.07); color: var(--text); }
.gbiz-action-btn:hover { opacity: 0.85; transform: translateY(-1px); }

/* CTA Card */
.cta-card {
  padding: 20px 18px;
  background: linear-gradient(135deg, var(--cta-from, rgba(108,99,255,0.2)), var(--cta-to, rgba(255,107,107,0.15)));
  position: relative; overflow: hidden;
  backdrop-filter: blur(12px);
}
.cta-card::before {
  content: '';
  position: absolute; inset: 0;
  background: var(--cta-shine, radial-gradient(ellipse 80% 60% at 0% 0%, rgba(255,255,255,0.05) 0%, transparent 60%));
}
.cta-card > * { position: relative; z-index: 1; }
.cta-badge {
  display: inline-flex; align-items: center; gap: 5px;
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.15);
  border-radius: 20px;
  padding: 4px 10px;
  font-size: 10px; font-weight: 700;
  color: rgba(255,255,255,0.8);
  letter-spacing: 1px; text-transform: uppercase;
  margin-bottom: 10px;
}
.cta-title { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 700; color: var(--white); margin-bottom: 6px; line-height: 1.2; }
.cta-desc { font-size: 12px; color: rgba(255,255,255,0.55); line-height: 1.6; margin-bottom: 16px; }
.cta-action {
  display: inline-flex; align-items: center; gap: 8px;
  background: var(--white);
  color: var(--bg);
  border-radius: 10px;
  padding: 10px 18px;
  font-size: 13px; font-weight: 700;
  text-decoration: none;
  transition: var(--transition);
  border: none; cursor: pointer; font-family: 'Outfit', sans-serif;
}
.cta-action:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }

/* Footer */
.profile-footer {
  text-align: center;
  padding: 32px 24px 20px;
  position: relative; z-index: 1;
}
.powered-by {
  display: inline-flex; align-items: center; gap: 6px;
  font-size: 11px; color: var(--text3);
  text-decoration: none;
  transition: var(--transition);
}
.powered-by:hover { color: var(--text2); }
.powered-by-logo { font-family: 'Syne', sans-serif; font-weight: 700; }
.powered-by-logo span { color: var(--accent); }

@keyframes fadeSlideUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ===================== THEMES ===================== */
.theme-midnight { --screen-bg:#080c14; --hero-bg:linear-gradient(160deg,#0f1020,#0d1520); --hero-glow:rgba(108,99,255,0.35); --hero-glow2:rgba(108,99,255,0.2); --accent-color:#6c63ff; --accent-color2:#ff6b6b; --cta-from:rgba(108,99,255,0.2); --cta-to:rgba(255,107,107,0.15); }
.theme-emerald { --screen-bg:#050d0a; --hero-bg:linear-gradient(160deg,#051209,#061510); --hero-glow:rgba(16,185,129,0.4); --hero-glow2:rgba(67,233,123,0.2); --accent-color:#10b981; --accent-color2:#43e97b; --cta-from:rgba(16,185,129,0.2); --cta-to:rgba(67,233,123,0.1); }
.theme-crimson { --screen-bg:#0d0507; --hero-bg:linear-gradient(160deg,#150508,#1a0808); --hero-glow:rgba(239,68,68,0.4); --hero-glow2:rgba(251,113,133,0.2); --accent-color:#ef4444; --accent-color2:#fb7185; --cta-from:rgba(239,68,68,0.2); --cta-to:rgba(251,113,133,0.1); }
.theme-gold { --screen-bg:#0a0800; --hero-bg:linear-gradient(160deg,#120f00,#160e00); --hero-glow:rgba(245,158,11,0.4); --hero-glow2:rgba(251,191,36,0.2); --accent-color:#f59e0b; --accent-color2:#fbbf24; --cta-from:rgba(245,158,11,0.2); --cta-to:rgba(251,191,36,0.1); }
.theme-ocean { --screen-bg:#020b12; --hero-bg:linear-gradient(160deg,#020e18,#011520); --hero-glow:rgba(14,165,233,0.4); --hero-glow2:rgba(56,189,248,0.2); --accent-color:#0ea5e9; --accent-color2:#38bdf8; --cta-from:rgba(14,165,233,0.2); --cta-to:rgba(56,189,248,0.1); }
.theme-rose { --screen-bg:#0d0408; --hero-bg:linear-gradient(160deg,#150610,#180814); --hero-glow:rgba(236,72,153,0.4); --hero-glow2:rgba(251,113,133,0.2); --accent-color:#ec4899; --accent-color2:#f43f5e; --cta-from:rgba(236,72,153,0.2); --cta-to:rgba(244,63,94,0.1); }
.theme-slate { --screen-bg:#0a0d12; --hero-bg:linear-gradient(160deg,#0d1018,#111420); --hero-glow:rgba(148,163,184,0.3); --hero-glow2:rgba(203,213,225,0.15); --accent-color:#94a3b8; --accent-color2:#cbd5e1; --cta-from:rgba(148,163,184,0.15); --cta-to:rgba(203,213,225,0.08); }
.theme-amber { --screen-bg:#080600; --hero-bg:linear-gradient(160deg,#0d0900,#100b00); --hero-glow:rgba(217,119,6,0.4); --hero-glow2:rgba(245,158,11,0.2); --accent-color:#d97706; --accent-color2:#f59e0b; --cta-from:rgba(217,119,6,0.2); --cta-to:rgba(245,158,11,0.1); }
.theme-violet { --screen-bg:#06040e; --hero-bg:linear-gradient(160deg,#0a0614,#0d0818); --hero-glow:rgba(167,139,250,0.4); --hero-glow2:rgba(192,132,252,0.2); --accent-color:#a78bfa; --accent-color2:#c084fc; --cta-from:rgba(167,139,250,0.2); --cta-to:rgba(192,132,252,0.1); }
.theme-cyan { --screen-bg:#010c0e; --hero-bg:linear-gradient(160deg,#011018,#01141c); --hero-glow:rgba(6,182,212,0.4); --hero-glow2:rgba(34,211,238,0.2); --accent-color:#06b6d4; --accent-color2:#22d3ee; --cta-from:rgba(6,182,212,0.2); --cta-to:rgba(34,211,238,0.1); }
.theme-neon_tokyo { --screen-bg:#0a0014; --hero-bg:linear-gradient(160deg,#0a0014,#12002a); --hero-glow:rgba(255,0,255,0.45); --hero-glow2:rgba(0,255,255,0.25); --accent-color:#ff00ff; --accent-color2:#00ffff; --cta-from:rgba(255,0,255,0.2); --cta-to:rgba(0,255,255,0.1); }
.theme-arctic { --screen-bg:#f0f4f8; --hero-bg:linear-gradient(160deg,#e8f0f8,#dce8f5); --hero-glow:rgba(59,130,246,0.2); --hero-glow2:rgba(147,197,253,0.15); --accent-color:#2563eb; --accent-color2:#3b82f6; --cta-from:rgba(59,130,246,0.1); --cta-to:rgba(147,197,253,0.08); }
.theme-sand_dune { --screen-bg:#1a1208; --hero-bg:linear-gradient(160deg,#1a1208,#241808); --hero-glow:rgba(217,168,68,0.35); --hero-glow2:rgba(180,120,40,0.2); --accent-color:#d9a844; --accent-color2:#c8903a; --cta-from:rgba(217,168,68,0.2); --cta-to:rgba(180,120,40,0.1); }
.theme-deep_space { --screen-bg:#010108; --hero-bg:linear-gradient(160deg,#010108,#030318); --hero-glow:rgba(100,60,255,0.5); --hero-glow2:rgba(180,60,255,0.3); --accent-color:#6433ff; --accent-color2:#b43cff; --cta-from:rgba(100,60,255,0.2); --cta-to:rgba(180,60,255,0.1); }
.theme-sakura { --screen-bg:#1a0810; --hero-bg:linear-gradient(160deg,#1a0810,#240818); --hero-glow:rgba(255,150,180,0.4); --hero-glow2:rgba(255,100,150,0.2); --accent-color:#ff96b4; --accent-color2:#ff6496; --cta-from:rgba(255,150,180,0.2); --cta-to:rgba(255,100,150,0.1); }
.theme-matrix { --screen-bg:#000800; --hero-bg:linear-gradient(160deg,#000800,#001200); --hero-glow:rgba(0,255,70,0.4); --hero-glow2:rgba(0,200,50,0.2); --accent-color:#00ff46; --accent-color2:#00c832; --cta-from:rgba(0,255,70,0.15); --cta-to:rgba(0,200,50,0.08); }
.theme-sunset { --screen-bg:#1a0500; --hero-bg:linear-gradient(160deg,#1a0500,#2d0800); --hero-glow:rgba(255,100,0,0.45); --hero-glow2:rgba(255,180,0,0.25); --accent-color:#ff6400; --accent-color2:#ffb400; --cta-from:rgba(255,100,0,0.2); --cta-to:rgba(255,180,0,0.1); }
.theme-nordic { --screen-bg:#080e18; --hero-bg:linear-gradient(160deg,#080e18,#0d1830); --hero-glow:rgba(100,160,220,0.35); --hero-glow2:rgba(140,200,255,0.2); --accent-color:#64a0dc; --accent-color2:#8cc8ff; --cta-from:rgba(100,160,220,0.18); --cta-to:rgba(140,200,255,0.1); }
.theme-bubblegum { --screen-bg:#1a0818; --hero-bg:linear-gradient(160deg,#1a0818,#280a28); --hero-glow:rgba(255,80,200,0.4); --hero-glow2:rgba(200,80,255,0.25); --accent-color:#ff50c8; --accent-color2:#c850ff; --cta-from:rgba(255,80,200,0.2); --cta-to:rgba(200,80,255,0.1); }
.theme-corporate { --screen-bg:#020810; --hero-bg:linear-gradient(160deg,#020810,#041428); --hero-glow:rgba(30,80,180,0.4); --hero-glow2:rgba(60,120,220,0.2); --accent-color:#1e50b4; --accent-color2:#3c78dc; --cta-from:rgba(30,80,180,0.2); --cta-to:rgba(60,120,220,0.1); }
.theme-luxury { --screen-bg:#050505; --hero-bg:linear-gradient(160deg,#080808,#101010); --hero-glow:rgba(212,175,55,0.35); --hero-glow2:rgba(180,140,30,0.2); --accent-color:#d4af37; --accent-color2:#b48c1e; --cta-from:rgba(212,175,55,0.15); --cta-to:rgba(180,140,30,0.08); }
.theme-terracotta { --screen-bg:#140a06; --hero-bg:linear-gradient(160deg,#140a06,#201008); --hero-glow:rgba(200,90,50,0.4); --hero-glow2:rgba(180,120,60,0.25); --accent-color:#c85a32; --accent-color2:#b4783c; --cta-from:rgba(200,90,50,0.2); --cta-to:rgba(180,120,60,0.1); }
.theme-mint { --screen-bg:#030d08; --hero-bg:linear-gradient(160deg,#030d08,#051810); --hero-glow:rgba(50,200,140,0.4); --hero-glow2:rgba(80,230,160,0.2); --accent-color:#32c88c; --accent-color2:#50e6a0; --cta-from:rgba(50,200,140,0.2); --cta-to:rgba(80,230,160,0.1); }
.theme-retrowave { --screen-bg:#0a0018; --hero-bg:linear-gradient(160deg,#0a0018,#180030); --hero-glow:rgba(255,50,150,0.45); --hero-glow2:rgba(80,0,255,0.3); --accent-color:#ff3296; --accent-color2:#5000ff; --cta-from:rgba(255,50,150,0.2); --cta-to:rgba(80,0,255,0.12); }
.theme-mono { --screen-bg:#080808; --hero-bg:linear-gradient(160deg,#080808,#141414); --hero-glow:rgba(200,200,200,0.2); --hero-glow2:rgba(160,160,160,0.12); --accent-color:#d0d0d0; --accent-color2:#a0a0a0; --cta-from:rgba(200,200,200,0.1); --cta-to:rgba(160,160,160,0.06); }

/* Arctic light-mode overrides */
.theme-arctic { --text: #1a2540; --text2: #4a5568; --text3: #718096; --border: rgba(0,0,0,0.08); }
.theme-arctic .profile-name { color: #1a2540; }
.theme-arctic .card-link-title, .theme-arctic .card-expand-title { color: #1a2540; }
.theme-arctic .card-link-sub, .theme-arctic .card-expand-sub { color: #4a5568; }
.theme-arctic .profile-tagline { color: #4a5568; }
.theme-arctic .profile-bio { color: #718096; }
.theme-arctic .qr-card { background: rgba(0,0,0,0.04); border-color: rgba(0,0,0,0.08); }
.theme-arctic .gbiz-biz-name { color: #1a2540; }
.theme-arctic .gbiz-stat-val { color: #1a2540; }
.theme-arctic .gbiz-stat-label, .theme-arctic .gbiz-biz-cat { color: #718096; }
.theme-arctic .cta-title { color: #1a2540; }
.theme-arctic .cta-desc { color: #4a5568; }
.theme-arctic .verified-badge { background: rgba(0,0,0,0.05); border-color: rgba(0,0,0,0.1); color: #4a5568; }
.theme-arctic .powered-by { color: #718096; }
.theme-arctic .social-pill { background: rgba(0,0,0,0.05); border-color: rgba(0,0,0,0.08); }
.theme-arctic .social-pill-label { color: #4a5568; }

/* ===================== RESPONSIVE ===================== */
@media(max-width: 900px) {
  .editor-panel { position: fixed; left: -380px; z-index: 100; transition: var(--transition); }
  .editor-panel.mobile-open { left: 0; }
  .preview-panel { width: 100%; }
  .preview-bg { left: 0; }
  .mobile-edit-fab {
    display: flex !important;
  }
}
.mobile-edit-fab {
  display: none;
  position: fixed; bottom: 24px; right: 24px;
  width: 52px; height: 52px; border-radius: 50%;
  background: var(--accent);
  color: white; border: none;
  align-items: center; justify-content: center;
  cursor: pointer; z-index: 200;
  box-shadow: 0 4px 20px rgba(108,99,255,0.5);
  transition: var(--transition);
}
.mobile-edit-fab:hover { transform: scale(1.1); }

/* ===================== CARD ANIMATIONS ===================== */
.qr-card:nth-child(1) { animation-delay: 0.1s; }
.qr-card:nth-child(2) { animation-delay: 0.15s; }
.qr-card:nth-child(3) { animation-delay: 0.2s; }
.qr-card:nth-child(4) { animation-delay: 0.25s; }
.qr-card:nth-child(5) { animation-delay: 0.3s; }
.qr-card:nth-child(6) { animation-delay: 0.35s; }
.social-pill:nth-child(1) { animation-delay: 0.05s; }
.social-pill:nth-child(2) { animation-delay: 0.1s; }
.social-pill:nth-child(3) { animation-delay: 0.15s; }
.social-pill:nth-child(4) { animation-delay: 0.2s; }
.social-pill:nth-child(5) { animation-delay: 0.25s; }
.social-pill:nth-child(6) { animation-delay: 0.3s; }
.social-pill:nth-child(7) { animation-delay: 0.35s; }

/* delete card button */
.delete-card-btn {
  background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.2);
  color: #ef4444; border-radius: 6px; padding: 3px 8px;
  font-size: 11px; cursor: pointer; font-family: 'Outfit', sans-serif;
  transition: var(--transition);
}
.delete-card-btn:hover { background: rgba(239,68,68,0.2); }

/* move buttons */
.move-btns { display: flex; gap: 2px; }
.move-btn {
  background: rgba(255,255,255,0.05); border: 1px solid var(--border);
  color: var(--text2); border-radius: 5px; width: 22px; height: 22px;
  font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: var(--transition);
}
.move-btn:hover { background: rgba(255,255,255,0.1); color: var(--white); }

/* overlay when mobile menu open */
.mobile-overlay {
  display: none;
  position: fixed; inset: 0; background: rgba(0,0,0,0.6);
  z-index: 99; backdrop-filter: blur(4px);
}
.mobile-overlay.open { display: block; }

/* ===================== TOAST NOTIFICATIONS ===================== */
.toast-container {
  position: fixed; bottom: 24px; right: 24px; z-index: 9999;
  display: flex; flex-direction: column; gap: 8px;
  pointer-events: none;
}
.toast {
  padding: 10px 18px; border-radius: 10px;
  font-size: 13px; font-weight: 600;
  font-family: 'Outfit', sans-serif;
  color: white;
  backdrop-filter: blur(12px);
  animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards;
  pointer-events: auto;
}
.toast-info { background: rgba(108,99,255,0.9); }
.toast-success { background: rgba(16,185,129,0.9); }
.toast-error { background: rgba(239,68,68,0.9); }
@keyframes toastIn { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
@keyframes toastOut { from { opacity:1; } to { opacity:0; transform:translateY(-10px); } }
</style>
</head>
<body>

<!-- Impersonation banner ‚Äî shown only when an admin is viewing as another user -->
<div id="impersonation-banner">
  <span>‚ö† You are viewing as <strong id="impersonated-email"></strong></span>
  <button onclick="exitImpersonation()">Exit Impersonation</button>
</div>

<div class="app-shell">

  <!-- ============================================================ -->
  <!-- EDITOR PANEL -->
  <!-- ============================================================ -->
  <div class="editor-panel" id="editorPanel">
    <div class="editor-header">
      <div class="editor-header-top">
        <div class="editor-logo">
          <div class="editor-logo-mark">
            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><path d="M14 14h.01M14 17h.01M17 14h.01M17 17h.01M14 20h7M20 14v7"/></svg>
          </div>
          <div class="editor-logo-text">QR<span>Profile</span></div>
        </div>
        <div class="header-actions">
          <a class="view-live-btn" id="viewLiveBtn" href="#" target="_blank">View Live</a>
          <button class="save-btn" onclick="saveProfile()">Save</button>
        </div>
      </div>
      <div class="editor-tabs">
        <button class="editor-tab active" onclick="switchTab('profile', this)">Profile</button>
        <button class="editor-tab" onclick="switchTab('socials', this)">Socials</button>
        <button class="editor-tab" onclick="switchTab('cards', this)">Cards</button>
        <button class="editor-tab" onclick="switchTab('theme', this)">Theme</button>
      </div>
    </div>

    <div class="editor-body">

      <!-- PROFILE TAB -->
      <div id="tab-profile">
        <div class="editor-section">
          <div class="editor-section-title">Business Identity</div>
          <div class="field">
            <label>Profile Slug</label>
            <input type="text" id="bizSlug" readonly>
            <div class="field-hint">Auto-generated from business name. Used in your profile URL.</div>
          </div>
          <div class="field">
            <label>Business Name</label>
            <input type="text" id="bizName" value="" oninput="updateProfile()">
          </div>
          <div class="field">
            <label>Tagline</label>
            <input type="text" id="bizTagline" value="" oninput="updateProfile()">
          </div>
          <div class="field">
            <label>Bio / Description</label>
            <textarea id="bizBio" oninput="updateProfile()"></textarea>
          </div>
          <div class="field">
            <label>Logo Initial(s)</label>
            <input type="text" id="bizInitials" value="" maxlength="3" oninput="updateProfile()">
          </div>
        </div>
        <div class="editor-section">
          <div class="editor-section-title">Logo</div>
          <div class="logo-upload-area">
            <div class="logo-preview" id="logoPreview">--</div>
            <button class="logo-upload-btn" onclick="document.getElementById('logoInput').click()">Upload Logo</button>
            <input type="file" id="logoInput" accept="image/*" style="display:none" onchange="uploadLogo(this.files[0])">
          </div>
        </div>
      </div>

      <!-- SOCIALS TAB -->
      <div id="tab-socials" style="display:none">
        <div class="editor-section">
          <div class="editor-section-title">Social Links</div>
          <div class="social-list" id="socialList"></div>
        </div>
      </div>

      <!-- CARDS TAB -->
      <div id="tab-cards" style="display:none">
        <div class="editor-section">
          <div class="card-counter-row">
            <div class="editor-section-title" style="margin-bottom:0">Page Cards</div>
            <span class="card-counter" id="cardCounter">0 / 5</span>
          </div>
          <div class="cards-list" id="cardsEditorList"></div>
          <button class="add-card-btn" id="addCardBtn" onclick="toggleCardTypeMenu()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Add New Card
          </button>
          <div class="card-type-menu" id="cardTypeMenu">
            <div style="grid-column:1/-1;font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);padding:4px 4px 0">Content & Media</div>
            <div class="card-type-option" onclick="addCard('link')">
              <div class="card-type-option-icon" style="background:rgba(108,99,255,0.2)">üîó</div>
              <div><div class="card-type-option-label">Link</div><div class="card-type-option-desc">URL button</div></div>
            </div>
            <div class="card-type-option" onclick="addCard('text')">
              <div class="card-type-option-icon" style="background:rgba(16,185,129,0.2)">üìù</div>
              <div><div class="card-type-option-label">Text</div><div class="card-type-option-desc">Custom text</div></div>
            </div>
            <div class="card-type-option" onclick="addCard('image')">
              <div class="card-type-option-icon" style="background:rgba(168,85,247,0.2)">üñºÔ∏è</div>
              <div><div class="card-type-option-label">Image</div><div class="card-type-option-desc">Full-width image</div></div>
            </div>
            <div class="card-type-option" onclick="addCard('image_grid')">
              <div class="card-type-option-icon" style="background:rgba(168,85,247,0.2)">üî≤</div>
              <div><div class="card-type-option-label">Image Grid</div><div class="card-type-option-desc">2-3 column grid</div></div>
            </div>
            <div class="card-type-option" onclick="addCard('video')">
              <div class="card-type-option-icon" style="background:rgba(255,0,0,0.15)">‚ñ∂Ô∏è</div>
              <div><div class="card-type-option-label">Video</div><div class="card-type-option-desc">YouTube embed</div></div>
            </div>
            <div class="card-type-option" onclick="addCard('audio')">
              <div class="card-type-option-icon" style="background:rgba(30,215,96,0.2)">üéµ</div>
              <div><div class="card-type-option-label">Audio</div><div class="card-type-option-desc">Audio embed</div></div>
            </div>
            <div class="card-type-option" onclick="addCard('pdf')">
              <div class="card-type-option-icon" style="background:rgba(239,68,68,0.2)">üìÑ</div>
              <div><div class="card-type-option-label">PDF</div><div class="card-type-option-desc">PDF preview</div></div>
            </div>
            <div class="card-type-option" onclick="addCard('map')">
              <div class="card-type-option-icon" style="background:rgba(234,67,53,0.2)">üìç</div>
              <div><div class="card-type-option-label">Map</div><div class="card-type-option-desc">Embedded map</div></div>
            </div>
            <div class="card-type-option" onclick="addCard('website')">
              <div class="card-type-option-icon" style="background:rgba(14,165,233,0.2)">üåê</div>
              <div><div class="card-type-option-label">Website</div><div class="card-type-option-desc">Site preview</div></div>
            </div>
            <div class="card-type-option" onclick="addCard('countdown')">
              <div class="card-type-option-icon" style="background:rgba(251,191,36,0.2)">‚è≥</div>
              <div><div class="card-type-option-label">Countdown</div><div class="card-type-option-desc">Live timer</div></div>
            </div>
            <div class="card-type-option" onclick="addCard('rss_feed')">
              <div class="card-type-option-icon" style="background:rgba(251,146,60,0.2)">üì∞</div>
              <div><div class="card-type-option-label">RSS Feed</div><div class="card-type-option-desc">Blog posts</div></div>
            </div>
            <div class="card-type-option" onclick="addCard('faq')">
              <div class="card-type-option-icon" style="background:rgba(20,184,166,0.2)">‚ùì</div>
              <div><div class="card-type-option-label">FAQ</div><div class="card-type-option-desc">Accordion Q&A</div></div>
            </div>
            <div style="grid-column:1/-1;font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);padding:8px 4px 0;border-top:1px solid var(--border)">Engagement</div>
            <div class="card-type-option" onclick="addCard('cta')">
              <div class="card-type-option-icon" style="background:rgba(245,158,11,0.2)">‚ö°</div>
              <div><div class="card-type-option-label">CTA</div><div class="card-type-option-desc">Call to action</div></div>
            </div>
            <div class="card-type-option" onclick="addCard('whatsapp')">
              <div class="card-type-option-icon" style="background:rgba(37,211,102,0.2)">üí¨</div>
              <div><div class="card-type-option-label">WhatsApp</div><div class="card-type-option-desc">Chat button</div></div>
            </div>
            <div class="card-type-option" onclick="addCard('google')">
              <div class="card-type-option-icon" style="background:rgba(66,133,244,0.2)">‚≠ê</div>
              <div><div class="card-type-option-label">Google</div><div class="card-type-option-desc">Business review</div></div>
            </div>
            <div class="card-type-option" onclick="addCard('contact_form')">
              <div class="card-type-option-icon" style="background:rgba(59,130,246,0.2)">üì¨</div>
              <div><div class="card-type-option-label">Contact</div><div class="card-type-option-desc">Contact form</div></div>
            </div>
            <div class="card-type-option" onclick="addCard('email_capture')">
              <div class="card-type-option-icon" style="background:rgba(16,185,129,0.2)">üìß</div>
              <div><div class="card-type-option-label">Email</div><div class="card-type-option-desc">Email signup</div></div>
            </div>
            <div class="card-type-option" onclick="addCard('poll')">
              <div class="card-type-option-icon" style="background:rgba(139,92,246,0.2)">üìä</div>
              <div><div class="card-type-option-label">Poll</div><div class="card-type-option-desc">Voting poll</div></div>
            </div>
            <div class="card-type-option" onclick="addCard('testimonial')">
              <div class="card-type-option-icon" style="background:rgba(244,114,182,0.2)">üí¨</div>
              <div><div class="card-type-option-label">Testimonial</div><div class="card-type-option-desc">Customer review</div></div>
            </div>
            <div style="grid-column:1/-1;font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);padding:8px 4px 0;border-top:1px solid var(--border)">Commerce & Booking</div>
            <div class="card-type-option" onclick="addCard('product')">
              <div class="card-type-option-icon" style="background:rgba(245,158,11,0.2)">üõçÔ∏è</div>
              <div><div class="card-type-option-label">Product</div><div class="card-type-option-desc">Product card</div></div>
            </div>
            <div class="card-type-option" onclick="addCard('booking')">
              <div class="card-type-option-icon" style="background:rgba(59,130,246,0.2)">üìÖ</div>
              <div><div class="card-type-option-label">Booking</div><div class="card-type-option-desc">Scheduling</div></div>
            </div>
            <div class="card-type-option" onclick="addCard('tip_jar')">
              <div class="card-type-option-icon" style="background:rgba(251,191,36,0.2)">‚òï</div>
              <div><div class="card-type-option-label">Tip Jar</div><div class="card-type-option-desc">Accept tips</div></div>
            </div>
            <div style="grid-column:1/-1;font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);padding:8px 4px 0;border-top:1px solid var(--border)">Social Embeds</div>
            <div class="card-type-option" onclick="addCard('spotify')">
              <div class="card-type-option-icon" style="background:rgba(30,215,96,0.2)">üéß</div>
              <div><div class="card-type-option-label">Spotify</div><div class="card-type-option-desc">Music embed</div></div>
            </div>
            <div class="card-type-option" onclick="addCard('instagram_post')">
              <div class="card-type-option-icon" style="background:rgba(228,64,95,0.2)">üì∏</div>
              <div><div class="card-type-option-label">Instagram</div><div class="card-type-option-desc">Post embed</div></div>
            </div>
            <div class="card-type-option" onclick="addCard('tweet')">
              <div class="card-type-option-icon" style="background:rgba(29,155,240,0.2)">ùïè</div>
              <div><div class="card-type-option-label">Tweet</div><div class="card-type-option-desc">X post embed</div></div>
            </div>
            <div class="card-type-option" onclick="addCard('tiktok_post')">
              <div class="card-type-option-icon" style="background:rgba(255,0,80,0.2)">üéµ</div>
              <div><div class="card-type-option-label">TikTok</div><div class="card-type-option-desc">Video embed</div></div>
            </div>
          </div>
        </div>
      </div>

      <!-- THEME TAB -->
      <div id="tab-theme" style="display:none">
        <div class="editor-section">
          <div class="editor-section-title">Color Theme</div>
          <div class="theme-grid" id="themeGrid"></div>
        </div>
        <div class="editor-section">
          <div class="editor-section-title">Layout</div>
          <div class="field">
            <label>Avatar Style</label>
            <select id="avatarStyle" onchange="updateProfile()">
              <option value="initials">Initials</option>
              <option value="emoji">Emoji</option>
              <option value="logo">Logo</option>
            </select>
          </div>
          <div class="field" id="emojiField" style="display:none">
            <label>Emoji</label>
            <input type="text" id="bizEmoji" value="" oninput="updateProfile()">
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Mobile overlay -->
  <div class="mobile-overlay" id="mobileOverlay" onclick="closeEditor()"></div>

  <!-- ============================================================ -->
  <!-- PREVIEW PANEL -->
  <!-- ============================================================ -->
  <div class="preview-panel">
    <div class="preview-bg">
      <div class="preview-bg-orb orb1"></div>
      <div class="preview-bg-orb orb2"></div>
      <div class="preview-bg-orb orb3"></div>
    </div>

    <div class="preview-topbar">
      <div class="preview-label">Live Preview</div>
      <div class="device-toggle">
        <button class="device-btn active" onclick="setDevice('mobile', this)">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>
          Mobile
        </button>
        <button class="device-btn" onclick="setDevice('desktop', this)">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
          Desktop
        </button>
      </div>
    </div>

    <div class="phone-frame-wrap">
      <div class="phone-frame" id="phoneFrame">
        <div class="phone-notch">
          <div class="notch-cam"></div>
          <div class="notch-pill"></div>
        </div>
        <div class="phone-screen theme-midnight" id="phoneScreen">
          <div class="profile-page" id="profilePage">
            <!-- Dynamic content rendered here -->
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Mobile FAB -->
<button class="mobile-edit-fab" onclick="openEditor()">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
</button>

<!-- Toast container -->
<div class="toast-container" id="toastContainer"></div>

<script>
// ===================== STATE =====================
const state = {
  slug: '',
  profile: {
    name: '',
    tagline: '',
    bio: '',
    initials: '',
    emoji: '',
    avatarStyle: 'initials',
    logoUrl: ''
  },
  theme: 'midnight',
  socials: [
    { id: 'whatsapp', label: 'WhatsApp', icon: '\ud83d\udcac', color: '#25D366', placeholder: '+1234567890', value: '', enabled: false },
    { id: 'instagram', label: 'Instagram', icon: '\ud83d\udcf8', color: '#E1306C', placeholder: '@username', value: '', enabled: false },
    { id: 'facebook', label: 'Facebook', icon: '\ud83d\udc4d', color: '#1877F2', placeholder: 'page url or name', value: '', enabled: false },
    { id: 'phone', label: 'Phone', icon: '\ud83d\udcde', color: '#34a853', placeholder: '+1234567890', value: '', enabled: false },
    { id: 'maps', label: 'Maps', icon: '\ud83d\udccd', color: '#EA4335', placeholder: 'address or coords', value: '', enabled: false },
    { id: 'website', label: 'Website', icon: '\ud83c\udf10', color: '#6c63ff', placeholder: 'https://...', value: '', enabled: false },
    { id: 'email', label: 'Email', icon: '\u2709\ufe0f', color: '#f59e0b', placeholder: 'email@domain.com', value: '', enabled: false },
    { id: 'tiktok', label: 'TikTok', icon: '\ud83c\udfb5', color: '#69C9D0', placeholder: '@username', value: '', enabled: false },
    { id: 'linkedin', label: 'LinkedIn', icon: '\ud83d\udcbc', color: '#0A66C2', placeholder: 'profile url', value: '', enabled: false },
    { id: 'youtube', label: 'YouTube', icon: '\u25b6\ufe0f', color: '#FF0000', placeholder: 'channel url', value: '', enabled: false },
  ],
  cards: [],
  cardLimit: 5
};

// Social href generators (kept separate since they can't be serialized to JSON)
const socialHrefs = {
  whatsapp: (v) => `https://wa.me/${v.replace(/\D/g,'')}`,
  instagram: (v) => `https://instagram.com/${v.replace('@','')}`,
  facebook: (v) => `https://facebook.com/${v}`,
  phone: (v) => `tel:${v}`,
  maps: (v) => `https://maps.google.com/?q=${encodeURIComponent(v)}`,
  website: (v) => v,
  email: (v) => `mailto:${v}`,
  tiktok: (v) => `https://tiktok.com/@${v.replace('@','')}`,
  linkedin: (v) => `https://linkedin.com/company/${v}`,
  youtube: (v) => `https://youtube.com/@${v}`,
};

const themes = [
  { id: 'midnight', label: 'Night', bg: 'linear-gradient(135deg,#080c14,#1a1a3e)' },
  { id: 'emerald', label: 'Forest', bg: 'linear-gradient(135deg,#050d0a,#0a2518)' },
  { id: 'crimson', label: 'Fire', bg: 'linear-gradient(135deg,#0d0507,#2d0a0a)' },
  { id: 'gold', label: 'Gold', bg: 'linear-gradient(135deg,#0a0800,#2a1f00)' },
  { id: 'ocean', label: 'Ocean', bg: 'linear-gradient(135deg,#020b12,#003350)' },
  { id: 'rose', label: 'Rose', bg: 'linear-gradient(135deg,#0d0408,#2d0520)' },
  { id: 'violet', label: 'Violet', bg: 'linear-gradient(135deg,#06040e,#1a0b30)' },
  { id: 'cyan', label: 'Cyan', bg: 'linear-gradient(135deg,#010c0e,#00282e)' },
  { id: 'slate', label: 'Slate', bg: 'linear-gradient(135deg,#0a0d12,#1a2030)' },
  { id: 'amber', label: 'Amber', bg: 'linear-gradient(135deg,#080600,#200f00)' },
  { id: 'neon_tokyo', label: 'Tokyo', bg: 'linear-gradient(135deg,#0a0014,#1a003a)' },
  { id: 'arctic', label: 'Arctic', bg: 'linear-gradient(135deg,#f0f4f8,#dce8f0)' },
  { id: 'sand_dune', label: 'Sand', bg: 'linear-gradient(135deg,#1a1208,#2d1f0a)' },
  { id: 'deep_space', label: 'Space', bg: 'linear-gradient(135deg,#010108,#050520)' },
  { id: 'sakura', label: 'Sakura', bg: 'linear-gradient(135deg,#1a0810,#2d0a18)' },
  { id: 'matrix', label: 'Matrix', bg: 'linear-gradient(135deg,#000800,#001200)' },
  { id: 'sunset', label: 'Sunset', bg: 'linear-gradient(135deg,#1a0500,#2d0a00)' },
  { id: 'nordic', label: 'Nordic', bg: 'linear-gradient(135deg,#080e18,#0d1628)' },
  { id: 'bubblegum', label: 'Bubblegum', bg: 'linear-gradient(135deg,#1a0818,#2d0828)' },
  { id: 'corporate', label: 'Corporate', bg: 'linear-gradient(135deg,#020810,#041020)' },
  { id: 'luxury', label: 'Luxury', bg: 'linear-gradient(135deg,#050505,#100f0f)' },
  { id: 'terracotta', label: 'Terra', bg: 'linear-gradient(135deg,#140a06,#201008)' },
  { id: 'mint', label: 'Mint', bg: 'linear-gradient(135deg,#030d08,#051810)' },
  { id: 'retrowave', label: 'Retro', bg: 'linear-gradient(135deg,#0a0018,#1a0030)' },
  { id: 'mono', label: 'Mono', bg: 'linear-gradient(135deg,#080808,#141414)' },
];

let cardIdCounter = 100;

// ===================== TOAST SYSTEM =====================
function showToast(message, type = 'info') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.textContent = message;
  container.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// ===================== API HELPERS =====================
async function api(path, options = {}) {
  const res = await fetch(path, {
    headers: { 'Content-Type': 'application/json', ...options.headers },
    credentials: 'same-origin',
    ...options,
  });
  const text = await res.text();
  let json;
  try { json = JSON.parse(text); } catch {
    throw new Error(res.ok ? 'Invalid server response' : `Request failed (${res.status})`);
  }
  if (!res.ok) {
    const err = new Error(json.error || 'Request failed');
    err.code = json.code;
    throw err;
  }
  return json.data;
}

// ===================== LOAD PROFILE =====================
async function loadProfile(slug) {
  try {
    const data = await api(`/api/profiles/${slug}`);
    state.slug = data.slug;
    state.profile.name = data.business_name || '';
    state.profile.tagline = data.tagline || '';
    state.profile.bio = data.bio || '';
    state.profile.initials = data.initials || '';
    state.profile.emoji = data.emoji || '';
    state.profile.avatarStyle = data.avatar_style || 'initials';
    state.profile.logoUrl = data.logo_url || '';
    state.theme = data.theme || 'midnight';

    // Merge saved socials into default template
    if (Array.isArray(data.socials)) {
      data.socials.forEach(saved => {
        const match = state.socials.find(s => s.id === saved.id);
        if (match) {
          match.value = saved.value || '';
          match.enabled = !!saved.enabled;
        }
      });
    }

    if (Array.isArray(data.cards)) {
      state.cards = data.cards;
      cardIdCounter = Math.max(100, ...state.cards.map(c => c.id || 0)) + 1;
    }

    state.cardLimit = data.card_limit || 5;

    // Populate form fields
    document.getElementById('bizSlug').value = state.slug;
    document.getElementById('bizName').value = state.profile.name;
    document.getElementById('bizTagline').value = state.profile.tagline;
    document.getElementById('bizBio').value = state.profile.bio;
    document.getElementById('bizInitials').value = state.profile.initials;
    document.getElementById('bizEmoji').value = state.profile.emoji;
    document.getElementById('avatarStyle').value = state.profile.avatarStyle;
    document.getElementById('emojiField').style.display = state.profile.avatarStyle === 'emoji' ? 'block' : 'none';

    // Update logo preview
    updateLogoPreview();

    // Update View Live link
    document.getElementById('viewLiveBtn').href = `/p/${state.slug}`;

    // Set theme on phone screen
    document.getElementById('phoneScreen').className = `phone-screen theme-${state.theme}`;

    renderThemeGrid();
    renderSocialsEditor();
    renderCardsEditor();
    renderProfile();
  } catch (err) {
    console.error('Failed to load profile:', err);
    showToast('Failed to load profile', 'error');
  }
}

// ===================== SAVE PROFILE =====================
async function saveProfile() {
  if (!state.slug) return showToast('No profile loaded', 'error');

  const btn = document.querySelector('.save-btn');
  btn.disabled = true;
  btn.textContent = 'Saving...';
  showToast('Saving...', 'info');

  try {
    // Strip non-serializable props from socials before saving
    const socialsToSave = state.socials.map(({ id, label, icon, color, placeholder, value, enabled }) => ({
      id, label, icon, color, placeholder, value, enabled
    }));

    await api(`/api/profiles/${state.slug}`, {
      method: 'PUT',
      body: JSON.stringify({
        business_name: state.profile.name,
        tagline: state.profile.tagline,
        bio: state.profile.bio,
        initials: state.profile.initials,
        emoji: state.profile.emoji,
        avatar_style: state.profile.avatarStyle,
        theme: state.theme,
        socials: socialsToSave,
        cards: state.cards,
      }),
    });

    showToast('Saved successfully', 'success');
  } catch (err) {
    console.error('Save error:', err);
    if (err.code === 'CARD_LIMIT_EXCEEDED') {
      showToast(`Card limit reached (${state.cardLimit} max)`, 'error');
    } else {
      showToast('Error saving: ' + err.message, 'error');
    }
  } finally {
    btn.disabled = false;
    btn.textContent = 'Save';
  }
}

// ===================== LOGO UPLOAD =====================
async function uploadLogo(file) {
  if (!file || !state.slug) return;

  showToast('Uploading logo...', 'info');

  try {
    const formData = new FormData();
    formData.append('logo', file);

    const res = await fetch(`/api/profiles/${state.slug}/logo`, {
      method: 'POST',
      credentials: 'same-origin',
      body: formData,
    });
    const json = await res.json();
    if (!res.ok) throw new Error(json.error || 'Upload failed');

    state.profile.logoUrl = json.data.logo_url;
    // Auto-switch avatar style to 'logo' so the uploaded image is visible
    state.profile.avatarStyle = 'logo';
    document.getElementById('avatarStyle').value = 'logo';
    document.getElementById('emojiField').style.display = 'none';
    updateLogoPreview();
    renderProfile();
    showToast('Logo uploaded', 'success');
  } catch (err) {
    console.error('Logo upload error:', err);
    showToast('Logo upload failed: ' + err.message, 'error');
  }
}

function updateLogoPreview() {
  const el = document.getElementById('logoPreview');
  if (state.profile.logoUrl) {
    el.innerHTML = `<img src="${state.profile.logoUrl}" alt="Logo">`;
  } else {
    el.innerHTML = '--';
  }
}

// ===================== TABS =====================
function switchTab(tab, btn) {
  document.querySelectorAll('.editor-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  ['profile', 'socials', 'cards', 'theme'].forEach(t => {
    document.getElementById('tab-' + t).style.display = t === tab ? 'block' : 'none';
  });
}

// ===================== THEME =====================
function renderThemeGrid() {
  const grid = document.getElementById('themeGrid');
  grid.innerHTML = themes.map(t => `
    <div class="theme-swatch ${t.id === state.theme ? 'active' : ''}"
         style="background:${t.bg}"
         onclick="setTheme('${t.id}')">
      <span style="${t.id === 'arctic' ? 'color:#1a2540' : ''}">${t.label}${t.id === 'arctic' ? ' ‚òÄ' : ''}</span>
    </div>
  `).join('');
}
function setTheme(id) {
  state.theme = id;
  const screen = document.getElementById('phoneScreen');
  screen.className = `phone-screen theme-${id}`;
  renderThemeGrid();
}

// ===================== SOCIALS EDITOR =====================
function renderSocialsEditor() {
  const list = document.getElementById('socialList');
  list.innerHTML = state.socials.map((s, i) => `
    <div class="social-item">
      <div class="social-item-icon" style="background:${s.color}22; font-size:16px;">${s.icon}</div>
      <input type="text"
             placeholder="${s.placeholder}"
             value="${s.value}"
             oninput="updateSocial(${i}, this.value)"
             style="color:${s.enabled ? 'var(--text)' : 'var(--text3)'}">
      <button class="social-toggle ${s.enabled ? 'on' : ''}" onclick="toggleSocial(${i})"></button>
    </div>
  `).join('');
}
function updateSocial(i, val) {
  state.socials[i].value = val;
  renderProfile();
}
function toggleSocial(i) {
  state.socials[i].enabled = !state.socials[i].enabled;
  renderSocialsEditor();
  renderProfile();
}

// ===================== CARDS EDITOR =====================
function updateCardCounter() {
  const count = state.cards.length;
  const limit = state.cardLimit;
  const counter = document.getElementById('cardCounter');
  const addBtn  = document.getElementById('addCardBtn');
  if (!counter) return;

  counter.textContent = `${count} / ${limit} cards`;
  counter.className   = 'card-counter ' + (count >= limit ? 'full' : count >= limit - 1 ? 'warn' : 'ok');

  if (addBtn) {
    const atLimit = count >= limit;
    addBtn.disabled = atLimit;
    addBtn.title    = atLimit ? 'Upgrade to add more cards' : '';
  }
}

function renderCardsEditor() {
  const list = document.getElementById('cardsEditorList');
  list.innerHTML = state.cards.map((card, i) => {
    const fields = getCardFields(card);
    return `
    <div class="card-editor-item">
      <div class="card-editor-header" onclick="toggleCardEditor(${card.id})">
        <div class="card-editor-drag" title="Drag to reorder">\u2807</div>
        <div class="card-editor-type-badge" style="${getCardBadgeStyle(card.type)}">${getCardTypeName(card.type)}</div>
        <div class="card-editor-name">${card.title}</div>
        <div class="move-btns">
          <button class="move-btn" onclick="event.stopPropagation();moveCard(${i},-1)">\u2191</button>
          <button class="move-btn" onclick="event.stopPropagation();moveCard(${i},1)">\u2193</button>
        </div>
        <div class="card-editor-toggle" id="chevron-${card.id}">\u25bc</div>
      </div>
      <div class="card-editor-body" id="card-body-${card.id}">
        ${fields}
        <div style="display:flex; justify-content:flex-end; margin-top:8px">
          <button class="delete-card-btn" onclick="deleteCard(${card.id})">\u2715 Remove</button>
        </div>
      </div>
    </div>
  `}).join('');
  updateCardCounter();
}
function getCardBadgeStyle(type) {
  const map = {
    link: 'background:rgba(108,99,255,0.2);color:#a78bfa',
    map: 'background:rgba(234,67,53,0.2);color:#f87171',
    website: 'background:rgba(14,165,233,0.2);color:#38bdf8',
    google: 'background:rgba(66,133,244,0.2);color:#60a5fa',
    cta: 'background:rgba(245,158,11,0.2);color:#fbbf24',
    text: 'background:rgba(16,185,129,0.2);color:#34d399',
    whatsapp: 'background:rgba(37,211,102,0.2);color:#4ade80',
    video: 'background:rgba(255,0,0,0.15);color:#f87171',
    image: 'background:rgba(168,85,247,0.2);color:#c084fc',
    image_grid: 'background:rgba(168,85,247,0.2);color:#c084fc',
    audio: 'background:rgba(30,215,96,0.2);color:#1ed760',
    pdf: 'background:rgba(239,68,68,0.2);color:#f87171',
    countdown: 'background:rgba(251,191,36,0.2);color:#fbbf24',
    rss_feed: 'background:rgba(251,146,60,0.2);color:#fb923c',
    contact_form: 'background:rgba(59,130,246,0.2);color:#60a5fa',
    email_capture: 'background:rgba(16,185,129,0.2);color:#34d399',
    poll: 'background:rgba(139,92,246,0.2);color:#a78bfa',
    faq: 'background:rgba(20,184,166,0.2);color:#2dd4bf',
    testimonial: 'background:rgba(244,114,182,0.2);color:#f472b6',
    product: 'background:rgba(245,158,11,0.2);color:#fbbf24',
    booking: 'background:rgba(59,130,246,0.2);color:#60a5fa',
    tip_jar: 'background:rgba(251,191,36,0.2);color:#fbbf24',
    instagram_post: 'background:rgba(228,64,95,0.2);color:#e4405f',
    tweet: 'background:rgba(29,155,240,0.2);color:#1d9bf0',
    tiktok_post: 'background:rgba(255,0,80,0.2);color:#ff0050',
    spotify: 'background:rgba(30,215,96,0.2);color:#1ed760',
  };
  return map[type] || map.link;
}
function getCardTypeName(type) {
  return type.charAt(0).toUpperCase() + type.slice(1);
}
function getCardFields(card) {
  const f = (label, id, val, type='text') => `
    <div class="field">
      <label>${label}</label>
      <input type="${type}" value="${val||''}" oninput="updateCardField(${card.id},'${id}',this.value)">
    </div>`;

  switch(card.type) {
    case 'link': return f('Title', 'title', card.title) + f('Icon (emoji)', 'icon', card.icon) + f('URL', 'url', card.url) + f('Subtitle', 'sub', card.sub);
    case 'map': return f('Title', 'title', card.title) + f('Google Maps Embed URL', 'embedUrl', card.embedUrl) + viewToggleField(card);
    case 'website': return f('Title', 'title', card.title) + f('URL', 'url', card.url) + viewToggleField(card);
    case 'google': return googleCardFields(card);
    case 'cta': return f('Title', 'title', card.title) + f('Badge Text', 'badge', card.badge) + f('Description', 'desc', card.desc) + f('Button Text', 'btnText', card.btnText) + f('URL', 'url', card.url);
    case 'text': return f('Title', 'title', card.title) + `<div class="field"><label>Content</label><textarea oninput="updateCardField(${card.id},'content',this.value)">${card.content||''}</textarea></div>`;
    case 'whatsapp': return f('Title', 'title', card.title) + f('Phone Number', 'phone', card.phone) + f('Pre-filled Message', 'message', card.message);
    case 'video': return f('Title', 'title', card.title) + f('YouTube Embed URL', 'url', card.url) + viewToggleField(card);
    case 'image': return f('Title (optional)', 'title', card.title) + f('Image URL', 'imageUrl', card.imageUrl) + f('Caption (optional)', 'caption', card.caption) + f('Link URL (optional)', 'linkUrl', card.linkUrl) + f('Alt Text', 'altText', card.altText);
    case 'image_grid': return f('Title', 'title', card.title) + selectField(card, 'Columns', 'columns', [['2','2 Columns'],['3','3 Columns']]) + f('Image 1 URL', 'image1Url', card.image1Url) + f('Image 1 Link', 'image1Link', card.image1Link) + f('Image 2 URL', 'image2Url', card.image2Url) + f('Image 2 Link', 'image2Link', card.image2Link) + f('Image 3 URL', 'image3Url', card.image3Url) + f('Image 3 Link', 'image3Link', card.image3Link);
    case 'audio': return f('Title', 'title', card.title) + selectField(card, 'Platform', 'platform', [['Spotify','Spotify'],['SoundCloud','SoundCloud'],['Direct URL','Direct URL']]) + f('Embed / Audio URL', 'embedUrl', card.embedUrl) + viewToggleField(card);
    case 'pdf': return f('Title', 'title', card.title) + f('PDF URL', 'pdfUrl', card.pdfUrl) + f('Description', 'description', card.description);
    case 'countdown': return f('Title', 'title', card.title) + f('Target Date', 'targetDate', card.targetDate, 'datetime-local') + f('Description', 'description', card.description) + f('Expired Text', 'expiredText', card.expiredText);
    case 'rss_feed': return f('Title', 'title', card.title) + f('RSS Feed URL', 'feedUrl', card.feedUrl) + selectField(card, 'Max Items', 'maxItems', [['3','3 items'],['5','5 items']]);
    case 'contact_form': return f('Title', 'title', card.title) + f('Recipient Email', 'recipientEmail', card.recipientEmail) + f('Success Message', 'successMessage', card.successMessage) + checkboxField(card, 'Show Phone Field', 'showPhone') + checkboxField(card, 'Show Message Field', 'showMessage') + viewToggleField(card);
    case 'email_capture': return f('Title', 'title', card.title) + f('Placeholder Text', 'placeholder', card.placeholder) + f('Button Text', 'buttonText', card.buttonText) + f('Webhook URL (optional)', 'webhookUrl', card.webhookUrl) + f('Success Message', 'successMessage', card.successMessage);
    case 'poll': return f('Question', 'question', card.question) + f('Option 1', 'option1', card.option1) + f('Option 2', 'option2', card.option2) + f('Option 3 (optional)', 'option3', card.option3) + f('Option 4 (optional)', 'option4', card.option4);
    case 'faq': return f('Title', 'title', card.title) + f('Question 1', 'q1', card.q1) + f('Answer 1', 'a1', card.a1) + f('Question 2', 'q2', card.q2) + f('Answer 2', 'a2', card.a2) + f('Question 3', 'q3', card.q3) + f('Answer 3', 'a3', card.a3) + f('Question 4', 'q4', card.q4) + f('Answer 4', 'a4', card.a4) + f('Question 5', 'q5', card.q5) + f('Answer 5', 'a5', card.a5);
    case 'testimonial': return `<div class="field"><label>Quote</label><textarea oninput="updateCardField(${card.id},'quote',this.value)">${card.quote||''}</textarea></div>` + f('Author Name', 'authorName', card.authorName) + f('Author Title', 'authorTitle', card.authorTitle) + f('Author Avatar URL (optional)', 'authorAvatarUrl', card.authorAvatarUrl) + selectField(card, 'Rating', 'rating', [['5','5 Stars'],['4','4 Stars'],['3','3 Stars'],['2','2 Stars'],['1','1 Star']]);
    case 'product': return f('Title', 'title', card.title) + f('Product Name', 'productName', card.productName) + f('Description', 'description', card.description) + f('Price', 'price', card.price) + selectField(card, 'Currency', 'currency', [['ZAR','ZAR'],['USD','USD'],['EUR','EUR'],['GBP','GBP']]) + f('Image URL', 'imageUrl', card.imageUrl) + f('Buy URL', 'buyUrl', card.buyUrl) + f('Badge (optional)', 'badge', card.badge);
    case 'booking': return f('Title', 'title', card.title) + selectField(card, 'Platform', 'platform', [['Calendly','Calendly'],['Cal.com','Cal.com'],['Custom','Custom']]) + f('Embed URL', 'embedUrl', card.embedUrl) + `<div class="field"><div class="field-hint">Paste the embed URL from your booking platform</div></div>` + f('Description', 'description', card.description) + viewToggleField(card);
    case 'tip_jar': return f('Title', 'title', card.title) + f('Description', 'description', card.description) + selectField(card, 'Platform', 'platform', [['PayPal','PayPal'],['Ko-fi','Ko-fi'],['Buy Me a Coffee','Buy Me a Coffee'],['Custom','Custom']]) + f('Payment URL', 'paymentUrl', card.paymentUrl) + f('Suggested Amounts (comma-separated)', 'suggestedAmounts', card.suggestedAmounts) + selectField(card, 'Currency', 'currency', [['USD','USD'],['ZAR','ZAR'],['EUR','EUR'],['GBP','GBP']]);
    case 'instagram_post': return f('Title', 'title', card.title) + f('Instagram Post URL', 'postUrl', card.postUrl) + `<div class="field"><div class="field-hint">Full embed requires Meta API token ‚Äî set INSTAGRAM_ACCESS_TOKEN in env.</div></div>` + viewToggleField(card);
    case 'tweet': return f('Title', 'title', card.title) + f('Tweet URL', 'tweetUrl', card.tweetUrl) + viewToggleField(card);
    case 'tiktok_post': return f('Title', 'title', card.title) + f('TikTok URL', 'tiktokUrl', card.tiktokUrl) + viewToggleField(card);
    case 'spotify': return f('Title', 'title', card.title) + f('Spotify URL', 'spotifyUrl', card.spotifyUrl) + checkboxField(card, 'Compact Mode', 'compact');
    default: return f('Title', 'title', card.title) + f('URL', 'url', card.url);
  }
}
function googleCardFields(card) {
  const f = (label, id, val, type='text', readonly=false) => `
    <div class="field">
      <label>${label}</label>
      <input type="${type}" value="${val||''}" ${readonly ? 'readonly style="opacity:0.7;cursor:not-allowed"' : ''} oninput="updateCardField(${card.id},'${id}',this.value)">
    </div>`;

  const linked = !!card.placeId;

  return `
    <div class="field">
      <label>Paste Google Maps URL or Business Name</label>
      <div style="display:flex;gap:6px">
        <input type="text" id="gbiz-search-${card.id}"
          placeholder="Paste Maps embed URL or type business name"
          value="${card.placeQuery||''}" style="flex:1"
          onkeydown="if(event.key==='Enter'){event.preventDefault();searchGooglePlace(${card.id})}">
        <button onclick="searchGooglePlace(${card.id})" style="background:var(--accent);color:white;border:none;border-radius:var(--radius-sm);padding:8px 14px;font-size:12px;font-weight:600;cursor:pointer;font-family:'Outfit',sans-serif;white-space:nowrap" id="gbiz-search-btn-${card.id}">Fetch</button>
      </div>
      <div style="font-size:10px;color:var(--text3);margin-top:4px">Tip: Copy your Google Maps embed URL and paste it here</div>
      <div id="gbiz-results-${card.id}" style="margin-top:6px"></div>
    </div>
    ${linked ? `<div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
      <span style="font-size:10px;color:var(--accent3)">&#10003; Linked to Google</span>
      <button onclick="unlinkGooglePlace(${card.id})" style="background:none;border:none;color:var(--text3);font-size:10px;cursor:pointer;text-decoration:underline">Unlink</button>
    </div>` : ''}
  ` + f('Title', 'title', card.title) +
    f('Business Name', 'biz', card.biz, 'text', linked) +
    f('Rating', 'rating', card.rating, 'text', linked) +
    f('Review Count', 'reviews', card.reviews, 'text', linked) +
    `<div class="field">
      <label>Google Review / Share URL</label>
      <input type="text" value="${card.url||''}" ${linked ? 'readonly style="opacity:0.7;cursor:not-allowed"' : ''} oninput="updateCardField(${card.id},'url',this.value)">
    </div>` +
    (linked ? `<div style="margin-bottom:10px">
      <button onclick="refreshGooglePlace(${card.id})" style="background:rgba(16,185,129,0.15);color:#34d399;border:1px solid rgba(16,185,129,0.3);border-radius:6px;padding:5px 12px;font-size:11px;font-weight:600;cursor:pointer;font-family:'Outfit',sans-serif">&#8635; Refresh ratings from Google</button>
    </div>` : '');
}

async function searchGooglePlace(cardId) {
  const input = document.getElementById('gbiz-search-' + cardId);
  const resultsDiv = document.getElementById('gbiz-results-' + cardId);
  const btn = document.getElementById('gbiz-search-btn-' + cardId);
  const query = input?.value?.trim();
  if (!query) return;

  btn.textContent = '...';
  btn.disabled = true;
  resultsDiv.innerHTML = '<div style="font-size:11px;color:var(--text3);padding:4px 0">Searching Google...</div>';

  try {
    const resp = await fetch('/api/google-place/search', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query })
    });
    const json = await resp.json();
    if (!resp.ok || json.error) {
      resultsDiv.innerHTML = `<div style="font-size:11px;color:#ef4444;padding:4px 0">${json.error || 'Search failed'}</div>`;
      return;
    }
    const places = json.data || [];
    if (places.length === 0) {
      resultsDiv.innerHTML = '<div style="font-size:11px;color:var(--text3);padding:4px 0">No results found</div>';
      return;
    }
    window._placeResults = { cardId, places };
    resultsDiv.innerHTML = '<div style="font-size:10px;color:var(--text3);margin-bottom:4px">Select your business:</div>' +
      places.map((p, i) => `
      <div onclick="pickGooglePlaceResult(${i})"
        style="padding:8px 10px;border-radius:8px;cursor:pointer;border:1px solid var(--border);margin-bottom:4px;transition:var(--transition)"
        onmouseover="this.style.borderColor='var(--accent)';this.style.background='rgba(108,99,255,0.06)'"
        onmouseout="this.style.borderColor='var(--border)';this.style.background='transparent'">
        <div style="font-size:13px;font-weight:600;color:var(--white)">${p.name}</div>
        <div style="font-size:11px;color:var(--text3)">${p.address || ''}</div>
        ${p.rating ? `<div style="font-size:11px;color:#f7c948;margin-top:2px">${'‚òÖ'.repeat(Math.round(p.rating))}${'‚òÜ'.repeat(5-Math.round(p.rating))} ${p.rating} (${p.reviewCount} reviews)</div>` : '<div style="font-size:11px;color:var(--text3);margin-top:2px">No ratings yet</div>'}
      </div>
    `).join('');
  } catch (err) {
    resultsDiv.innerHTML = `<div style="font-size:11px;color:#ef4444;padding:4px 0">Network error ‚Äî check your connection</div>`;
  } finally {
    btn.textContent = 'Fetch';
    btn.disabled = false;
  }
}

function pickGooglePlaceResult(index) {
  const r = window._placeResults;
  if (!r) return;
  const p = r.places[index];
  if (!p) return;
  selectGooglePlace(r.cardId, p.placeId, p.name, p.rating, p.reviewCount, p.mapsUrl);
}

function selectGooglePlace(cardId, placeId, name, rating, reviewCount, mapsUrl) {
  const card = state.cards.find(c => c.id === cardId);
  if (!card) return;
  card.placeId = placeId;
  card.placeQuery = name;
  card.biz = name;
  card.rating = rating != null ? String(rating) : '';
  card.reviews = reviewCount != null ? String(reviewCount) : '0';
  if (mapsUrl) card.url = mapsUrl;
  renderCardsEditor();
  renderProfile();
  showToast?.(`Linked to "${name}" ‚Äî ratings auto-filled!`, 'success');
}

function unlinkGooglePlace(cardId) {
  const card = state.cards.find(c => c.id === cardId);
  if (!card) return;
  card.placeId = '';
  card.placeQuery = '';
  renderCardsEditor();
}

async function refreshGooglePlace(cardId) {
  const card = state.cards.find(c => c.id === cardId);
  if (!card || !card.placeId) return;

  try {
    const resp = await fetch(`/api/google-place?placeId=${encodeURIComponent(card.placeId)}`);
    const json = await resp.json();
    if (!resp.ok || json.error) {
      showToast?.(json.error || 'Failed to fetch', 'error');
      return;
    }
    const d = json.data;
    card.biz = d.name || card.biz;
    card.rating = d.rating != null ? String(d.rating) : card.rating;
    card.reviews = d.reviewCount != null ? String(d.reviewCount) : card.reviews;
    if (d.mapsUrl) card.url = d.mapsUrl;
    renderCardsEditor();
    renderProfile();
    showToast?.('Ratings refreshed from Google!', 'success');
  } catch (err) {
    showToast?.('Failed to fetch Google data', 'error');
  }
}

function viewToggleField(card) {
  return `<div class="field">
    <label>Default View</label>
    <select onchange="updateCardField(${card.id},'view',this.value)">
      <option value="card" ${(card.view||'card')==='card'?'selected':''}>Card (collapsed)</option>
      <option value="embed" ${card.view==='embed'?'selected':''}>Embedded (expanded)</option>
    </select>
  </div>`;
}
function selectField(card, label, id, options) {
  return `<div class="field"><label>${label}</label><select onchange="updateCardField(${card.id},'${id}',this.value)">${options.map(([val, text]) => `<option value="${val}" ${(card[id]||'')=== val?'selected':''}>${text}</option>`).join('')}</select></div>`;
}
function checkboxField(card, label, id) {
  return `<div class="field" style="display:flex;align-items:center;gap:8px"><input type="checkbox" ${card[id] ? 'checked' : ''} onchange="updateCardField(${card.id},'${id}',this.checked)" style="width:auto"><label style="margin:0">${label}</label></div>`;
}
function toggleCardEditor(id) {
  const body = document.getElementById('card-body-' + id);
  const chev = document.getElementById('chevron-' + id);
  body.classList.toggle('open');
  chev.classList.toggle('open');
}
function updateCardField(id, field, val) {
  const card = state.cards.find(c => c.id === id);
  if (card) {
    card[field] = val;
    renderProfile();
    // Only update the header title inline ‚Äî do NOT re-render the whole editor,
    // because that destroys DOM focus and closes the card body mid-typing.
    if (field === 'title') {
      const item = document.querySelector(`#card-body-${id}`)?.parentElement;
      if (item) {
        const nameEl = item.querySelector('.card-editor-name');
        if (nameEl) nameEl.textContent = val;
      }
    }
  }
}
function deleteCard(id) {
  state.cards = state.cards.filter(c => c.id !== id);
  renderCardsEditor(); renderProfile();
}
function moveCard(i, dir) {
  const j = i + dir;
  if (j < 0 || j >= state.cards.length) return;
  [state.cards[i], state.cards[j]] = [state.cards[j], state.cards[i]];
  renderCardsEditor(); renderProfile();
}
function toggleCardTypeMenu() {
  document.getElementById('cardTypeMenu').classList.toggle('open');
}
function addCard(type) {
  if (state.cards.length >= state.cardLimit) {
    showToast(`Card limit reached (${state.cardLimit} max)`, 'error');
    document.getElementById('cardTypeMenu').classList.remove('open');
    return;
  }
  cardIdCounter++;
  const defaults = {
    link: { title: 'New Link', sub: 'Click to visit', icon: '\ud83d\udd17', url: 'https://', view: 'card' },
    map: { title: 'Our Location', embedUrl: '', view: 'card' },
    website: { title: 'Our Website', url: 'https://example.com', view: 'card' },
    google: { title: 'Review Us', biz: state.profile.name, rating: '', reviews: '', url: '', placeId: '', placeQuery: '' },
    cta: { title: 'Special Offer', badge: '\u26a1 Limited Time', desc: 'Describe your offer here.', btnText: 'Learn More', url: 'https://' },
    text: { title: 'About Us', content: 'Write something here...' },
    whatsapp: { title: 'Chat on WhatsApp', sub: 'We reply instantly', phone: '', message: 'Hi, I found you via QR code' },
    video: { title: 'Watch Our Video', url: 'https://www.youtube.com/embed/dQw4w9WgXcQ', view: 'card' },
    image: { title: '', imageUrl: '', caption: '', linkUrl: '', altText: '' },
    image_grid: { title: 'Image Grid', columns: '2', image1Url: '', image1Link: '', image2Url: '', image2Link: '', image3Url: '', image3Link: '' },
    audio: { title: 'Listen', platform: 'Spotify', embedUrl: '', view: 'card' },
    pdf: { title: 'Download PDF', pdfUrl: '', description: '' },
    countdown: { title: 'Coming Soon', targetDate: '', description: '', expiredText: 'This event has ended' },
    rss_feed: { title: 'Latest Posts', feedUrl: '', maxItems: '3' },
    contact_form: { title: 'Contact Us', recipientEmail: '', successMessage: 'Thanks! We\'ll be in touch.', showPhone: true, showMessage: true, view: 'card' },
    email_capture: { title: 'Stay Updated', placeholder: 'Enter your email', buttonText: 'Subscribe', webhookUrl: '', successMessage: 'Thanks for subscribing!' },
    poll: { title: 'Quick Poll', question: 'What do you think?', option1: 'Option A', option2: 'Option B', option3: '', option4: '' },
    faq: { title: 'FAQ', q1: 'Question 1?', a1: 'Answer 1', q2: '', a2: '', q3: '', a3: '', q4: '', a4: '', q5: '', a5: '' },
    testimonial: { title: 'Testimonial', quote: 'Amazing service!', authorName: 'Happy Customer', authorTitle: 'Client', authorAvatarUrl: '', rating: '5' },
    product: { title: 'Product', productName: 'Product Name', description: 'Product description', price: '99', currency: 'ZAR', imageUrl: '', buyUrl: '', badge: '' },
    booking: { title: 'Book a Session', platform: 'Calendly', embedUrl: '', description: 'Schedule a time that works for you', view: 'card' },
    tip_jar: { title: 'Support Us', description: 'Buy us a coffee!', platform: 'Buy Me a Coffee', paymentUrl: '', suggestedAmounts: '5,10,25', currency: 'USD' },
    instagram_post: { title: 'Instagram', postUrl: '', view: 'card' },
    tweet: { title: 'Tweet', tweetUrl: '', view: 'card' },
    tiktok_post: { title: 'TikTok', tiktokUrl: '', view: 'card' },
    spotify: { title: 'Listen on Spotify', spotifyUrl: '', compact: false },
  };
  state.cards.push({ id: cardIdCounter, type, ...defaults[type] });
  document.getElementById('cardTypeMenu').classList.remove('open');
  renderCardsEditor(); renderProfile();
}

// ===================== PROFILE UPDATE =====================
function updateProfile() {
  state.profile.name = document.getElementById('bizName').value;
  state.profile.tagline = document.getElementById('bizTagline').value;
  state.profile.bio = document.getElementById('bizBio').value;
  state.profile.initials = document.getElementById('bizInitials').value;
  const avatarStyle = document.getElementById('avatarStyle').value;
  state.profile.avatarStyle = avatarStyle;
  document.getElementById('emojiField').style.display = avatarStyle === 'emoji' ? 'block' : 'none';
  if (avatarStyle === 'emoji') state.profile.emoji = document.getElementById('bizEmoji').value;
  renderProfile();
}

// ===================== RENDER PROFILE =====================
function renderProfile() {
  const { name, tagline, bio, initials, emoji, avatarStyle, logoUrl } = state.profile;
  const activeSocials = state.socials.filter(s => s.enabled && s.value);

  let avatarContent;
  if (avatarStyle === 'logo' && logoUrl) {
    avatarContent = `<img class="avatar-img" src="${logoUrl}" alt="${name}">`;
  } else if (avatarStyle === 'emoji') {
    avatarContent = emoji;
  } else {
    avatarContent = initials;
  }

  const socialPills = activeSocials.map(s => {
    const href = socialHrefs[s.id] ? socialHrefs[s.id](s.value) : '#';
    return `
    <a class="social-pill" href="${href}" target="_blank">
      <span class="social-pill-icon">${s.icon}</span>
      <span class="social-pill-label">${s.label}</span>
    </a>
  `}).join('');

  const cards = state.cards.map(renderCard).join('');

  document.getElementById('profilePage').innerHTML = `
    <div class="profile-hero">
      <div class="profile-hero-bg"></div>
      <div class="profile-hero-mesh"></div>
      <div class="avatar-ring">
        <div class="avatar-wrap">${avatarContent}</div>
      </div>
      <div class="profile-name">${name}</div>
      <div class="profile-tagline">${tagline}</div>
      <p class="profile-bio">${bio}</p>
      <div class="verified-badge">
        <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><path d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/></svg>
        Verified Business
      </div>
    </div>
    <div class="social-strip">${socialPills}</div>
    <div class="cards-container">${cards}</div>
    <div class="profile-footer">
      <a class="powered-by" href="#">Powered by <span class="powered-by-logo">QR<span>Profile</span></span></a>
    </div>
  `;
}

function renderCard(card) {
  switch(card.type) {
    case 'link': return renderLinkCard(card);
    case 'whatsapp': return renderWhatsappCard(card);
    case 'map': return renderMapCard(card);
    case 'website': return renderWebsiteCard(card);
    case 'google': return renderGoogleCard(card);
    case 'cta': return renderCtaCard(card);
    case 'text': return renderTextCard(card);
    case 'video': return renderVideoCard(card);
    case 'image': return renderImageCard(card);
    case 'image_grid': return renderImageGridCard(card);
    case 'audio': return renderAudioCard(card);
    case 'pdf': return renderPdfCard(card);
    case 'countdown': return renderCountdownCard(card);
    case 'rss_feed': return renderRssFeedCard(card);
    case 'contact_form': return renderContactFormCard(card);
    case 'email_capture': return renderEmailCaptureCard(card);
    case 'poll': return renderPollCard(card);
    case 'faq': return renderFaqCard(card);
    case 'testimonial': return renderTestimonialCard(card);
    case 'product': return renderProductCard(card);
    case 'booking': return renderBookingCard(card);
    case 'tip_jar': return renderTipJarCard(card);
    case 'instagram_post': return renderInstagramCard(card);
    case 'tweet': return renderTweetCard(card);
    case 'tiktok_post': return renderTiktokCard(card);
    case 'spotify': return renderSpotifyCard(card);
    default: return renderLinkCard(card);
  }
}

function renderLinkCard(card) {
  return `<div class="qr-card">
    <a class="card-link" href="${card.url||'#'}" target="_blank">
      <div class="card-link-icon" style="background:rgba(108,99,255,0.15)">${card.icon||'\ud83d\udd17'}</div>
      <div class="card-link-content">
        <div class="card-link-title">${card.title}</div>
        <div class="card-link-sub">${card.sub||card.url||''}</div>
      </div>
      <div class="card-link-arrow"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg></div>
    </a>
  </div>`;
}

function renderWhatsappCard(card) {
  const href = `https://wa.me/${(card.phone||'').replace(/\D/g,'')}?text=${encodeURIComponent(card.message||'')}`;
  return `<div class="qr-card" style="background:linear-gradient(135deg,rgba(18,140,50,0.15),rgba(37,211,102,0.08));border-color:rgba(37,211,102,0.15)">
    <a class="card-link" href="${href}" target="_blank">
      <div class="card-link-icon" style="background:rgba(37,211,102,0.15);font-size:22px">\ud83d\udcac</div>
      <div class="card-link-content">
        <div class="card-link-title">${card.title}</div>
        <div class="card-link-sub">${card.message||'Send a message'}</div>
      </div>
      <div class="card-link-arrow" style="color:#4ade80"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg></div>
    </a>
  </div>`;
}

function renderMapCard(card) {
  const isEmbed = card.view === 'embed';
  const embedSrc = card.embedUrl || '';
  const hasEmbed = embedSrc.includes('google.com/maps');
  return `<div class="qr-card">
    <button class="card-expand-btn ${isEmbed?'expanded':''}" onclick="toggleEmbed(this)">
      <div class="card-link-icon" style="background:rgba(234,67,53,0.15);font-size:20px">\ud83d\udccd</div>
      <div class="card-expand-label">
        <div class="card-expand-title">${card.title}</div>
        <div class="card-expand-sub">${hasEmbed ? 'Map embedded' : 'Add embed URL'}</div>
      </div>
      <div class="card-expand-chevron"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg></div>
    </button>
    <div class="card-embed-area ${isEmbed?'open':''}">
      ${hasEmbed
        ? `<iframe src="${embedSrc}" class="map-embed-frame" allowfullscreen loading="lazy"></iframe>`
        : `<div style="padding:24px 18px;text-align:center;color:var(--text3);font-size:13px">Paste a Google Maps embed URL to show the map</div>`}
    </div>
  </div>`;
}

function renderWebsiteCard(card) {
  const isEmbed = card.view === 'embed';
  return `<div class="qr-card">
    <button class="card-expand-btn ${isEmbed?'expanded':''}" onclick="toggleEmbed(this)">
      <div class="card-link-icon" style="background:rgba(14,165,233,0.15);font-size:20px">\ud83c\udf10</div>
      <div class="card-expand-label">
        <div class="card-expand-title">${card.title}</div>
        <div class="card-expand-sub">${card.url||'Set URL'}</div>
      </div>
      <div class="card-expand-chevron"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg></div>
    </button>
    <div class="card-embed-area ${isEmbed?'open':''}">
      <div class="website-preview-bar">
        <div class="browser-dots2">
          <div class="browser-dot2" style="background:#ff5f57"></div>
          <div class="browser-dot2" style="background:#febc2e"></div>
          <div class="browser-dot2" style="background:#28c840"></div>
        </div>
        <div class="url-bar">${card.url||'https://'}</div>
      </div>
      <div class="website-preview-placeholder">
        <div class="site-name">${card.title}</div>
        <div class="site-url">${card.url||'your-website.com'}</div>
      </div>
      <div style="padding:10px 18px;display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,0.02);border-top:1px solid rgba(255,255,255,0.05)">
        <span style="font-size:11px;color:var(--text3)">Preview</span>
        <a href="${card.url}" target="_blank" style="font-size:12px;font-weight:600;color:#38bdf8;text-decoration:none">Visit \u2192</a>
      </div>
    </div>
  </div>`;
}

function renderGoogleCard(card) {
  const stars = '\u2605'.repeat(Math.round(parseFloat(card.rating||5))).padEnd(5,'\u2606');
  return `<div class="qr-card">
    <div class="gbiz-inner">
      <div class="gbiz-brand-row">
        <div class="gbiz-g-icon">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
        </div>
        <div>
          <div class="gbiz-biz-name">${card.biz||card.title}</div>
          <div class="gbiz-biz-cat">Google Business Profile</div>
        </div>
      </div>
      <div class="gbiz-stats-row">
        <div class="gbiz-stat">
          <div class="gbiz-stat-val">${card.rating||'5.0'}</div>
          <div class="gbiz-stat-label">Rating</div>
        </div>
        <div class="gbiz-divider"></div>
        <div class="gbiz-stat">
          <div class="stars2">${[...stars].map(s=>`<span class="star2">${s}</span>`).join('')}</div>
        </div>
        <div class="gbiz-divider"></div>
        <div class="gbiz-stat">
          <div class="gbiz-stat-val">${card.reviews||'0'}</div>
          <div class="gbiz-stat-label">Reviews</div>
        </div>
      </div>
    </div>
    <div class="gbiz-actions">
      <a href="${card.url||'#'}" target="_blank" class="gbiz-action-btn gbiz-action-primary" style="text-align:center;text-decoration:none;display:block;">Write a Review</a>
      <a href="${card.url||'#'}" target="_blank" class="gbiz-action-btn gbiz-action-secondary" style="text-align:center;text-decoration:none;display:block;">View Profile</a>
    </div>
  </div>`;
}

function renderCtaCard(card) {
  return `<div class="qr-card">
    <div class="cta-card">
      <div class="cta-badge">${card.badge||'\u26a1 Offer'}</div>
      <div class="cta-title">${card.title}</div>
      <div class="cta-desc">${card.desc||''}</div>
      <a href="${card.url||'#'}" target="_blank" class="cta-action">${card.btnText||'Learn More'} <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg></a>
    </div>
  </div>`;
}

function renderTextCard(card) {
  return `<div class="qr-card">
    <div style="padding:20px 18px;background:rgba(255,255,255,0.04)">
      <div style="font-family:'Syne',sans-serif;font-size:15px;font-weight:700;color:var(--white);margin-bottom:8px">${card.title}</div>
      <div style="font-size:13px;color:var(--text2);line-height:1.7">${card.content||''}</div>
    </div>
  </div>`;
}

function renderVideoCard(card) {
  const isEmbed = card.view === 'embed';
  return `<div class="qr-card">
    <button class="card-expand-btn ${isEmbed?'expanded':''}" onclick="toggleEmbed(this)">
      <div class="card-link-icon" style="background:rgba(255,0,0,0.12);font-size:20px">\u25b6\ufe0f</div>
      <div class="card-expand-label">
        <div class="card-expand-title">${card.title}</div>
        <div class="card-expand-sub">YouTube Video</div>
      </div>
      <div class="card-expand-chevron"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg></div>
    </button>
    <div class="card-embed-area ${isEmbed?'open':''}">
      <iframe src="${card.url||''}" height="200" allowfullscreen style="width:100%;border:none;display:block"></iframe>
    </div>
  </div>`;
}

function renderImageCard(card) {
  const inner = `<div class="qr-card" style="padding:0;overflow:hidden">
    ${card.imageUrl ? `<img src="${card.imageUrl}" alt="${card.altText||card.title||''}" style="width:100%;max-height:220px;object-fit:cover;display:block">` : '<div style="height:120px;background:rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;color:var(--text3);font-size:13px">No image set</div>'}
    ${card.caption || card.title ? `<div style="padding:12px 16px">${card.title ? `<div style="font-weight:600;font-size:14px;color:var(--white);margin-bottom:4px">${card.title}</div>` : ''}${card.caption ? `<div style="font-size:12px;color:var(--text2)">${card.caption}</div>` : ''}</div>` : ''}
  </div>`;
  return card.linkUrl ? `<a href="${card.linkUrl}" target="_blank" style="text-decoration:none">${inner}</a>` : inner;
}

function renderImageGridCard(card) {
  const cols = parseInt(card.columns) || 2;
  const images = [
    { url: card.image1Url, link: card.image1Link },
    { url: card.image2Url, link: card.image2Link },
    { url: card.image3Url, link: card.image3Link },
  ].slice(0, cols);
  return `<div class="qr-card">
    ${card.title ? `<div style="padding:12px 16px 8px;font-weight:600;font-size:14px;color:var(--white)">${card.title}</div>` : ''}
    <div style="display:grid;grid-template-columns:repeat(${cols},1fr);gap:6px;padding:8px 12px 12px">
      ${images.map(img => {
        const imgEl = img.url ? `<img src="${img.url}" alt="" style="width:100%;aspect-ratio:1;object-fit:cover;border-radius:8px;display:block">` : `<div style="width:100%;aspect-ratio:1;background:rgba(255,255,255,0.04);border-radius:8px;display:flex;align-items:center;justify-content:center;color:var(--text3);font-size:11px">No image</div>`;
        return img.link ? `<a href="${img.link}" target="_blank">${imgEl}</a>` : imgEl;
      }).join('')}
    </div>
  </div>`;
}

function renderAudioCard(card) {
  const isEmbed = card.view === 'embed';
  let embedContent = '';
  if (card.platform === 'Spotify' && card.embedUrl) {
    const src = card.embedUrl.includes('/embed/') ? card.embedUrl : card.embedUrl.replace('open.spotify.com/', 'open.spotify.com/embed/');
    embedContent = `<iframe src="${src}?theme=0" height="152" style="width:100%;border:none;border-radius:12px" allow="autoplay;clipboard-write;encrypted-media" loading="lazy"></iframe>`;
  } else if (card.platform === 'SoundCloud' && card.embedUrl) {
    embedContent = `<iframe src="${card.embedUrl}" height="166" style="width:100%;border:none" loading="lazy"></iframe>`;
  } else if (card.embedUrl) {
    embedContent = `<audio controls src="${card.embedUrl}" style="width:100%;margin:12px 0;filter:invert(0.85)"></audio>`;
  } else {
    embedContent = '<div style="padding:18px;text-align:center;color:var(--text3);font-size:12px">Set an audio URL</div>';
  }
  return `<div class="qr-card">
    <button class="card-expand-btn ${isEmbed?'expanded':''}" onclick="toggleEmbed(this)">
      <div class="card-link-icon" style="background:rgba(30,215,96,0.15);font-size:20px">üéµ</div>
      <div class="card-expand-label"><div class="card-expand-title">${card.title}</div><div class="card-expand-sub">${card.platform||'Audio'}</div></div>
      <div class="card-expand-chevron"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg></div>
    </button>
    <div class="card-embed-area ${isEmbed?'open':''}" style="padding:8px">${embedContent}</div>
  </div>`;
}

function renderPdfCard(card) {
  return `<div class="qr-card">
    <a class="card-link" href="${card.pdfUrl||'#'}" target="_blank" style="text-decoration:none">
      <div class="card-link-icon" style="background:rgba(239,68,68,0.15);font-size:22px">üìÑ</div>
      <div class="card-link-content">
        <div class="card-link-title">${card.title}</div>
        <div class="card-link-sub">${card.description||'Open PDF ‚Üí'}</div>
      </div>
      <div class="card-link-arrow"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg></div>
    </a>
  </div>`;
}

function renderCountdownCard(card) {
  const cid = 'countdown-' + card.id;
  setTimeout(() => startCountdown(cid, card.targetDate, card.expiredText || 'Expired'), 50);
  return `<div class="qr-card">
    <div style="padding:18px;text-align:center">
      ${card.title ? `<div style="font-family:'Syne',sans-serif;font-size:15px;font-weight:700;color:var(--white);margin-bottom:6px">${card.title}</div>` : ''}
      ${card.description ? `<div style="font-size:12px;color:var(--text2);margin-bottom:12px">${card.description}</div>` : ''}
      <div id="${cid}" style="display:flex;gap:8px;justify-content:center">
        <div style="background:var(--accent-color,var(--accent));border-radius:8px;padding:10px 12px;min-width:52px"><div style="font-size:22px;font-weight:700;font-family:monospace;color:#000">--</div><div style="font-size:9px;color:rgba(0,0,0,0.6);margin-top:2px">DAYS</div></div>
        <div style="background:var(--accent-color,var(--accent));border-radius:8px;padding:10px 12px;min-width:52px"><div style="font-size:22px;font-weight:700;font-family:monospace;color:#000">--</div><div style="font-size:9px;color:rgba(0,0,0,0.6);margin-top:2px">HRS</div></div>
        <div style="background:var(--accent-color,var(--accent));border-radius:8px;padding:10px 12px;min-width:52px"><div style="font-size:22px;font-weight:700;font-family:monospace;color:#000">--</div><div style="font-size:9px;color:rgba(0,0,0,0.6);margin-top:2px">MIN</div></div>
        <div style="background:var(--accent-color,var(--accent));border-radius:8px;padding:10px 12px;min-width:52px"><div style="font-size:22px;font-weight:700;font-family:monospace;color:#000">--</div><div style="font-size:9px;color:rgba(0,0,0,0.6);margin-top:2px">SEC</div></div>
      </div>
    </div>
  </div>`;
}
window._countdownTimers = {};
function startCountdown(elemId, targetDate, expiredText) {
  if (window._countdownTimers[elemId]) clearInterval(window._countdownTimers[elemId]);
  if (!targetDate) return;
  const target = new Date(targetDate).getTime();
  function tick() {
    const el = document.getElementById(elemId);
    if (!el) { clearInterval(window._countdownTimers[elemId]); return; }
    const diff = target - Date.now();
    if (diff <= 0) {
      el.innerHTML = `<div style="font-size:14px;color:var(--text2)">${expiredText}</div>`;
      clearInterval(window._countdownTimers[elemId]);
      return;
    }
    const d = Math.floor(diff/86400000), h = Math.floor((diff%86400000)/3600000), m = Math.floor((diff%3600000)/60000), s = Math.floor((diff%60000)/1000);
    const box = (v, l) => `<div style="background:var(--accent-color,var(--accent));border-radius:8px;padding:10px 12px;min-width:52px"><div style="font-size:22px;font-weight:700;font-family:monospace;color:#000">${String(v).padStart(2,'0')}</div><div style="font-size:9px;color:rgba(0,0,0,0.6);margin-top:2px">${l}</div></div>`;
    el.innerHTML = box(d,'DAYS') + box(h,'HRS') + box(m,'MIN') + box(s,'SEC');
  }
  tick();
  window._countdownTimers[elemId] = setInterval(tick, 1000);
}

function renderRssFeedCard(card) {
  const cid = 'rss-' + card.id;
  if (card.feedUrl) {
    setTimeout(() => loadRssFeed(cid, card.feedUrl, parseInt(card.maxItems)||3), 50);
  }
  return `<div class="qr-card">
    <div style="padding:16px 18px">
      <div style="font-family:'Syne',sans-serif;font-size:15px;font-weight:700;color:var(--white);margin-bottom:12px">${card.title}</div>
      <div id="${cid}">
        ${[1,2,3].map(() => '<div style="height:18px;background:rgba(255,255,255,0.06);border-radius:6px;margin-bottom:8px;animation:shimmer 1.5s infinite"></div>').join('')}
      </div>
    </div>
  </div>`;
}
window.__rssCache = {};
async function loadRssFeed(elemId, feedUrl, maxItems) {
  const el = document.getElementById(elemId);
  if (!el) return;
  if (window.__rssCache[feedUrl]) {
    renderRssItems(el, window.__rssCache[feedUrl], maxItems);
    return;
  }
  try {
    const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feedUrl)}`);
    const data = await res.json();
    if (data.items) {
      window.__rssCache[feedUrl] = data.items;
      renderRssItems(el, data.items, maxItems);
    } else {
      el.innerHTML = '<div style="font-size:12px;color:var(--text3)">Could not load feed</div>';
    }
  } catch {
    el.innerHTML = '<div style="font-size:12px;color:var(--text3)">Failed to load RSS feed</div>';
  }
}
function renderRssItems(el, items, max) {
  el.innerHTML = items.slice(0, max).map(item => {
    const date = item.pubDate ? new Date(item.pubDate).toLocaleDateString() : '';
    return `<a href="${item.link||'#'}" target="_blank" style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.05);text-decoration:none">
      <div style="font-size:14px">üì∞</div>
      <div style="flex:1;min-width:0"><div style="font-size:12px;font-weight:500;color:var(--white);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${item.title||''}</div><div style="font-size:10px;color:var(--text3)">${date}</div></div>
    </a>`;
  }).join('');
}

function renderContactFormCard(card) {
  const isEmbed = card.view === 'embed';
  return `<div class="qr-card">
    <button class="card-expand-btn ${isEmbed?'expanded':''}" onclick="toggleEmbed(this)">
      <div class="card-link-icon" style="background:rgba(59,130,246,0.15);font-size:20px">üì¨</div>
      <div class="card-expand-label"><div class="card-expand-title">${card.title}</div><div class="card-expand-sub">Contact form</div></div>
      <div class="card-expand-chevron"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg></div>
    </button>
    <div class="card-embed-area ${isEmbed?'open':''}">
      <form onsubmit="submitContactForm(event,${card.id})" style="padding:16px">
        <div style="margin-bottom:10px"><input type="text" placeholder="Your Name" required style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:var(--white);font-size:13px;font-family:'Outfit',sans-serif"></div>
        <div style="margin-bottom:10px"><input type="email" placeholder="Your Email" required style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:var(--white);font-size:13px;font-family:'Outfit',sans-serif"></div>
        ${card.showPhone ? `<div style="margin-bottom:10px"><input type="tel" placeholder="Phone" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:var(--white);font-size:13px;font-family:'Outfit',sans-serif"></div>` : ''}
        ${card.showMessage ? `<div style="margin-bottom:10px"><textarea placeholder="Message" rows="3" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:var(--white);font-size:13px;font-family:'Outfit',sans-serif;resize:vertical"></textarea></div>` : ''}
        <button type="submit" style="width:100%;padding:10px;background:var(--accent-color,var(--accent));color:white;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;font-family:'Outfit',sans-serif">Send Message</button>
        <div id="contact-msg-${card.id}" style="margin-top:8px;font-size:12px;text-align:center"></div>
      </form>
    </div>
  </div>`;
}
async function submitContactForm(e, cardId) {
  e.preventDefault();
  const card = state.cards.find(c => c.id === cardId);
  if (!card) return;
  const form = e.target;
  const inputs = form.querySelectorAll('input, textarea');
  const formData = {};
  inputs.forEach(el => { if (el.placeholder) formData[el.placeholder.toLowerCase().replace(/\s/g,'')] = el.value; });
  formData.name = formData.yourname || '';
  formData.email = formData.youremail || '';
  const msgEl = document.getElementById('contact-msg-' + cardId);
  try {
    const res = await fetch('/api/forms/contact', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ profileSlug: state.slug, recipientEmail: card.recipientEmail, formData })
    });
    if (res.ok) {
      msgEl.style.color = 'var(--accent3)';
      msgEl.textContent = card.successMessage || 'Sent!';
      form.reset();
    } else {
      msgEl.style.color = '#ef4444';
      msgEl.textContent = 'Something went wrong, please try again.';
    }
  } catch {
    msgEl.style.color = '#ef4444';
    msgEl.textContent = 'Something went wrong, please try again.';
  }
}

function renderEmailCaptureCard(card) {
  return `<div class="qr-card">
    <div style="padding:18px">
      <div style="font-family:'Syne',sans-serif;font-size:15px;font-weight:700;color:var(--white);margin-bottom:10px">${card.title}</div>
      <form onsubmit="submitEmailCapture(event,${card.id})" style="display:flex;gap:8px">
        <input type="email" placeholder="${card.placeholder||'Enter your email'}" required style="flex:1;padding:10px 12px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:var(--white);font-size:13px;font-family:'Outfit',sans-serif">
        <button type="submit" style="padding:10px 16px;background:var(--accent-color,var(--accent));color:white;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;font-family:'Outfit',sans-serif;white-space:nowrap">${card.buttonText||'Subscribe'}</button>
      </form>
      <div id="email-msg-${card.id}" style="margin-top:8px;font-size:12px;text-align:center"></div>
    </div>
  </div>`;
}
async function submitEmailCapture(e, cardId) {
  e.preventDefault();
  const card = state.cards.find(c => c.id === cardId);
  if (!card) return;
  const email = e.target.querySelector('input[type="email"]').value;
  const msgEl = document.getElementById('email-msg-' + cardId);
  const btn = e.target.querySelector('button[type="submit"]');
  btn.disabled = true;
  btn.textContent = '...';
  try {
    const res = await fetch('/api/forms/subscribe', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ profileSlug: state.slug, cardId: String(cardId), email })
    });
    if (!res.ok) {
      const d = await res.json().catch(() => ({}));
      msgEl.style.color = '#ef4444';
      msgEl.textContent = d.error || 'Something went wrong, please try again.';
      return;
    }
    if (card.webhookUrl) {
      try {
        await fetch(card.webhookUrl, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, slug: state.slug, timestamp: new Date().toISOString() })
        });
      } catch { /* webhook fire-and-forget */ }
    }
    msgEl.style.color = 'var(--accent3)';
    msgEl.textContent = card.successMessage || 'Thanks!';
    e.target.reset();
  } catch {
    msgEl.style.color = '#ef4444';
    msgEl.textContent = 'Something went wrong, please try again.';
  } finally {
    btn.disabled = false;
    btn.textContent = card.buttonText || 'Subscribe';
  }
}

function renderPollCard(card) {
  const options = [card.option1, card.option2, card.option3, card.option4].filter(Boolean);
  const voted = localStorage.getItem('poll-voted-' + card.id);
  const cid = 'poll-' + card.id;
  if (voted) {
    setTimeout(() => loadPollResults(cid, card.id, options), 50);
  }
  return `<div class="qr-card">
    <div style="padding:18px">
      <div style="font-family:'Syne',sans-serif;font-size:15px;font-weight:700;color:var(--white);margin-bottom:12px">${card.question||card.title}</div>
      <div id="${cid}">
        ${voted ? options.map(() => '<div style="height:36px;background:rgba(255,255,255,0.04);border-radius:8px;margin-bottom:6px"></div>').join('') : options.map((opt, i) => `<button onclick="castPollVote(${card.id},${i})" style="width:100%;padding:10px 14px;margin-bottom:6px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:var(--white);font-size:13px;cursor:pointer;text-align:left;font-family:'Outfit',sans-serif;transition:var(--transition)" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.1)'">${opt}</button>`).join('')}
      </div>
    </div>
  </div>`;
}
async function castPollVote(cardId, optionIndex) {
  const card = state.cards.find(c => c.id === cardId);
  if (!card) return;
  const options = [card.option1, card.option2, card.option3, card.option4].filter(Boolean);
  try {
    const res = await fetch('/api/polls/vote', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ slug: state.slug, cardId: String(cardId), optionIndex })
    });
    if (res.ok) {
      localStorage.setItem('poll-voted-' + cardId, '1');
      const { data } = await res.json();
      showPollResults('poll-' + cardId, options, data.counts);
    }
  } catch { /* silent */ }
}
async function loadPollResults(elemId, cardId, options) {
  try {
    const res = await fetch(`/api/polls/${state.slug}/${cardId}`);
    if (res.ok) {
      const { data } = await res.json();
      showPollResults(elemId, options, data.counts);
    }
  } catch { /* silent */ }
}
function showPollResults(elemId, options, counts) {
  const el = document.getElementById(elemId);
  if (!el) return;
  const total = Object.values(counts).reduce((a, b) => a + b, 0) || 1;
  el.innerHTML = options.map((opt, i) => {
    const votes = counts[i] || 0;
    const pct = Math.round((votes / total) * 100);
    return `<div style="margin-bottom:6px;position:relative;background:rgba(255,255,255,0.04);border-radius:8px;overflow:hidden;padding:10px 14px">
      <div style="position:absolute;left:0;top:0;bottom:0;width:${pct}%;background:var(--accent-color,var(--accent));opacity:0.15;border-radius:8px;transition:width 0.5s"></div>
      <div style="position:relative;display:flex;justify-content:space-between;font-size:13px"><span style="color:var(--white)">${opt}</span><span style="color:var(--text2);font-weight:600">${pct}%</span></div>
    </div>`;
  }).join('');
}

function renderFaqCard(card) {
  const pairs = [];
  for (let i = 1; i <= 5; i++) {
    if (card['q'+i]) pairs.push({ q: card['q'+i], a: card['a'+i] || '' });
  }
  const fid = 'faq-' + card.id;
  return `<div class="qr-card">
    <div style="padding:16px 18px">
      ${card.title ? `<div style="font-family:'Syne',sans-serif;font-size:15px;font-weight:700;color:var(--white);margin-bottom:12px">${card.title}</div>` : ''}
      ${pairs.map((p, i) => `<div style="border-bottom:1px solid rgba(255,255,255,0.06)">
        <button onclick="toggleFaqItem('${fid}',${i})" style="width:100%;display:flex;justify-content:space-between;align-items:center;padding:12px 0;background:none;border:none;color:var(--white);font-size:13px;font-weight:500;cursor:pointer;font-family:'Outfit',sans-serif;text-align:left">
          <span>${p.q}</span><span id="${fid}-chev-${i}" style="transition:transform 0.3s;font-size:10px">‚ñº</span>
        </button>
        <div id="${fid}-${i}" style="max-height:0;overflow:hidden;transition:max-height 0.3s ease">
          <div style="padding:0 0 12px;font-size:12px;color:var(--text2);line-height:1.6">${p.a}</div>
        </div>
      </div>`).join('')}
    </div>
  </div>`;
}
function toggleFaqItem(fid, idx) {
  const el = document.getElementById(fid + '-' + idx);
  const chev = document.getElementById(fid + '-chev-' + idx);
  if (!el) return;
  const isOpen = el.style.maxHeight && el.style.maxHeight !== '0px';
  // Close all in this FAQ
  for (let i = 0; i < 5; i++) {
    const other = document.getElementById(fid + '-' + i);
    const otherChev = document.getElementById(fid + '-chev-' + i);
    if (other) { other.style.maxHeight = '0px'; }
    if (otherChev) { otherChev.style.transform = 'rotate(0deg)'; }
  }
  if (!isOpen) {
    el.style.maxHeight = el.scrollHeight + 'px';
    if (chev) chev.style.transform = 'rotate(180deg)';
  }
}

function renderTestimonialCard(card) {
  const stars = '‚òÖ'.repeat(parseInt(card.rating)||5) + '‚òÜ'.repeat(5 - (parseInt(card.rating)||5));
  const initials = (card.authorName||'').split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
  return `<div class="qr-card" style="background:linear-gradient(135deg,rgba(255,255,255,0.04),rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.08)">
    <div style="padding:20px 18px">
      <div style="font-size:36px;color:var(--accent-color,var(--accent));opacity:0.4;line-height:1;margin-bottom:8px">"</div>
      <div style="font-size:14px;color:var(--white);font-style:italic;line-height:1.7;margin-bottom:14px">${card.quote||''}</div>
      <div style="color:#f7c948;font-size:14px;margin-bottom:12px;letter-spacing:2px">${stars}</div>
      <div style="display:flex;align-items:center;gap:10px">
        ${card.authorAvatarUrl ? `<img src="${card.authorAvatarUrl}" style="width:36px;height:36px;border-radius:50%;object-fit:cover">` : `<div style="width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:var(--accent-color,var(--accent))">${initials}</div>`}
        <div><div style="font-size:13px;font-weight:600;color:var(--white)">${card.authorName||''}</div><div style="font-size:11px;color:var(--text3)">${card.authorTitle||''}</div></div>
      </div>
    </div>
  </div>`;
}

function renderProductCard(card) {
  const sym = {ZAR:'R',USD:'$',EUR:'‚Ç¨',GBP:'¬£'}[card.currency] || card.currency || 'R';
  return `<div class="qr-card">
    <div style="padding:16px 18px">
      <div style="display:flex;gap:14px;margin-bottom:14px">
        <div style="position:relative;flex-shrink:0">
          ${card.imageUrl ? `<img src="${card.imageUrl}" style="width:80px;height:80px;border-radius:10px;object-fit:cover">` : `<div style="width:80px;height:80px;border-radius:10px;background:rgba(255,255,255,0.06);display:flex;align-items:center;justify-content:center;font-size:24px">üõçÔ∏è</div>`}
          ${card.badge ? `<div style="position:absolute;top:-4px;right:-4px;background:var(--accent-color,var(--accent));color:#000;font-size:9px;font-weight:700;padding:2px 6px;border-radius:10px">${card.badge}</div>` : ''}
        </div>
        <div style="flex:1;min-width:0">
          <div style="font-weight:600;font-size:14px;color:var(--white);margin-bottom:4px">${card.productName||card.title}</div>
          <div style="font-size:12px;color:var(--text2);margin-bottom:8px;line-height:1.5">${card.description||''}</div>
          <div style="font-size:18px;font-weight:700;color:var(--accent-color,var(--accent))">${sym}${card.price||'0'}</div>
        </div>
      </div>
      <a href="${card.buyUrl||'#'}" target="_blank" style="display:block;text-align:center;padding:10px;background:var(--accent-color,var(--accent));color:#000;font-weight:600;font-size:13px;border-radius:8px;text-decoration:none;font-family:'Outfit',sans-serif">Buy Now</a>
    </div>
  </div>`;
}

function renderBookingCard(card) {
  const isEmbed = card.view === 'embed';
  return `<div class="qr-card">
    <button class="card-expand-btn ${isEmbed?'expanded':''}" onclick="toggleEmbed(this)">
      <div class="card-link-icon" style="background:rgba(59,130,246,0.15);font-size:20px">üìÖ</div>
      <div class="card-expand-label"><div class="card-expand-title">${card.title}</div><div class="card-expand-sub">${card.description||'Book Now ‚Üí'}</div></div>
      <div class="card-expand-chevron"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg></div>
    </button>
    <div class="card-embed-area ${isEmbed?'open':''}">
      ${card.embedUrl ? `<iframe src="${card.embedUrl}" style="width:100%;height:500px;border:none" loading="lazy"></iframe>` : '<div style="padding:24px;text-align:center;color:var(--text3);font-size:13px">Set a booking embed URL</div>'}
    </div>
  </div>`;
}

function renderTipJarCard(card) {
  const emoji = {'Buy Me a Coffee':'‚òï','Ko-fi':'üíõ','PayPal':'üíô','Custom':'üí∞'}[card.platform] || 'üí∞';
  const amounts = (card.suggestedAmounts||'5,10,25').split(',').map(s=>s.trim()).filter(Boolean).slice(0,3);
  const sym = {USD:'$',ZAR:'R',EUR:'‚Ç¨',GBP:'¬£'}[card.currency] || '$';
  return `<div class="qr-card">
    <div style="padding:18px;text-align:center">
      <div style="font-size:32px;margin-bottom:8px">${emoji}</div>
      <div style="font-family:'Syne',sans-serif;font-size:15px;font-weight:700;color:var(--white);margin-bottom:4px">${card.title}</div>
      <div style="font-size:12px;color:var(--text2);margin-bottom:14px">${card.description||''}</div>
      <div style="display:flex;gap:8px;justify-content:center;margin-bottom:14px">
        ${amounts.map(a => `<span style="padding:6px 16px;border-radius:20px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:var(--white);font-size:13px;font-weight:600">${sym}${a}</span>`).join('')}
      </div>
      <a href="${card.paymentUrl||'#'}" target="_blank" style="display:inline-block;padding:10px 24px;background:var(--accent-color,var(--accent));color:#000;font-weight:600;font-size:13px;border-radius:8px;text-decoration:none;font-family:'Outfit',sans-serif">Send Tip ‚Üí</a>
    </div>
  </div>`;
}

function renderInstagramCard(card) {
  const isEmbed = card.view === 'embed';
  return `<div class="qr-card">
    <button class="card-expand-btn ${isEmbed?'expanded':''}" onclick="toggleEmbed(this)">
      <div class="card-link-icon" style="background:rgba(228,64,95,0.15);font-size:20px">üì∏</div>
      <div class="card-expand-label"><div class="card-expand-title">${card.title}</div><div class="card-expand-sub">Instagram Post</div></div>
      <div class="card-expand-chevron"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg></div>
    </button>
    <div class="card-embed-area ${isEmbed?'open':''}">
      <div style="padding:24px;text-align:center">
        <div style="font-size:28px;margin-bottom:8px">üì∏</div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:12px">${card.postUrl||'No URL set'}</div>
        ${card.postUrl ? `<a href="${card.postUrl}" target="_blank" style="font-size:13px;font-weight:600;color:#e4405f;text-decoration:none">Open on Instagram ‚Üí</a>` : ''}
      </div>
    </div>
  </div>`;
}

function renderTweetCard(card) {
  const isEmbed = card.view === 'embed';
  return `<div class="qr-card">
    <button class="card-expand-btn ${isEmbed?'expanded':''}" onclick="toggleEmbed(this)">
      <div class="card-link-icon" style="background:rgba(29,155,240,0.15);font-size:20px">ùïè</div>
      <div class="card-expand-label"><div class="card-expand-title">${card.title}</div><div class="card-expand-sub">Post on X</div></div>
      <div class="card-expand-chevron"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg></div>
    </button>
    <div class="card-embed-area ${isEmbed?'open':''}">
      <div style="padding:24px;text-align:center">
        ${card.tweetUrl ? `<blockquote class="twitter-tweet" data-theme="dark"><a href="${card.tweetUrl}"></a></blockquote>
        <div style="margin-top:8px"><a href="${card.tweetUrl}" target="_blank" style="font-size:13px;font-weight:600;color:#1d9bf0;text-decoration:none">View on X ‚Üí</a></div>` : '<div style="font-size:12px;color:var(--text3)">Set a tweet URL</div>'}
      </div>
    </div>
  </div>`;
}

function renderTiktokCard(card) {
  const isEmbed = card.view === 'embed';
  return `<div class="qr-card">
    <button class="card-expand-btn ${isEmbed?'expanded':''}" onclick="toggleEmbed(this)">
      <div class="card-link-icon" style="background:rgba(255,0,80,0.15);font-size:20px">üéµ</div>
      <div class="card-expand-label"><div class="card-expand-title">${card.title}</div><div class="card-expand-sub">TikTok Video</div></div>
      <div class="card-expand-chevron"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg></div>
    </button>
    <div class="card-embed-area ${isEmbed?'open':''}">
      <div style="padding:24px;text-align:center">
        <div style="font-size:28px;margin-bottom:8px">üéµ</div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:12px">${card.tiktokUrl||'No URL set'}</div>
        ${card.tiktokUrl ? `<a href="${card.tiktokUrl}" target="_blank" style="font-size:13px;font-weight:600;color:#ff0050;text-decoration:none">Watch on TikTok ‚Üí</a>` : ''}
      </div>
    </div>
  </div>`;
}

function renderSpotifyCard(card) {
  let src = card.spotifyUrl || '';
  if (src && !src.includes('/embed/')) src = src.replace('open.spotify.com/', 'open.spotify.com/embed/');
  const h = card.compact ? 152 : 352;
  return `<div class="qr-card" style="padding:0;overflow:hidden">
    ${src ? `<iframe src="${src}?theme=0" height="${h}" style="width:100%;border:none;border-radius:12px" allow="autoplay;clipboard-write;encrypted-media" loading="lazy"></iframe>` : '<div style="padding:24px;text-align:center;color:var(--text3);font-size:13px">Set a Spotify URL</div>'}
  </div>`;
}

// ===================== INTERACTIONS =====================
function toggleEmbed(btn) {
  btn.classList.toggle('expanded');
  const area = btn.nextElementSibling;
  area.classList.toggle('open');
}

function setDevice(mode, btn) {
  document.querySelectorAll('.device-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const frame = document.getElementById('phoneFrame');
  if (mode === 'desktop') {
    frame.classList.add('desktop-view');
  } else {
    frame.classList.remove('desktop-view');
  }
}

function openEditor() {
  document.getElementById('editorPanel').classList.add('mobile-open');
  document.getElementById('mobileOverlay').classList.add('open');
}
function closeEditor() {
  document.getElementById('editorPanel').classList.remove('mobile-open');
  document.getElementById('mobileOverlay').classList.remove('open');
}

// ===================== IMPERSONATION =====================
async function exitImpersonation() {
  try {
    const res = await fetch('/api/admin/impersonate/exit', {
      method: 'POST', credentials: 'same-origin',
    });
    const body = await res.json();
    if (res.ok) {
      window.location.replace('/admin/');
    } else {
      showToast(body.error || 'Failed to exit impersonation', 'error');
    }
  } catch {
    showToast('Network error', 'error');
  }
}

// ===================== BOOT =====================
(async function boot() {
  // Check impersonation status before loading profile
  try {
    const meRes = await fetch('/api/auth/me', { credentials: 'same-origin' });
    if (meRes.ok) {
      const { data } = await meRes.json();
      if (data.impersonatedBy) {
        document.getElementById('impersonated-email').textContent = data.email;
        document.getElementById('impersonation-banner').classList.add('active');
        document.body.classList.add('impersonating');
      }
    }
  } catch { /* non-fatal */ }

  // Read slug from URL query param: /editor.html?slug=desire-realty
  const params = new URLSearchParams(window.location.search);
  const slug = params.get('slug');
  if (slug) {
    loadProfile(slug);
  } else {
    // No slug ‚Äî show empty state, render defaults
    renderThemeGrid();
    renderSocialsEditor();
    renderCardsEditor();
    renderProfile();
    showToast('No profile slug in URL. Add ?slug=your-slug', 'error');
  }
})();
</script>
</body>
</html>
